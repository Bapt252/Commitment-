# ğŸ”” COMMITMENT- ALERTMANAGER CONFIGURATION
# Session A2 - Notifications automatiques

global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'commitment-alerts@gmail.com'
  smtp_auth_username: 'commitment-alerts@gmail.com'
  smtp_auth_password: 'your-app-password'
  smtp_require_tls: true

# ğŸ“¨ TEMPLATES
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# âš¡ ROUTES ET GROUPEMENTS
route:
  group_by: ['alertname', 'severity', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'default-receiver'
  
  routes:
    # ğŸ”¥ ALERTES CRITIQUES - Notification immÃ©diate
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 5m
      
    # âš ï¸ ALERTES WARNING - Notification diffÃ©rÃ©e
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 2m
      repeat_interval: 30m
      
    # ğŸš€ SERVICES CRITIQUES - Canal dÃ©diÃ©
    - match_re:
        service: (cv-parser|personalization|matching|frontend)
      receiver: 'critical-services'
      group_wait: 15s
      repeat_interval: 10m

# ğŸ“¢ RECEIVERS - Canaux de notification
receivers:
  # ğŸ“§ DEFAULT - Notifications basiques
  - name: 'default-receiver'
    email_configs:
      - to: 'admin@commitment.com'
        subject: '[COMMITMENT] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          ğŸš¨ **ALERT COMMITMENT-**
          
          **Statut:** {{ .Status | toUpper }}
          **Nombre d'alertes:** {{ len .Alerts }}
          
          {{ range .Alerts }}
          ---
          **Service:** {{ .Labels.service }}
          **Alerte:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **DÃ©clenchÃ©e:** {{ .StartsAt }}
          {{ end }}
          
          ğŸ”— [Grafana Dashboard](http://localhost:3001)
          ğŸ”— [Prometheus](http://localhost:9090)

  # ğŸ”¥ CRITIQUE - Multi-canal + escalation
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@commitment.com,devops@commitment.com'
        subject: 'ğŸ”¥ [CRITICAL] {{ .GroupLabels.alertname }} - ACTION REQUIRED'
        body: |
          âš ï¸ **ALERTE CRITIQUE COMMITMENT-**
          
          ğŸš¨ **INTERVENTION IMMÃ‰DIATE REQUISE**
          
          {{ range .Alerts }}
          **ğŸ¯ Service:** {{ .Labels.service }}
          **ğŸ”¥ ProblÃ¨me:** {{ .Annotations.summary }}
          **ğŸ“‹ DÃ©tails:** {{ .Annotations.description }}
          **â° DÃ©clenchÃ©e:** {{ .StartsAt }}
          {{ end }}
          
          **Actions Ã  prendre:**
          1. VÃ©rifier les dashboards Grafana
          2. Consulter les logs des services
          3. RedÃ©marrer si nÃ©cessaire
          
          ğŸ”— [Dashboard SystÃ¨me](http://localhost:3001/d/system)
          ğŸ”— [Logs Services](http://localhost:3001/d/logs)
        headers:
          Priority: 'urgent'

  # âš ï¸ WARNING - Notifications groupÃ©es
  - name: 'warning-alerts'
    email_configs:
      - to: 'admin@commitment.com'
        subject: 'âš ï¸ [WARNING] {{ .GroupLabels.alertname }}'
        body: |
          âš ï¸ **ALERTE WARNING COMMITMENT-**
          
          {{ range .Alerts }}
          **Service:** {{ .Labels.service }}
          **ProblÃ¨me:** {{ .Annotations.summary }}
          **DÃ©tails:** {{ .Annotations.description }}
          **Depuis:** {{ .StartsAt }}
          {{ end }}
          
          ğŸ“Š Surveillance recommandÃ©e
          ğŸ”— [Grafana](http://localhost:3001)

  # ğŸš€ SERVICES CRITIQUES - Canal spÃ©cialisÃ©
  - name: 'critical-services'
    email_configs:
      - to: 'admin@commitment.com,backend-team@commitment.com'
        subject: 'ğŸš€ [SERVICE CRITICAL] {{ .GroupLabels.service }} - {{ .GroupLabels.alertname }}'
        body: |
          ğŸš€ **SERVICE CRITIQUE IMPACTÃ‰**
          
          **âš¡ Service:** {{ .GroupLabels.service }}
          **ğŸ“Š Performances Session A1:**
          - CV Parser: 1.9ms latence âœ…
          - Personalization: 1.8ms latence âœ…
          - Frontend: 53ms âœ…
          
          {{ range .Alerts }}
          **ğŸ”´ ProblÃ¨me actuel:** {{ .Annotations.summary }}
          **ğŸ“‹ DÃ©tails:** {{ .Annotations.description }}
          **â° Heure:** {{ .StartsAt }}
          {{ end }}
          
          **ğŸ› ï¸ Actions prioritaires:**
          1. VÃ©rifier le service {{ .GroupLabels.service }}
          2. Consulter les mÃ©triques de performance
          3. Comparer avec les benchmarks Session A1
          
          ğŸ”— [Dashboard {{ .GroupLabels.service }}](http://localhost:3001/d/{{ .GroupLabels.service }})

# ğŸš« INHIBIT RULES - Ã‰viter le spam
inhibit_rules:
  # Si un service est down, pas besoin d'alerter sur sa latence
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'HighLatency'
    equal: ['service']
    
  # Si le systÃ¨me a peu de RAM, les services peuvent Ãªtre lents
  - source_match:
      alertname: 'HighMemoryUsage'
    target_match_re:
      alertname: '.*HighLatency'
    equal: ['instance']