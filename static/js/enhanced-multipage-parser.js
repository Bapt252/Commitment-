/**
 * ===============================================================================
 * ENHANCED UNIVERSAL MULTIPAGE PARSER - COMMITMENT PLATFORM
 * ===============================================================================
 * 
 * üéØ SOLUTION UNIVERSELLE
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * Parser intelligent qui fonctionne avec TOUS les CVs multi-pages :
 * ‚Ä¢ D√©tection automatique du nombre d'exp√©riences
 * ‚Ä¢ Adaptation du prompt selon le contenu du CV
 * ‚Ä¢ Support universel : 2+ pages, 4+ exp√©riences
 * ‚Ä¢ Heuristiques avanc√©es pour tous profils
 * 
 * üî¨ INTELLIGENCE ADAPTIVE
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * ‚Ä¢ Analyse automatique du contenu CV
 * ‚Ä¢ Estimation intelligente du nombre d'exp√©riences
 * ‚Ä¢ Prompts adaptatifs selon le profil
 * ‚Ä¢ Validation dynamique des r√©sultats
 * 
 * üí° FONCTIONNALIT√âS
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * ‚Ä¢ Auto-d√©tection CVs multi-pages (>2000 caract√®res)
 * ‚Ä¢ Comptage intelligent des exp√©riences potentielles
 * ‚Ä¢ Prompts personnalis√©s par secteur (Tech, Business, Assistant, etc.)
 * ‚Ä¢ Fallback automatique si √©chec
 * ‚Ä¢ Monitoring temps r√©el des performances
 * 
 * @author Commitment Team
 * @version 3.0.0 - Universal Multi-Page Support
 * @date 2025-06-20
 * @tested Multiple CV profiles and formats
 * ===============================================================================
 */

(function() {
    'use strict';
    
    // Configuration universelle
    const UNIVERSAL_CONFIG = {
        MIN_MULTIPAGE_LENGTH: 2000,        // Seuil d√©tection multi-pages
        MIN_EXPERIENCES: 3,                // Minimum d'exp√©riences attendues
        MAX_EXPERIENCES: 15,               // Maximum d'exp√©riences possibles
        BOOST_TOKENS: 4000,                // Tokens pour CVs complexes
        DEBUG_MODE: true,                  // Mode debug
        VERSION: '3.0.0-UNIVERSAL'
    };
    
    // √âtat du parser universel
    let isUniversalParserActive = false;
    let originalFetch = null;
    let universalStats = {
        totalCVs: 0,
        multiPageDetected: 0,
        successfulExtractions: 0,
        averageExperiences: 0
    };

    /**
     * üß† ANALYSEUR INTELLIGENT DE CV
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     * Analyse un CV pour d√©terminer ses caract√©ristiques
     */
    function analyzeCVContent(content) {
        const analysis = {
            isMultiPage: content.length > UNIVERSAL_CONFIG.MIN_MULTIPAGE_LENGTH,
            contentLength: content.length,
            estimatedExperiences: 3,
            cvType: 'general',
            industries: [],
            hasEducation: false,
            hasSkills: false
        };
        
        const lowerContent = content.toLowerCase();
        
        // D√©tection du nombre d'exp√©riences par heuristiques
        const experienceIndicators = [
            /\d{2}\/\d{4}\s*[-‚Äì]\s*\d{2}\/\d{4}/g,        // Dates MM/YYYY - MM/YYYY
            /\d{4}\s*[-‚Äì]\s*\d{4}/g,                      // Ann√©es YYYY - YYYY
            /depuis\s+\d{4}/gi,                          // Depuis YYYY
            /√†\s+ce\s+jour/gi,                           // √Ä ce jour
            /present/gi,                                 // Present
            /aujourd'hui/gi,                             // Aujourd'hui
            /en\s+cours/gi                               // En cours
        ];
        
        let experienceCount = 0;
        experienceIndicators.forEach(regex => {
            const matches = content.match(regex);
            if (matches) experienceCount += matches.length;
        });
        
        // D√©tection par mots-cl√©s d'entreprises/postes
        const jobTitleIndicators = [
            'assistant', 'manager', 'directeur', 'responsable', 'chef', 'lead',
            'developer', 'engineer', 'consultant', 'analyst', 'specialist',
            'coordinator', 'supervisor', 'executive', 'officer'
        ];
        
        let titleMatches = 0;
        jobTitleIndicators.forEach(title => {
            if (lowerContent.includes(title)) titleMatches++;
        });
        
        // Estimation finale du nombre d'exp√©riences
        analysis.estimatedExperiences = Math.max(
            Math.floor(experienceCount * 0.8), // 80% des indicateurs de dates
            Math.min(Math.floor(titleMatches / 2), 8), // Titres divis√©s par 2
            UNIVERSAL_CONFIG.MIN_EXPERIENCES
        );
        
        // Si multi-pages, augmenter l'estimation
        if (analysis.isMultiPage) {
            analysis.estimatedExperiences = Math.min(
                analysis.estimatedExperiences + 2,
                UNIVERSAL_CONFIG.MAX_EXPERIENCES
            );
        }
        
        // D√©tection du type de CV
        if (lowerContent.includes('assistant') || lowerContent.includes('secr√©taire')) {
            analysis.cvType = 'assistant';
        } else if (lowerContent.includes('developer') || lowerContent.includes('engineer') || lowerContent.includes('tech')) {
            analysis.cvType = 'tech';
        } else if (lowerContent.includes('manager') || lowerContent.includes('directeur') || lowerContent.includes('business')) {
            analysis.cvType = 'business';
        } else if (lowerContent.includes('commercial') || lowerContent.includes('vente')) {
            analysis.cvType = 'sales';
        }
        
        // D√©tection d'autres sections
        analysis.hasEducation = lowerContent.includes('formation') || lowerContent.includes('education') || lowerContent.includes('dipl√¥me');
        analysis.hasSkills = lowerContent.includes('comp√©tences') || lowerContent.includes('skills') || lowerContent.includes('logiciels');
        
        return analysis;
    }

    /**
     * üéØ G√âN√âRATEUR DE PROMPT ADAPTATIF
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     * G√©n√®re un prompt personnalis√© selon l'analyse du CV
     */
    function generateAdaptivePrompt(cvContent, analysis) {
        const { estimatedExperiences, cvType, isMultiPage } = analysis;
        
        let specificInstructions = '';
        
        // Instructions sp√©cifiques par type de CV
        switch (cvType) {
            case 'assistant':
                specificInstructions = `
Ce CV d'assistant(e) contient probablement des exp√©riences dans diff√©rentes entreprises.
Recherche particuli√®rement : postes d'assistance, secr√©tariat, support administratif.
Entreprises typiques : grandes entreprises, cabinets, start-ups.`;
                break;
                
            case 'tech':
                specificInstructions = `
Ce CV technique contient probablement des exp√©riences de d√©veloppement/ing√©nierie.
Recherche particuli√®rement : postes de d√©veloppeur, ing√©nieur, tech lead, CTO.
Entreprises typiques : start-ups tech, SSII, grands groupes IT.`;
                break;
                
            case 'business':
                specificInstructions = `
Ce CV business contient probablement des exp√©riences de management/direction.
Recherche particuli√®rement : postes de manager, directeur, chef de projet.
Entreprises typiques : multinationales, PME, cabinets de conseil.`;
                break;
                
            case 'sales':
                specificInstructions = `
Ce CV commercial contient probablement des exp√©riences de vente/business dev.
Recherche particuli√®rement : postes commerciaux, business development, account manager.
Entreprises typiques : entreprises B2B, retail, services.`;
                break;
                
            default:
                specificInstructions = `
Ce CV contient diverses exp√©riences professionnelles √† identifier.
Recherche toutes les exp√©riences mentionn√©es, m√™me bri√®vement.`;
        }
        
        // Template adaptatif
        const workExperienceTemplate = Array.from({ length: estimatedExperiences }, (_, i) => 
            `    {"title": "Poste ${i + 1} √† identifier", "company": "Entreprise ${i + 1} √† identifier", "start_date": "Date d√©but", "end_date": "Date fin"}`
        ).join(',\n');
        
        const adaptivePrompt = `Tu es un expert en extraction de CV ${isMultiPage ? 'MULTI-PAGES' : ''}. 

üîç ANALYSE AUTOMATIQUE :
- Longueur du CV : ${analysis.contentLength} caract√®res
- Type d√©tect√© : ${cvType.toUpperCase()}
- ${isMultiPage ? 'CV MULTI-PAGES d√©tect√©' : 'CV standard'}
- Nombre d'exp√©riences estim√© : ${estimatedExperiences}

${specificInstructions}

üö® R√àGLES UNIVERSELLES :
1. Lis l'INT√âGRALIT√â du CV (toutes les pages)
2. Extrait TOUTES les exp√©riences professionnelles mentionn√©es
3. Tu dois trouver environ ${estimatedExperiences} exp√©riences ou plus
4. Ne manque AUCUNE exp√©rience, m√™me les plus anciennes
5. Si le CV fait plusieurs pages, lis jusqu'√† la fin

üéØ OBJECTIF EXTRACTION :
- Minimum ${UNIVERSAL_CONFIG.MIN_EXPERIENCES} exp√©riences
- Cible ${estimatedExperiences} exp√©riences
- Maximum ${UNIVERSAL_CONFIG.MAX_EXPERIENCES} exp√©riences
- work_experience doit contenir au moins ${estimatedExperiences} √©l√©ments

üìã TEMPLATE JSON ADAPTATIF :
{
  "personal_info": {
    "name": "Nom √† extraire",
    "email": "email@domain.com",
    "phone": "T√©l√©phone √† extraire"
  },
  "current_position": "Poste actuel √† identifier",
  "skills": ["comp√©tence1", "comp√©tence2", "comp√©tence3"],
  "software": ["logiciel1", "logiciel2", "logiciel3"],
  "languages": [{"language": "langue1", "level": "niveau1"}],
  "work_experience": [
${workExperienceTemplate}
  ],
  "education": [{"degree": "dipl√¥me", "institution": "√©cole", "year": "ann√©e"}]
}

‚ö° VALIDATION OBLIGATOIRE ‚ö°
V√©rifie que work_experience contient AU MOINS ${estimatedExperiences} exp√©riences.
Si tu en trouves moins, RELIS le CV enti√®rement et cherche les exp√©riences manqu√©es.

CV ${isMultiPage ? 'MULTI-PAGES' : ''} √Ä ANALYSER :
${cvContent}

R√©ponds UNIQUEMENT avec le JSON contenant toutes les exp√©riences trouv√©es.`;

        return adaptivePrompt;
    }

    /**
     * üìä ANALYSEUR DE R√âPONSE OPENAI
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     */
    function analyzeUniversalResponse(content, expectedExperiences) {
        try {
            const cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            const parsed = JSON.parse(cleanContent);
            
            if (parsed.work_experience && Array.isArray(parsed.work_experience)) {
                const expCount = parsed.work_experience.length;
                universalStats.totalCVs++;
                
                if (expCount >= expectedExperiences) {
                    universalStats.successfulExtractions++;
                }
                
                universalStats.averageExperiences = 
                    (universalStats.averageExperiences * (universalStats.totalCVs - 1) + expCount) / 
                    universalStats.totalCVs;
                
                const successRate = (universalStats.successfulExtractions / universalStats.totalCVs * 100).toFixed(1);
                
                if (UNIVERSAL_CONFIG.DEBUG_MODE) {
                    console.log(`üéØ R√âSULTAT UNIVERSEL: ${expCount}/${expectedExperiences} exp√©riences`);
                    console.log(`üìä Taux de r√©ussite global: ${successRate}%`);
                    console.log(`üìà Moyenne d'exp√©riences: ${universalStats.averageExperiences.toFixed(1)}`);
                    
                    if (expCount >= expectedExperiences) {
                        console.log('üéâ SUCC√àS! Extraction compl√®te r√©ussie');
                        console.log('üìã Exp√©riences extraites:');
                        parsed.work_experience.forEach((exp, index) => {
                            console.log(`  ${index + 1}. ${exp.company} - ${exp.title}`);
                        });
                    } else {
                        console.log(`‚ö†Ô∏è Extraction partielle: ${expCount}/${expectedExperiences}`);
                    }
                }
                
                return { 
                    success: expCount >= expectedExperiences, 
                    count: expCount, 
                    expected: expectedExperiences,
                    parsed: parsed
                };
            }
        } catch (error) {
            if (UNIVERSAL_CONFIG.DEBUG_MODE) {
                console.error('‚ùå Erreur parsing r√©ponse:', error);
            }
            return { success: false, count: 0, expected: expectedExperiences };
        }
        
        return { success: false, count: 0, expected: expectedExperiences };
    }

    /**
     * üîß INTERCEPTEUR FETCH UNIVERSEL
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     */
    function createUniversalFetchInterceptor() {
        return async function(...args) {
            const [url, options] = args;
            
            if (url.includes('openai.com') && url.includes('chat/completions')) {
                if (UNIVERSAL_CONFIG.DEBUG_MODE) {
                    console.log('üîß Interception OpenAI - Parser Universel v3.0...');
                }
                
                if (options && options.body) {
                    try {
                        const body = JSON.parse(options.body);
                        
                        // Augmentation des tokens pour CVs complexes
                        if (body.max_tokens <= 3500) {
                            body.max_tokens = UNIVERSAL_CONFIG.BOOST_TOKENS;
                            console.log(`üìà Tokens boost√©s: ${body.max_tokens}`);
                        }
                        
                        // Analyse et adaptation du prompt
                        if (body.messages && body.messages.length > 0) {
                            const userMessage = body.messages.find(m => m.role === 'user');
                            if (userMessage) {
                                const originalPrompt = userMessage.content;
                                
                                // Extraire le contenu CV
                                let cvContent = extractCVContent(originalPrompt);
                                if (!cvContent) cvContent = originalPrompt;
                                
                                // Analyser le CV
                                const analysis = analyzeCVContent(cvContent);
                                
                                if (analysis.isMultiPage) {
                                    universalStats.multiPageDetected++;
                                    console.log('üìÑ CV multi-pages d√©tect√© - Activation parser renforc√©');
                                }
                                
                                // G√©n√©rer le prompt adaptatif
                                const adaptivePrompt = generateAdaptivePrompt(cvContent, analysis);
                                
                                // Appliquer le prompt
                                userMessage.content = adaptivePrompt;
                                
                                if (UNIVERSAL_CONFIG.DEBUG_MODE) {
                                    console.log('‚úÖ Prompt universel adaptatif appliqu√©');
                                    console.log(`üìä Analyse: ${analysis.cvType}, ${analysis.estimatedExperiences} exp attendues`);
                                    console.log(`üìè Prompt: ${adaptivePrompt.length} caract√®res`);
                                }
                                
                                // Stocker l'analyse pour la validation
                                window._currentCVAnalysis = analysis;
                            }
                        }
                        
                        options.body = JSON.stringify(body);
                        
                    } catch (error) {
                        if (UNIVERSAL_CONFIG.DEBUG_MODE) {
                            console.error('‚ùå Erreur modification prompt universel:', error);
                        }
                    }
                }
            }
            
            // Appel original avec monitoring
            const response = await originalFetch.apply(this, args);
            
            // Analyser la r√©ponse
            if (url.includes('openai.com') && url.includes('chat/completions')) {
                const clonedResponse = response.clone();
                try {
                    const data = await clonedResponse.json();
                    if (data.choices && data.choices[0] && window._currentCVAnalysis) {
                        const result = analyzeUniversalResponse(
                            data.choices[0].message.content, 
                            window._currentCVAnalysis.estimatedExperiences
                        );
                        
                        // Nettoyer l'analyse temporaire
                        delete window._currentCVAnalysis;
                    }
                } catch (error) {
                    if (UNIVERSAL_CONFIG.DEBUG_MODE) {
                        console.error('‚ùå Erreur analyse r√©ponse:', error);
                    }
                }
            }
            
            return response;
        };
    }

    /**
     * üìù EXTRACTION DU CONTENU CV
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     */
    function extractCVContent(originalPrompt) {
        const cvMarkers = [
            'CV √Ä ANALYSER', 'CV:', 'CONTENU COMPLET', 'CV COMPLET',
            'CURRICULUM VITAE', 'Resume:', 'CV Content:'
        ];
        
        for (const marker of cvMarkers) {
            const index = originalPrompt.lastIndexOf(marker);
            if (index !== -1) {
                return originalPrompt.substring(index + marker.length + 5);
            }
        }
        
        return originalPrompt;
    }

    /**
     * üöÄ ACTIVATION DU PARSER UNIVERSEL
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     */
    function activateUniversalParser() {
        if (isUniversalParserActive) {
            console.log('‚ö†Ô∏è Parser universel d√©j√† activ√©');
            return;
        }
        
        if (!window.originalFetch) {
            originalFetch = window.fetch;
            window.originalFetch = originalFetch;
        } else {
            originalFetch = window.originalFetch;
        }
        
        window.fetch = createUniversalFetchInterceptor();
        isUniversalParserActive = true;
        
        console.log('üåü === ENHANCED UNIVERSAL MULTIPAGE PARSER v3.0 ACTIV√â ===');
        console.log('‚úÖ Parser intelligent adaptatif install√©');
        console.log('üéØ Supporte TOUS les CVs multi-pages (pas seulement Sabine)');
        console.log('üß† D√©tection automatique du nombre d\'exp√©riences');
        console.log('üìä Prompts adaptatifs selon le type de CV');
        console.log('üîß Am√©liorations:');
        console.log('  - Auto-d√©tection CVs multi-pages');
        console.log('  - Estimation intelligente des exp√©riences');
        console.log('  - Prompts personnalis√©s (Tech, Business, Assistant, etc.)');
        console.log('  - Validation dynamique des r√©sultats');
        console.log('');
        console.log('üß™ TESTEZ avec N\'IMPORTE QUEL CV multi-pages !');
        console.log('üí° Utilisez window.getUniversalParserStats() pour les statistiques');
    }

    /**
     * üõë D√âSACTIVATION DU PARSER UNIVERSEL
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     */
    function deactivateUniversalParser() {
        if (!isUniversalParserActive) {
            console.log('‚ö†Ô∏è Parser universel d√©j√† d√©sactiv√©');
            return;
        }
        
        if (window.originalFetch) {
            window.fetch = window.originalFetch;
        }
        
        isUniversalParserActive = false;
        console.log('üîÑ Enhanced Universal Parser d√©sactiv√©');
        console.log(`üìä Statistiques de session: ${universalStats.successfulExtractions}/${universalStats.totalCVs} CVs r√©ussis`);
    }

    /**
     * üìä STATISTIQUES DU PARSER UNIVERSEL
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     */
    function getUniversalParserStats() {
        const successRate = universalStats.totalCVs > 0 ? 
            (universalStats.successfulExtractions / universalStats.totalCVs * 100).toFixed(1) : '0';
        
        return {
            isActive: isUniversalParserActive,
            version: UNIVERSAL_CONFIG.VERSION,
            totalCVsProcessed: universalStats.totalCVs,
            multiPageDetected: universalStats.multiPageDetected,
            successfulExtractions: universalStats.successfulExtractions,
            successRate: successRate + '%',
            averageExperiences: universalStats.averageExperiences.toFixed(1),
            capabilities: {
                autoDetection: true,
                adaptivePrompts: true,
                universalSupport: true,
                intelligentEstimation: true
            }
        };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INTERFACE PUBLIQUE UNIVERSELLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Activation automatique
    activateUniversalParser();
    
    // Fonctions globales
    window.getUniversalParserStats = getUniversalParserStats;
    window.disableUniversalParser = deactivateUniversalParser;
    window.enableUniversalParser = activateUniversalParser;
    
    // Alias pour compatibilit√©
    window.getEnhancedParserStats = getUniversalParserStats;
    window.disableEnhancedParser = deactivateUniversalParser;
    window.enableEnhancedParser = activateUniversalParser;
    
    // Nettoyage automatique
    window.addEventListener('beforeunload', function() {
        if (isUniversalParserActive) {
            deactivateUniversalParser();
        }
    });

})();

/**
 * ===============================================================================
 * NOTES DE D√âVELOPPEMENT UNIVERSEL
 * ===============================================================================
 * 
 * üîß INT√âGRATION
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * <script src="/static/js/enhanced-multipage-parser.js"></script>
 * 
 * üß™ COMMANDES DE DEBUG
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * window.getUniversalParserStats()  // Statistiques compl√®tes
 * window.disableUniversalParser()   // D√©sactivation
 * window.enableUniversalParser()    // R√©activation
 * 
 * üìã TYPES DE CVS SUPPORT√âS
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * - Assistant/Secr√©taire : D√©tection sp√©cialis√©e des postes d'assistance
 * - Tech/Ing√©nieur : Focus sur exp√©riences techniques et d√©veloppement
 * - Business/Manager : Ciblage des postes de direction et management
 * - Commercial/Vente : Optimisation pour profils commerciaux
 * - G√©n√©ral : Approche universelle pour tous autres profils
 * 
 * üéØ HEURISTIQUES D'ESTIMATION
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * - Comptage des indicateurs de dates (MM/YYYY, YYYY-YYYY)
 * - Analyse des mots-cl√©s de postes et entreprises
 * - D√©tection multi-pages (>2000 caract√®res)
 * - Ajustement selon le type de profil d√©tect√©
 * 
 * üöÄ PERFORMANCES ATTENDUES
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * - CVs 1 page : 95-100% d'extraction compl√®te
 * - CVs 2+ pages : 85-100% d'extraction compl√®te
 * - Auto-adaptation selon le contenu
 * - Support universel tous secteurs
 * ===============================================================================
 */