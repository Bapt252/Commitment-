/**
 * Gestionnaire du processus de recrutement personnalis√©
 * Permet de personnaliser le flux de recrutement avec les fonctionnalit√©s suivantes :
 * - Ajout/suppression d'√©tapes
 * - √âdition du titre et de la description des √©tapes
 * - Ajout/gestion de participants
 * - Sauvegarde et chargement des mod√®les de processus
 * - Modification du statut des √©tapes
 */

document.addEventListener('DOMContentLoaded', function() {
    // Initialisation des variables
    const flowContainer = document.querySelector('.flow-container');
    const addStepBtn = document.querySelector('.add-step-btn');
    const processFlowSection = document.querySelector('.process-flow');
    
    // Templates pour les diff√©rentes √©tapes pr√©d√©finies
    const stepTemplates = {
        'entretien_telephonique': {
            title: 'Entretien t√©l√©phonique',
            description: 'Premier contact de 15-20 minutes pour √©valuer l\'ad√©quation',
            icon: 'fa-phone-alt'
        },
        'test_technique': {
            title: 'Test technique',
            description: '√âvaluation des comp√©tences techniques sp√©cifiques au poste',
            icon: 'fa-code'
        },
        'entretien_video': {
            title: 'Entretien vid√©o',
            description: 'Discussion approfondie sur les comp√©tences et l\'exp√©rience',
            icon: 'fa-video'
        },
        'entretien_equipe': {
            title: 'Rencontre avec l\'√©quipe',
            description: 'Pr√©sentation √† l\'√©quipe et √©valuation de la dynamique de groupe',
            icon: 'fa-users'
        },
        'assessment': {
            title: 'Assessment Center',
            description: 'S√©rie d\'exercices pratiques pour √©valuer les comp√©tences',
            icon: 'fa-tasks'
        },
        'negociation': {
            title: 'N√©gociation',
            description: 'Discussion des conditions contractuelles et de la r√©mun√©ration',
            icon: 'fa-handshake'
        }
    };
    
    // √âtat des participants
    let participants = {
        // ID √©tape: [array de participants]
    };
    
    // ID unique pour les √©tapes
    let currentStepId = 6; // On commence √† 6 car il y a d√©j√† 5 √©tapes par d√©faut
    
    /**
     * Initialise les fonctionnalit√©s du processus de recrutement
     */
    function initRecruitmentProcess() {
        // Ajouter un ID √† chaque √©tape existante pour les actions ult√©rieures
        let existingSteps = document.querySelectorAll('.flow-step');
        existingSteps.forEach((step, index) => {
            step.setAttribute('data-step-id', index + 1);
            
            // Initialiser les participants pour les √©tapes existantes
            participants[index + 1] = [];
            
            // Ajouter les gestionnaires d'√©v√©nements aux boutons existants
            addEventListenersToStepActions(step);
        });
        
        // Gestionnaire du bouton d'ajout d'√©tape
        addStepBtn.addEventListener('click', addNewStep);
        
        // Ajouter le bouton d'enregistrement du mod√®le
        addSaveTemplateButton();
        
        // Ajouter le menu d√©roulant des mod√®les pr√©d√©finis
        addPredefinedTemplatesDropdown();
    }
    
    /**
     * Ajoute une nouvelle √©tape au processus
     * @param {Object} template - Template optionnel pour l'√©tape
     */
    function addNewStep(event, template = null) {
        const steps = document.querySelectorAll('.flow-step');
        const newStepNumber = steps.length + 1;
        currentStepId++;
        
        // Cr√©er le titre et la description en fonction du template ou utiliser des valeurs par d√©faut
        let title = 'Nouvelle √©tape';
        let description = 'Description de cette √©tape';
        let icon = 'fa-clipboard-check';
        
        if (template) {
            title = template.title;
            description = template.description;
            icon = template.icon || icon;
        }
        
        // Cr√©er un nouvel √©l√©ment d'√©tape
        const newStep = document.createElement('div');
        newStep.className = 'flow-step';
        newStep.setAttribute('data-step-id', currentStepId);
        
        newStep.innerHTML = `
            <div class="flow-step-icon">${newStepNumber}</div>
            <div class="flow-step-content">
                <div class="flow-step-title">
                    <span class="step-title-text">${title}</span>
                    <span class="tooltip" data-tooltip="√âditer cette √©tape">
                        <i class="fas fa-info-circle edit-step-btn"></i>
                    </span>
                </div>
                <p class="flow-step-description">${description}</p>
                <div class="flow-step-actions">
                    <button type="button" class="flow-action-btn btn-danger delete-step-btn">
                        <i class="fas fa-times"></i> Supprimer
                    </button>
                    <button type="button" class="flow-action-btn add-participant-btn">
                        <i class="fas fa-user-plus"></i> Ajouter un participant
                    </button>
                    <button type="button" class="flow-action-btn change-status-btn">
                        <i class="fas fa-exchange-alt"></i> Statut
                    </button>
                </div>
                <div class="participants-container" style="display: none;"></div>
            </div>
        `;
        
        // Cr√©er un connecteur pour la connexion
        const connector = document.createElement('div');
        connector.className = 'flow-connector';
        connector.innerHTML = '<div class="flow-connector-line"></div>';
        
        // Ins√©rer l'√©tape et le connecteur avant le bouton d'ajout
        flowContainer.insertBefore(connector, addStepBtn);
        flowContainer.insertBefore(newStep, connector);
        
        // Initialiser les participants pour cette √©tape
        participants[currentStepId] = [];
        
        // Ajouter les gestionnaires d'√©v√©nements aux boutons
        addEventListenersToStepActions(newStep);
        
        // Mettre √† jour les num√©ros de toutes les √©tapes
        updateStepNumbers();
        
        // Afficher une notification
        showNotification('√âtape ajout√©e avec succ√®s');
    }
    
    /**
     * Ajoute tous les gestionnaires d'√©v√©nements n√©cessaires √† une √©tape
     * @param {HTMLElement} step - L'√©l√©ment d'√©tape
     */
    function addEventListenersToStepActions(step) {
        // Gestionnaire de suppression d'√©tape
        const deleteBtn = step.querySelector('.delete-step-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                deleteStep(step);
            });
        }
        
        // Gestionnaire d'ajout de participant
        const addParticipantBtn = step.querySelector('.add-participant-btn');
        if (addParticipantBtn) {
            addParticipantBtn.addEventListener('click', function() {
                addParticipant(step);
            });
        }
        
        // Gestionnaire d'√©dition d'√©tape
        const editBtn = step.querySelector('.edit-step-btn');
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                editStep(step);
            });
        }
        
        // Gestionnaire de changement de statut
        const statusBtn = step.querySelector('.change-status-btn');
        if (statusBtn) {
            statusBtn.addEventListener('click', function() {
                changeStepStatus(step);
            });
        }
    }
    
    /**
     * Supprime une √©tape du processus
     * @param {HTMLElement} step - L'√©tape √† supprimer
     */
    function deleteStep(step) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette √©tape ?')) {
            const stepId = step.getAttribute('data-step-id');
            
            // Supprimer l'√©tape du DOM
            const connector = step.nextElementSibling;
            if (connector && connector.classList.contains('flow-connector')) {
                flowContainer.removeChild(connector);
            }
            flowContainer.removeChild(step);
            
            // Supprimer les participants de cette √©tape
            delete participants[stepId];
            
            // Mettre √† jour les num√©ros des √©tapes
            updateStepNumbers();
            
            // Afficher une notification
            showNotification('√âtape supprim√©e avec succ√®s');
        }
    }
    
    /**
     * Met √† jour les num√©ros d'√©tapes apr√®s un ajout ou une suppression
     */
    function updateStepNumbers() {
        const steps = document.querySelectorAll('.flow-step');
        steps.forEach((step, index) => {
            const stepIcon = step.querySelector('.flow-step-icon');
            if (stepIcon) {
                stepIcon.textContent = index + 1;
            }
        });
    }
    
    /**
     * Ouvre une modal pour √©diter une √©tape
     * @param {HTMLElement} step - L'√©tape √† √©diter
     */
    function editStep(step) {
        const stepId = step.getAttribute('data-step-id');
        const titleElement = step.querySelector('.step-title-text');
        const descriptionElement = step.querySelector('.flow-step-description');
        
        const currentTitle = titleElement.textContent;
        const currentDescription = descriptionElement.textContent;
        
        // Cr√©er une modal d'√©dition
        const modal = document.createElement('div');
        modal.className = 'edit-step-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="modal-content" style="background-color: white; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
                <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    √âditer l'√©tape
                    <button class="close-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </h3>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="step-title" style="display: block; margin-bottom: 5px; font-weight: 500;">Titre de l'√©tape</label>
                    <input type="text" id="step-title" class="form-control" value="${currentTitle}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="step-description" style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                    <textarea id="step-description" class="form-control" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${currentDescription}</textarea>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="step-icon" style="display: block; margin-bottom: 5px; font-weight: 500;">Ic√¥ne (optionnel)</label>
                    <select id="step-icon" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="fa-clipboard-check">‚úì Liste de contr√¥le</option>
                        <option value="fa-phone-alt">üìû T√©l√©phone</option>
                        <option value="fa-video">üìπ Vid√©o</option>
                        <option value="fa-users">üë• √âquipe</option>
                        <option value="fa-code">üíª Code</option>
                        <option value="fa-tasks">üìã T√¢ches</option>
                        <option value="fa-handshake">ü§ù N√©gociation</option>
                        <option value="fa-check-circle">‚úÖ Validation</option>
                        <option value="fa-user-plus">üë§ Recrutement</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="cancel-btn" style="padding: 10px 15px; border: 1px solid #ddd; background-color: white; border-radius: 5px; cursor: pointer;">Annuler</button>
                    <button class="save-btn" style="padding: 10px 15px; border: none; background-color: #7c3aed; color: white; border-radius: 5px; cursor: pointer;">Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Gestionnaires d'√©v√©nements de la modal
        const closeBtn = modal.querySelector('.close-modal');
        const cancelBtn = modal.querySelector('.cancel-btn');
        const saveBtn = modal.querySelector('.save-btn');
        
        function closeModal() {
            document.body.removeChild(modal);
        }
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        saveBtn.addEventListener('click', function() {
            const newTitle = modal.querySelector('#step-title').value.trim();
            const newDescription = modal.querySelector('#step-description').value.trim();
            const newIcon = modal.querySelector('#step-icon').value;
            
            if (newTitle && newDescription) {
                // Mettre √† jour les valeurs
                titleElement.textContent = newTitle;
                descriptionElement.textContent = newDescription;
                
                // Afficher une notification
                showNotification('√âtape mise √† jour avec succ√®s');
                
                closeModal();
            } else {
                alert('Veuillez remplir tous les champs obligatoires.');
            }
        });
    }
    
    /**
     * Ajoute un participant √† une √©tape
     * @param {HTMLElement} step - L'√©tape concern√©e
     */
    function addParticipant(step) {
        const stepId = step.getAttribute('data-step-id');
        const participantsContainer = step.querySelector('.participants-container');
        
        // Cr√©er une modal pour ajouter un participant
        const modal = document.createElement('div');
        modal.className = 'add-participant-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="modal-content" style="background-color: white; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
                <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    Ajouter un participant
                    <button class="close-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </h3>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="participant-name" style="display: block; margin-bottom: 5px; font-weight: 500;">Nom du participant</label>
                    <input type="text" id="participant-name" class="form-control" placeholder="Ex: Jean Dupont" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="participant-role" style="display: block; margin-bottom: 5px; font-weight: 500;">R√¥le</label>
                    <select id="participant-role" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="Recruteur">Recruteur</option>
                        <option value="Manager">Manager</option>
                        <option value="RH">Ressources Humaines</option>
                        <option value="Technique">Expert technique</option>
                        <option value="Direction">Direction</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="participant-email" style="display: block; margin-bottom: 5px; font-weight: 500;">Email (optionnel)</label>
                    <input type="email" id="participant-email" class="form-control" placeholder="Ex: jean.dupont@entreprise.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="cancel-btn" style="padding: 10px 15px; border: 1px solid #ddd; background-color: white; border-radius: 5px; cursor: pointer;">Annuler</button>
                    <button class="save-btn" style="padding: 10px 15px; border: none; background-color: #7c3aed; color: white; border-radius: 5px; cursor: pointer;">Ajouter</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Gestionnaires d'√©v√©nements de la modal
        const closeBtn = modal.querySelector('.close-modal');
        const cancelBtn = modal.querySelector('.cancel-btn');
        const saveBtn = modal.querySelector('.save-btn');
        
        function closeModal() {
            document.body.removeChild(modal);
        }
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        saveBtn.addEventListener('click', function() {
            const name = modal.querySelector('#participant-name').value.trim();
            const role = modal.querySelector('#participant-role').value;
            const email = modal.querySelector('#participant-email').value.trim();
            
            if (name) {
                // Ajouter le participant √† l'√©tat
                participants[stepId].push({ name, role, email });
                
                // Mettre √† jour l'affichage des participants
                updateParticipantsDisplay(step);
                
                // Afficher une notification
                showNotification('Participant ajout√© avec succ√®s');
                
                closeModal();
            } else {
                alert('Veuillez au moins remplir le nom du participant.');
            }
        });
    }
    
    /**
     * Met √† jour l'affichage des participants pour une √©tape
     * @param {HTMLElement} step - L'√©tape concern√©e
     */
    function updateParticipantsDisplay(step) {
        const stepId = step.getAttribute('data-step-id');
        const participantsContainer = step.querySelector('.participants-container');
        
        // Vider le conteneur
        participantsContainer.innerHTML = '';
        
        // S'il y a des participants, afficher le conteneur
        if (participants[stepId] && participants[stepId].length > 0) {
            participantsContainer.style.display = 'block';
            
            // Cr√©er la liste des participants
            const participantsList = document.createElement('div');
            participantsList.className = 'participants-list';
            participantsList.style.marginTop = '10px';
            participantsList.style.padding = '10px';
            participantsList.style.backgroundColor = 'rgba(124, 58, 237, 0.05)';
            participantsList.style.borderRadius = '5px';
            
            // Ajouter le titre
            const title = document.createElement('h4');
            title.textContent = 'Participants';
            title.style.fontSize = '0.9rem';
            title.style.fontWeight = '600';
            title.style.marginBottom = '8px';
            participantsList.appendChild(title);
            
            // Ajouter chaque participant
            participants[stepId].forEach((participant, index) => {
                const participantItem = document.createElement('div');
                participantItem.className = 'participant-item';
                participantItem.style.display = 'flex';
                participantItem.style.justifyContent = 'space-between';
                participantItem.style.alignItems = 'center';
                participantItem.style.padding = '5px 0';
                participantItem.style.borderBottom = index < participants[stepId].length - 1 ? '1px solid rgba(124, 58, 237, 0.1)' : 'none';
                
                participantItem.innerHTML = `
                    <div>
                        <span style="font-weight: 500;">${participant.name}</span>
                        <span style="font-size: 0.8rem; color: #64748b; margin-left: 5px;">(${participant.role})</span>
                    </div>
                    <button class="remove-participant-btn" data-index="${index}" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                participantsList.appendChild(participantItem);
            });
            
            participantsContainer.appendChild(participantsList);
            
            // Ajouter les gestionnaires d'√©v√©nements pour supprimer les participants
            const removeButtons = participantsContainer.querySelectorAll('.remove-participant-btn');
            removeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(btn.getAttribute('data-index'));
                    participants[stepId].splice(index, 1);
                    updateParticipantsDisplay(step);
                    showNotification('Participant supprim√©');
                });
            });
        } else {
            participantsContainer.style.display = 'none';
        }
    }
    
    /**
     * Change le statut d'une √©tape (active, termin√©e, etc.)
     * @param {HTMLElement} step - L'√©tape concern√©e
     */
    function changeStepStatus(step) {
        // Cr√©er une modal pour changer le statut
        const modal = document.createElement('div');
        modal.className = 'change-status-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="modal-content" style="background-color: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90%;">
                <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    Changer le statut
                    <button class="close-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </h3>
                <div class="status-options" style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="status-option" data-status="pending" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: white; text-align: left; cursor: pointer;">
                        <i class="fas fa-clock" style="color: #f59e0b; margin-right: 10px;"></i> En attente
                    </button>
                    <button class="status-option" data-status="active" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: white; text-align: left; cursor: pointer;">
                        <i class="fas fa-spinner" style="color: #3b82f6; margin-right: 10px;"></i> En cours
                    </button>
                    <button class="status-option" data-status="completed" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: white; text-align: left; cursor: pointer;">
                        <i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i> Termin√©e
                    </button>
                    <button class="status-option" data-status="skipped" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: white; text-align: left; cursor: pointer;">
                        <i class="fas fa-forward" style="color: #6b7280; margin-right: 10px;"></i> Ignor√©e
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Gestionnaires d'√©v√©nements de la modal
        const closeBtn = modal.querySelector('.close-modal');
        closeBtn.addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        const statusOptions = modal.querySelectorAll('.status-option');
        statusOptions.forEach(option => {
            option.addEventListener('click', function() {
                const status = this.getAttribute('data-status');
                
                // Supprimer toutes les classes de statut existantes
                step.classList.remove('active', 'completed', 'pending', 'skipped');
                
                // Ajouter la nouvelle classe de statut
                step.classList.add(status);
                
                // Mettre √† jour l'apparence en fonction du statut
                const stepIcon = step.querySelector('.flow-step-icon');
                
                if (status === 'completed') {
                    stepIcon.innerHTML = '<i class="fas fa-check"></i>';
                    stepIcon.style.backgroundColor = '#10b981';
                    stepIcon.style.color = 'white';
                    stepIcon.style.borderColor = '#10b981';
                } else if (status === 'active') {
                    stepIcon.textContent = step.querySelector('.flow-step-icon').textContent;
                    stepIcon.style.backgroundColor = '#7c3aed';
                    stepIcon.style.color = 'white';
                    stepIcon.style.borderColor = '#7c3aed';
                } else if (status === 'pending') {
                    stepIcon.textContent = step.querySelector('.flow-step-icon').textContent;
                    stepIcon.style.backgroundColor = '#f59e0b';
                    stepIcon.style.color = 'white';
                    stepIcon.style.borderColor = '#f59e0b';
                } else if (status === 'skipped') {
                    stepIcon.innerHTML = '<i class="fas fa-forward"></i>';
                    stepIcon.style.backgroundColor = '#6b7280';
                    stepIcon.style.color = 'white';
                    stepIcon.style.borderColor = '#6b7280';
                }
                
                // Afficher une notification
                showNotification('Statut mis √† jour');
                
                document.body.removeChild(modal);
            });
        });
    }
    
    /**
     * Ajoute un bouton pour sauvegarder le mod√®le actuel
     */
    function addSaveTemplateButton() {
        const saveTemplateBtn = document.createElement('button');
        saveTemplateBtn.className = 'btn btn-secondary save-template-btn';
        saveTemplateBtn.style.marginLeft = '10px';
        saveTemplateBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer ce processus';
        
        const actionButtons = document.querySelector('.action-buttons');
        actionButtons.prepend(saveTemplateBtn);
        
        saveTemplateBtn.addEventListener('click', function() {
            saveProcessTemplate();
        });
    }
    
    /**
     * Ajoute un menu d√©roulant pour les mod√®les pr√©d√©finis
     */
    function addPredefinedTemplatesDropdown() {
        // Cr√©er le conteneur pour le s√©lecteur de mod√®les
        const templateSelectorContainer = document.createElement('div');
        templateSelectorContainer.className = 'template-selector-container';
        templateSelectorContainer.style.display = 'flex';
        templateSelectorContainer.style.alignItems = 'center';
        templateSelectorContainer.style.marginBottom = '20px';
        
        templateSelectorContainer.innerHTML = `
            <h4 style="margin: 0 15px 0 0; font-size: 1rem; font-weight: 600;">Mod√®les de processus</h4>
            <select id="process-template-selector" class="form-control" style="max-width: 250px;">
                <option value="">S√©lectionner un mod√®le pr√©d√©fini</option>
                <option value="technique">Recrutement technique</option>
                <option value="manager">Recrutement manager</option>
                <option value="commercial">Recrutement commercial</option>
                <option value="rapide">Processus rapide</option>
                <option value="approfondi">Processus approfondi</option>
            </select>
            <button id="apply-template-btn" class="btn" style="margin-left: 10px; padding: 8px 16px; background-color: #7c3aed; color: white; border: none; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-check"></i> Appliquer
            </button>
        `;
        
        // Ins√©rer avant le conteneur du flux
        processFlowSection.insertBefore(templateSelectorContainer, flowContainer);
        
        // Ajouter le gestionnaire d'√©v√©nements pour appliquer un mod√®le
        const applyTemplateBtn = document.getElementById('apply-template-btn');
        applyTemplateBtn.addEventListener('click', function() {
            const templateSelector = document.getElementById('process-template-selector');
            const selectedTemplate = templateSelector.value;
            
            if (selectedTemplate) {
                applyProcessTemplate(selectedTemplate);
            } else {
                alert('Veuillez s√©lectionner un mod√®le de processus.');
            }
        });
    }
    
    /**
     * Sauvegarde le processus actuel comme mod√®le
     */
    function saveProcessTemplate() {
        // Cr√©er une modal pour nommer et sauvegarder le mod√®le
        const modal = document.createElement('div');
        modal.className = 'save-template-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="modal-content" style="background-color: white; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
                <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    Enregistrer le processus comme mod√®le
                    <button class="close-modal" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </h3>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="template-name" style="display: block; margin-bottom: 5px; font-weight: 500;">Nom du mod√®le</label>
                    <input type="text" id="template-name" class="form-control" placeholder="Ex: Processus technique" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="template-description" style="display: block; margin-bottom: 5px; font-weight: 500;">Description (optionnelle)</label>
                    <textarea id="template-description" class="form-control" rows="3" placeholder="D√©crivez bri√®vement ce mod√®le de processus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="cancel-btn" style="padding: 10px 15px; border: 1px solid #ddd; background-color: white; border-radius: 5px; cursor: pointer;">Annuler</button>
                    <button class="save-btn" style="padding: 10px 15px; border: none; background-color: #7c3aed; color: white; border-radius: 5px; cursor: pointer;">Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Gestionnaires d'√©v√©nements de la modal
        const closeBtn = modal.querySelector('.close-modal');
        const cancelBtn = modal.querySelector('.cancel-btn');
        const saveBtn = modal.querySelector('.save-btn');
        
        function closeModal() {
            document.body.removeChild(modal);
        }
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        saveBtn.addEventListener('click', function() {
            const templateName = modal.querySelector('#template-name').value.trim();
            const templateDescription = modal.querySelector('#template-description').value.trim();
            
            if (templateName) {
                // Collecter les donn√©es du processus actuel
                const steps = document.querySelectorAll('.flow-step');
                const processData = {
                    name: templateName,
                    description: templateDescription,
                    steps: []
                };
                
                steps.forEach(step => {
                    const stepId = step.getAttribute('data-step-id');
                    const title = step.querySelector('.step-title-text').textContent;
                    const description = step.querySelector('.flow-step-description').textContent;
                    
                    processData.steps.push({
                        title,
                        description,
                        participants: participants[stepId] || []
                    });
                });
                
                // Sauvegarder dans localStorage
                const savedTemplates = JSON.parse(localStorage.getItem('recruitmentProcessTemplates') || '{}');
                savedTemplates[templateName] = processData;
                localStorage.setItem('recruitmentProcessTemplates', JSON.stringify(savedTemplates));
                
                // Ajouter au s√©lecteur de mod√®les
                const templateSelector = document.getElementById('process-template-selector');
                const option = document.createElement('option');
                option.value = templateName;
                option.textContent = templateName;
                templateSelector.appendChild(option);
                
                showNotification('Mod√®le de processus enregistr√© avec succ√®s');
                closeModal();
            } else {
                alert('Veuillez entrer un nom pour le mod√®le.');
            }
        });
    }
    
    /**
     * Applique un mod√®le de processus pr√©d√©fini
     * @param {string} templateName - Le nom du mod√®le √† appliquer
     */
    function applyProcessTemplate(templateName) {
        // Demander confirmation
        if (!confirm('√ätes-vous s√ªr de vouloir appliquer ce mod√®le ? Cela remplacera le processus actuel.')) {
            return;
        }
        
        // Supprimer toutes les √©tapes actuelles sauf la premi√®re
        const steps = document.querySelectorAll('.flow-step');
        
        // Garder une r√©f√©rence √† la premi√®re √©tape
        const firstStep = steps[0];
        
        // Supprimer toutes les √©tapes sauf la premi√®re et leurs connecteurs
        for (let i = 1; i < steps.length; i++) {
            const stepToRemove = steps[i];
            const connectorBefore = stepToRemove.previousElementSibling;
            if (connectorBefore && connectorBefore.classList.contains('flow-connector')) {
                flowContainer.removeChild(connectorBefore);
            }
            flowContainer.removeChild(stepToRemove);
        }
        
        // R√©initialiser les participants
        participants = {};
        participants[1] = []; // Pour la premi√®re √©tape
        
        // Mettre √† jour le titre et la description de la premi√®re √©tape selon le mod√®le
        if (templateName === 'technique') {
            firstStep.querySelector('.step-title-text').textContent = '√âvaluation initiale du CV';
            firstStep.querySelector('.flow-step-description').textContent = 'Analyse du profil technique et des comp√©tences requises';
            
            // Ajouter les √©tapes sp√©cifiques au recrutement technique
            addNewStep(null, stepTemplates.entretien_telephonique);
            addNewStep(null, stepTemplates.test_technique);
            addNewStep(null, {
                title: 'Revue de code',
                description: 'Analyse d\'un exemple de code fourni par le candidat',
                icon: 'fa-code'
            });
            addNewStep(null, stepTemplates.entretien_video);
            addNewStep(null, stepTemplates.entretien_equipe);
            addNewStep(null, stepTemplates.negociation);
            
        } else if (templateName === 'manager') {
            firstStep.querySelector('.step-title-text').textContent = 'Pr√©s√©lection des candidats';
            firstStep.querySelector('.flow-step-description').textContent = '√âtude des profils et s√©lection des candidats potentiels';
            
            // Ajouter les √©tapes sp√©cifiques au recrutement manager
            addNewStep(null, stepTemplates.entretien_telephonique);
            addNewStep(null, {
                title: 'Assessment Center',
                description: '√âvaluation des comp√©tences manag√©riales et de leadership',
                icon: 'fa-tasks'
            });
            addNewStep(null, {
                title: 'Entretien avec la Direction',
                description: 'Discussion approfondie sur la vision et les objectifs',
                icon: 'fa-handshake'
            });
            addNewStep(null, stepTemplates.entretien_equipe);
            addNewStep(null, stepTemplates.negociation);
            
        } else if (templateName === 'commercial') {
            firstStep.querySelector('.step-title-text').textContent = 'Qualification initiale';
            firstStep.querySelector('.flow-step-description').textContent = '√âvaluation de l\'exp√©rience commerciale et des r√©sultats';
            
            // Ajouter les √©tapes sp√©cifiques au recrutement commercial
            addNewStep(null, stepTemplates.entretien_telephonique);
            addNewStep(null, {
                title: 'Mise en situation de vente',
                description: 'Exercice pratique de pitch et n√©gociation',
                icon: 'fa-chart-line'
            });
            addNewStep(null, stepTemplates.entretien_video);
            addNewStep(null, {
                title: 'Rencontre avec l\'√©quipe commerciale',
                description: 'Pr√©sentation de l\'√©quipe et de la dynamique de travail',
                icon: 'fa-users'
            });
            addNewStep(null, stepTemplates.negociation);
            
        } else if (templateName === 'rapide') {
            firstStep.querySelector('.step-title-text').textContent = 'Entretien t√©l√©phonique';
            firstStep.querySelector('.flow-step-description').textContent = 'Premier contact pour √©valuer les comp√©tences et motivations';
            
            // Ajouter les √©tapes pour un processus rapide
            addNewStep(null, {
                title: 'Entretien avec le manager',
                description: 'Discussion approfondie sur les comp√©tences et l\'exp√©rience',
                icon: 'fa-user-tie'
            });
            addNewStep(null, stepTemplates.negociation);
            
        } else if (templateName === 'approfondi') {
            firstStep.querySelector('.step-title-text').textContent = 'Pr√©s√©lection des CV';
            firstStep.querySelector('.flow-step-description').textContent = 'Analyse d√©taill√©e des profils et premi√®re s√©lection';
            
            // Ajouter les √©tapes pour un processus approfondi
            addNewStep(null, stepTemplates.entretien_telephonique);
            addNewStep(null, {
                title: 'Tests d\'aptitude',
                description: '√âvaluation des comp√©tences techniques et comportementales',
                icon: 'fa-clipboard-check'
            });
            addNewStep(null, stepTemplates.entretien_video);
            addNewStep(null, stepTemplates.assessment);
            addNewStep(null, {
                title: 'V√©rification des r√©f√©rences',
                description: 'Contact avec les anciens employeurs ou collaborateurs',
                icon: 'fa-user-check'
            });
            addNewStep(null, stepTemplates.entretien_equipe);
            addNewStep(null, {
                title: 'Entretien final',
                description: 'Derni√®re validation avant proposition',
                icon: 'fa-stamp'
            });
            addNewStep(null, stepTemplates.negociation);
        }
        
        // V√©rifier si c'est un mod√®le sauvegard√©
        const savedTemplates = JSON.parse(localStorage.getItem('recruitmentProcessTemplates') || '{}');
        if (savedTemplates[templateName]) {
            // Appliquer le mod√®le sauvegard√©
            const savedTemplate = savedTemplates[templateName];
            
            // Mettre √† jour la premi√®re √©tape
            if (savedTemplate.steps && savedTemplate.steps.length > 0) {
                firstStep.querySelector('.step-title-text').textContent = savedTemplate.steps[0].title;
                firstStep.querySelector('.flow-step-description').textContent = savedTemplate.steps[0].description;
                
                // Ajouter les participants de la premi√®re √©tape
                if (savedTemplate.steps[0].participants) {
                    participants[1] = savedTemplate.steps[0].participants;
                    updateParticipantsDisplay(firstStep);
                }
                
                // Ajouter les autres √©tapes du mod√®le
                for (let i = 1; i < savedTemplate.steps.length; i++) {
                    const stepData = savedTemplate.steps[i];
                    
                    // Ajouter l'√©tape
                    addNewStep(null, {
                        title: stepData.title,
                        description: stepData.description
                    });
                    
                    // R√©cup√©rer l'√©tape nouvellement cr√©√©e
                    const newStepElement = document.querySelectorAll('.flow-step')[i];
                    const newStepId = newStepElement.getAttribute('data-step-id');
                    
                    // Ajouter les participants
                    if (stepData.participants) {
                        participants[newStepId] = stepData.participants;
                        updateParticipantsDisplay(newStepElement);
                    }
                }
            }
        }
        
        // Afficher une notification
        showNotification('Mod√®le de processus appliqu√© avec succ√®s');
    }
    
    /**
     * Affiche une notification √† l'utilisateur
     * @param {string} message - Le message √† afficher
     */
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.right = '20px';
        notification.style.backgroundColor = 'rgba(124, 58, 237, 0.9)';
        notification.style.color = 'white';
        notification.style.padding = '12px 20px';
        notification.style.borderRadius = '5px';
        notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
        notification.style.zIndex = '9999';
        notification.style.transition = 'all 0.3s ease';
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(20px)';
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animation d'entr√©e
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateY(0)';
        }, 10);
        
        // Dispara√Ætre apr√®s 3 secondes
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(20px)';
            
            // Supprimer du DOM apr√®s la fin de l'animation
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    
    // Ajouter CSS pour les nouvelles fonctionnalit√©s
    function addCustomStyles() {
        const styleSheet = document.createElement('style');
        styleSheet.type = 'text/css';
        styleSheet.textContent = `
            /* Animation pour les modales */
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            /* Styles pour les √©tapes avec statut */
            .flow-step.active .flow-step-icon {
                background-color: #7c3aed;
                color: white;
                border-color: #7c3aed;
            }
            
            .flow-step.completed .flow-step-icon {
                background-color: #10b981;
                color: white;
                border-color: #10b981;
            }
            
            .flow-step.pending .flow-step-icon {
                background-color: #f59e0b;
                color: white;
                border-color: #f59e0b;
            }
            
            .flow-step.skipped .flow-step-icon {
                background-color: #6b7280;
                color: white;
                border-color: #6b7280;
            }
            
            /* Hover sur les boutons d'action */
            .flow-action-btn:hover {
                background-color: rgba(124, 58, 237, 0.1);
            }
            
            /* Style du menu d√©roulant */
            .template-selector-container select:focus {
                border-color: #7c3aed;
                outline: none;
                box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            }
            
            /* Styles pour les participants */
            .participants-list {
                transition: all 0.3s ease;
            }
            
            .participant-item:hover {
                background-color: rgba(124, 58, 237, 0.05);
            }
            
            /* Bouton d'enregistrement de template */
            .save-template-btn:hover {
                background-color: rgba(124, 58, 237, 0.1);
                color: #7c3aed;
            }
        `;
        
        document.head.appendChild(styleSheet);
    }
    
    // Initialiser les fonctionnalit√©s
    addCustomStyles();
    initRecruitmentProcess();
});