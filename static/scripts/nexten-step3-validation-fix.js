/**
 * CORRECTION CRITIQUE : Fix validation √©tape 3 - Motivations professionnelles
 * Probl√®me: Conflit entre deux syst√®mes de gestion des motivations
 * Solution: Synchronisation et validation corrig√©e
 */

console.log('üîß Chargement correction validation √©tape 3...');

// Fonction de correction de la validation
function fixStep3Validation() {
    console.log('üéØ Application du fix validation √©tape 3...');

    // 1. Corriger la m√©thode validateStep dans NextenQuestionnaire
    if (window.nextenQuestionnaire && window.nextenQuestionnaire.validateStep) {
        const originalValidateStep = window.nextenQuestionnaire.validateStep.bind(window.nextenQuestionnaire);
        
        window.nextenQuestionnaire.validateStep = function(step) {
            if (step === 3) {
                console.log('üîç Validation √©tape 3 avec fix appliqu√©...');
                
                // V√©rifier les motivations via le syst√®me motivationSystem
                const motivationSystemExists = window.motivationSystem && window.motivationSystem.selectedMotivations;
                const selectedMotivations = motivationSystemExists ? window.motivationSystem.selectedMotivations : [];
                
                console.log('üìä Motivations d√©tect√©es:', selectedMotivations);
                
                if (selectedMotivations.length === 0) {
                    this.showNotification('Veuillez s√©lectionner au moins une motivation professionnelle', 'warning');
                    console.log('‚ùå Validation √©chou√©e: aucune motivation s√©lectionn√©e');
                    return false;
                }
                
                // Synchroniser avec this.selectedMotivations pour √©viter les conflits futurs
                this.selectedMotivations = [...selectedMotivations];
                
                console.log('‚úÖ Validation √©tape 3 r√©ussie');
                return true;
            }
            
            // Utiliser la validation originale pour les autres √©tapes
            return originalValidateStep(step);
        };
        
        console.log('‚úÖ M√©thode validateStep corrig√©e');
    }

    // 2. Ajouter une validation alternative sur le bouton Continuer
    const nextStep3Button = document.getElementById('next-step3');
    if (nextStep3Button) {
        // Supprimer les anciens listeners pour √©viter les doublons
        const newButton = nextStep3Button.cloneNode(true);
        nextStep3Button.parentNode.replaceChild(newButton, nextStep3Button);
        
        // Ajouter le nouveau listener corrig√©
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üöÄ Clic sur Continuer √©tape 3 avec validation corrig√©e...');
            
            // Validation directe des motivations
            const motivationSystemExists = window.motivationSystem && window.motivationSystem.selectedMotivations;
            const selectedMotivations = motivationSystemExists ? window.motivationSystem.selectedMotivations : [];
            
            console.log('üìä Validation motivations:', {
                systemExists: motivationSystemExists,
                selectedCount: selectedMotivations.length,
                motivations: selectedMotivations
            });
            
            if (selectedMotivations.length === 0) {
                showValidationError('Veuillez s√©lectionner au moins une motivation professionnelle');
                return false;
            }
            
            // V√©rification optionnelle des secteurs (non bloquante)
            const sectorsSystemExists = window.sectorsSystem && window.sectorsSystem.selectedSectors;
            const selectedSectors = sectorsSystemExists ? window.sectorsSystem.selectedSectors : [];
            console.log('üè≠ Secteurs s√©lectionn√©s:', selectedSectors.length);
            
            // V√©rification optionnelle de la fourchette salariale (non bloquante)
            const salarySystemExists = window.salarySystem;
            if (salarySystemExists) {
                console.log('üí∞ Fourchette salariale:', `${window.salarySystem.min}K - ${window.salarySystem.max}K`);
            }
            
            // Si tout est valide, naviguer vers l'√©tape 4
            console.log('‚úÖ Toutes les validations sont pass√©es, navigation vers √©tape 4');
            
            if (window.nextenQuestionnaire && window.nextenQuestionnaire.goToStep) {
                window.nextenQuestionnaire.goToStep(4);
            } else {
                // Fallback manuel
                document.querySelectorAll('.form-step').forEach(step => {
                    step.style.display = 'none';
                    step.classList.remove('active');
                });
                
                const step4 = document.getElementById('form-step4');
                if (step4) {
                    step4.style.display = 'block';
                    step4.classList.add('active');
                    step4.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    console.log('‚úÖ Navigation manuelle vers √©tape 4 r√©ussie');
                } else {
                    console.error('‚ùå Impossible de trouver l\'√©tape 4');
                }
            }
        });
        
        console.log('‚úÖ Event listener corrig√© ajout√© au bouton Continuer');
    }

    // 3. Mise √† jour des indicateurs d'√©tapes
    updateStepIndicators(4);
}

// Fonction d'affichage d'erreur de validation
function showValidationError(message) {
    console.log('‚ö†Ô∏è Erreur de validation:', message);
    
    // Supprimer les anciens messages d'erreur
    document.querySelectorAll('.step3-validation-error').forEach(error => error.remove());
    
    // Cr√©er le message d'erreur
    const errorDiv = document.createElement('div');
    errorDiv.className = 'step3-validation-error';
    errorDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
        max-width: 400px;
        animation: errorPulse 0.5s ease-in-out;
    `;
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="margin-right: 10px; font-size: 18px;"></i>
        <div>${message}</div>
        <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
            S√©lectionnez vos motivations pour continuer
        </div>
    `;
    
    // Ajouter l'animation CSS
    if (!document.getElementById('step3-error-styles')) {
        const style = document.createElement('style');
        style.id = 'step3-error-styles';
        style.textContent = `
            @keyframes errorPulse {
                0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                50% { transform: translate(-50%, -50%) scale(1.05); }
                100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(errorDiv);
    
    // Supprimer automatiquement apr√®s 4 secondes
    setTimeout(() => {
        errorDiv.style.opacity = '0';
        errorDiv.style.transform = 'translate(-50%, -50%) scale(0.8)';
        setTimeout(() => errorDiv.remove(), 300);
    }, 4000);
    
    // Scroller vers les motivations pour aider l'utilisateur
    const motivationContainer = document.querySelector('.motivation-ranking-container');
    if (motivationContainer) {
        motivationContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Ajouter un effet visuel temporaire
        motivationContainer.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.5)';
        setTimeout(() => {
            motivationContainer.style.boxShadow = '';
        }, 2000);
    }
}

// Fonction de mise √† jour des indicateurs d'√©tapes
function updateStepIndicators(currentStep) {
    try {
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum < currentStep) {
                step.classList.add('completed');
            } else if (stepNum === currentStep) {
                step.classList.add('active');
            }
        });

        // Mise √† jour de la barre de progression
        const progress = ((currentStep - 1) / 3) * 100; // 4 √©tapes au total
        const progressBar = document.getElementById('stepper-progress');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        
        console.log(`üìä Indicateurs mis √† jour pour l'√©tape ${currentStep}`);
    } catch (error) {
        console.error('‚ùå Erreur mise √† jour indicateurs:', error);
    }
}

// Fonction d'initialisation avec v√©rifications multiples
function initializeStep3Fix() {
    console.log('üöÄ Initialisation du fix √©tape 3...');
    
    // V√©rifier que les √©l√©ments n√©cessaires sont pr√©sents
    const checkAndApplyFix = () => {
        const nextButton = document.getElementById('next-step3');
        const motivationCards = document.querySelectorAll('.motivation-card');
        
        if (nextButton && motivationCards.length > 0) {
            fixStep3Validation();
            console.log('‚úÖ Fix √©tape 3 appliqu√© avec succ√®s');
            return true;
        } else {
            console.log('‚è≥ √âl√©ments pas encore disponibles, nouvelle tentative...');
            return false;
        }
    };
    
    // Tentatives multiples d'initialisation
    if (!checkAndApplyFix()) {
        setTimeout(() => {
            if (!checkAndApplyFix()) {
                setTimeout(() => {
                    if (!checkAndApplyFix()) {
                        console.warn('‚ö†Ô∏è Fix √©tape 3 non appliqu√© apr√®s plusieurs tentatives');
                    }
                }, 1000);
            }
        }, 500);
    }
}

// D√©marrage automatique
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializeStep3Fix, 300);
    });
} else {
    setTimeout(initializeStep3Fix, 100);
}

// Fallback d'urgence pour les cas o√π le fix n'est pas appliqu√©
setTimeout(() => {
    const nextButton = document.getElementById('next-step3');
    if (nextButton && !nextButton.hasAttribute('data-fix-applied')) {
        console.log('üÜò Application du fallback d\'urgence...');
        initializeStep3Fix();
    }
}, 2000);

console.log('‚úÖ Script de correction validation √©tape 3 charg√©');
