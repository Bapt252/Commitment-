<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Syst√®me CV Parser Automatis√©</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin: 1.5rem 0;
            padding: 1rem;
            border-left: 4px solid #4CAF50;
            background-color: #f9f9f9;
        }
        
        .test-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
            font-weight: 500;
        }
        
        .test-button:hover {
            background-color: #45a049;
        }
        
        .test-results {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background-color: #4CAF50; }
        .status-warning { background-color: #FF9800; }
        .status-error { background-color: #F44336; }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Syst√®me CV Parser Automatis√©</h1>
        <p>Cette page teste automatiquement tous les composants de votre solution automatis√©e.</p>
        
        <!-- STATUS G√âN√âRAL -->
        <div class="test-section">
            <h3>üìä Statut G√©n√©ral du Syst√®me</h3>
            <div id="generalStatus"></div>
            <button class="test-button" onclick="testGeneralStatus()">üîç Tester Statut</button>
        </div>
        
        <!-- TESTS AUTOMATIQUES -->
        <div class="test-section">
            <h3>üöÄ Tests Automatiques</h3>
            <div class="test-grid">
                <button class="test-button" onclick="testInterceptorInstallation()">
                    üîß Test Intercepteur
                </button>
                <button class="test-button" onclick="testPDFjsLoading()">
                    üìÑ Test PDF.js
                </button>
                <button class="test-button" onclick="testAPIConfiguration()">
                    üîë Test Config API
                </button>
                <button class="test-button" onclick="testFallbackSystem()">
                    üõ°Ô∏è Test Fallback
                </button>
                <button class="test-button" onclick="testTokenOptimization()">
                    ‚ö° Test Tokens
                </button>
                <button class="test-button" onclick="runFullTestSuite()">
                    üéØ Test Complet
                </button>
            </div>
        </div>
        
        <!-- R√âSULTATS -->
        <div class="test-section">
            <h3>üìã R√©sultats des Tests</h3>
            <div id="testResults" class="test-results">
=== SYST√àME DE TEST CV PARSER AUTOMATIS√â ===
Pr√™t √† tester votre solution automatis√©e !

Instructions:
1. Cliquez sur "Test Complet" pour une validation automatique
2. Ou testez chaque composant individuellement
3. V√©rifiez que tous les indicateurs sont verts ‚úÖ

Attendez les r√©sultats ci-dessous...
            </div>
        </div>
        
        <!-- ACTIONS RAPIDES -->
        <div class="test-section">
            <h3>‚ö° Actions Rapides</h3>
            <button class="test-button" onclick="clearResults()">üóëÔ∏è Effacer</button>
            <button class="test-button" onclick="exportResults()">üíæ Exporter</button>
            <button class="test-button" onclick="window.open('candidate-upload-automated.html', '_blank')">
                üîó Ouvrir Page Automatis√©e
            </button>
        </div>
    </div>

    <!-- CHARGEMENT DU SYST√àME AUTOMATIS√â -->
    <script src="cv-parser-integration-automated.js"></script>
    
    <!-- SCRIPT DE TEST -->
    <script>
        // ========================================================================================
        // üß™ SYST√àME DE TEST AUTOMATIS√â
        // ========================================================================================
        
        let testResults = [];
        let systemReady = false;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logMessage = `[${timestamp}] ${prefix} ${message}`;
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent += '\n' + logMessage;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            testResults.push({ timestamp, type, message: logMessage });
        }
        
        // ========================================================================================
        // üîç TESTS INDIVIDUELS
        // ========================================================================================
        
        async function testGeneralStatus() {
            log('=== TEST STATUT G√âN√âRAL ===', 'info');
            
            try {
                // Test de la fonction de stats
                if (typeof window.getSystemStats === 'function') {
                    const stats = window.getSystemStats();
                    log(`Syst√®me actif: ${stats.isActive}`, stats.isActive ? 'success' : 'error');
                    log(`Version: ${stats.version}`, 'info');
                    log(`Status: ${stats.status}`, stats.status === 'OPERATIONAL' ? 'success' : 'warning');
                    log(`CV trait√©s: ${stats.totalCVsProcessed}`, 'info');
                    log(`Tokens max: ${stats.maxTokens}`, 'info');
                    log(`Cl√© API: ${stats.hasApiKey ? 'Configur√©e' : 'Manquante'}`, stats.hasApiKey ? 'success' : 'warning');
                    
                    systemReady = stats.isActive && stats.status === 'OPERATIONAL';
                } else {
                    log('Fonction getSystemStats non disponible', 'error');
                    systemReady = false;
                }
            } catch (error) {
                log(`Erreur test statut: ${error.message}`, 'error');
                systemReady = false;
            }
            
            updateGeneralStatusDisplay();
        }
        
        function updateGeneralStatusDisplay() {
            const statusDiv = document.getElementById('generalStatus');
            const statusClass = systemReady ? 'status-success' : 'status-error';
            const statusText = systemReady ? 'OP√âRATIONNEL' : 'PROBL√àME D√âTECT√â';
            
            statusDiv.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                <strong>${statusText}</strong>
                ${systemReady ? '- Syst√®me pr√™t √† l\'utilisation' : '- V√©rifiez la configuration'}
            `;
        }
        
        async function testInterceptorInstallation() {
            log('=== TEST INTERCEPTEUR FETCH ===', 'info');
            
            try {
                // V√©rifier que l'intercepteur est install√©
                const originalExists = !!window.originalFetchForCVParser;
                log(`Fetch original sauvegard√©: ${originalExists}`, originalExists ? 'success' : 'warning');
                
                // Tester l'interception (simulation)
                const testUrl = 'https://api.openai.com/v1/chat/completions';
                log(`Test URL cible: ${testUrl}`, 'info');
                
                // V√©rifier que la fonction d'interception existe
                const interceptorActive = typeof window.fetch === 'function';
                log(`Intercepteur actif: ${interceptorActive}`, interceptorActive ? 'success' : 'error');
                
                if (window.CVParserIntegration) {
                    log('Classe CVParserIntegration disponible', 'success');
                } else {
                    log('Classe CVParserIntegration manquante', 'error');
                }
                
            } catch (error) {
                log(`Erreur test intercepteur: ${error.message}`, 'error');
            }
        }
        
        async function testPDFjsLoading() {
            log('=== TEST PDF.JS ===', 'info');
            
            try {
                // V√©rifier que PDF.js est charg√©
                const pdfjsLoaded = !!window.pdfjsLib;
                log(`PDF.js charg√©: ${pdfjsLoaded}`, pdfjsLoaded ? 'success' : 'warning');
                
                if (pdfjsLoaded) {
                    log(`Version PDF.js: ${window.pdfjsLib.version || 'inconnue'}`, 'info');
                    
                    // V√©rifier worker
                    const workerConfigured = !!window.pdfjsLib.GlobalWorkerOptions.workerSrc;
                    log(`Worker configur√©: ${workerConfigured}`, workerConfigured ? 'success' : 'warning');
                    
                    if (workerConfigured) {
                        log(`Worker URL: ${window.pdfjsLib.GlobalWorkerOptions.workerSrc}`, 'info');
                    }
                } else {
                    log('PDF.js non charg√© - l\'extraction PDF ne fonctionnera pas', 'warning');
                }
                
            } catch (error) {
                log(`Erreur test PDF.js: ${error.message}`, 'error');
            }
        }
        
        async function testAPIConfiguration() {
            log('=== TEST CONFIGURATION API ===', 'info');
            
            try {
                // V√©rifier localStorage
                const apiKey = localStorage.getItem('openai_api_key');
                if (apiKey) {
                    const keyPreview = apiKey.substring(0, 10) + '...';
                    log(`Cl√© API trouv√©e: ${keyPreview}`, 'success');
                    log(`Longueur cl√©: ${apiKey.length} caract√®res`, 'info');
                    
                    const validFormat = apiKey.startsWith('sk-');
                    log(`Format valide: ${validFormat}`, validFormat ? 'success' : 'error');
                } else {
                    log('Aucune cl√© API configur√©e', 'warning');
                    log('Utilisez la section "Configuration API OpenAI" sur la page principale', 'info');
                }
                
                // Tester la fonction de configuration
                if (typeof window.configureApiKey === 'function') {
                    log('Fonction configureApiKey disponible', 'success');
                } else {
                    log('Fonction configureApiKey manquante', 'warning');
                }
                
            } catch (error) {
                log(`Erreur test API: ${error.message}`, 'error');
            }
        }
        
        async function testFallbackSystem() {
            log('=== TEST SYST√àME FALLBACK ===', 'info');
            
            try {
                // Tester la g√©n√©ration de donn√©es Sabine
                if (window.CVParserIntegration) {
                    const parser = new window.CVParserIntegration({
                        fallbackToSabine: true,
                        debugMode: true
                    });
                    
                    // Cr√©er un fichier de test
                    const testFile = new File(['test'], 'cv_test.pdf', { type: 'application/pdf' });
                    
                    if (typeof parser.generateSabineFallback === 'function') {
                        const fallbackData = parser.generateSabineFallback(testFile);
                        
                        log('Donn√©es fallback g√©n√©r√©es avec succ√®s', 'success');
                        log(`Nom: ${fallbackData.data.personal_info.name}`, 'info');
                        log(`Exp√©riences: ${fallbackData.data.work_experience.length}`, 'info');
                        log(`Comp√©tences: ${fallbackData.data.skills.length}`, 'info');
                        log(`Logiciels: ${fallbackData.data.software.length}`, 'info');
                        
                        const hasSevenExperiences = fallbackData.data.work_experience.length === 7;
                        log(`7 exp√©riences garanties: ${hasSevenExperiences}`, hasSevenExperiences ? 'success' : 'error');
                        
                    } else {
                        log('Fonction generateSabineFallback manquante', 'error');
                    }
                } else {
                    log('CVParserIntegration non disponible pour test fallback', 'error');
                }
                
            } catch (error) {
                log(`Erreur test fallback: ${error.message}`, 'error');
            }
        }
        
        async function testTokenOptimization() {
            log('=== TEST OPTIMISATION TOKENS ===', 'info');
            
            try {
                if (window.getSystemStats) {
                    const stats = window.getSystemStats();
                    const expectedTokens = 3500;
                    
                    log(`Tokens configur√©s: ${stats.maxTokens}`, 'info');
                    log(`Tokens attendus: ${expectedTokens}`, 'info');
                    
                    const tokensOptimized = stats.maxTokens === expectedTokens;
                    log(`Optimisation tokens: ${tokensOptimized}`, tokensOptimized ? 'success' : 'error');
                    
                    if (!tokensOptimized) {
                        log(`ATTENTION: Tokens √† ${stats.maxTokens} au lieu de ${expectedTokens}`, 'warning');
                    }
                } else {
                    log('Impossible de v√©rifier les tokens - getSystemStats manquant', 'error');
                }
                
                // Tester la disponibilit√© de l'optimisation automatique
                if (window.CVParserIntegration) {
                    log('Optimisation automatique disponible', 'success');
                } else {
                    log('Optimisation automatique manquante', 'error');
                }
                
            } catch (error) {
                log(`Erreur test tokens: ${error.message}`, 'error');
            }
        }
        
        async function runFullTestSuite() {
            log('üéØ === SUITE DE TESTS COMPL√àTE ===', 'info');
            log('D√©marrage des tests automatiques...', 'info');
            
            await testGeneralStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testInterceptorInstallation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testPDFjsLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAPIConfiguration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFallbackSystem();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testTokenOptimization();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // R√©sum√© final
            log('=== R√âSUM√â FINAL ===', 'info');
            
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            log(`‚úÖ Succ√®s: ${successCount}`, 'success');
            log(`‚ùå Erreurs: ${errorCount}`, errorCount > 0 ? 'error' : 'info');
            log(`‚ö†Ô∏è Avertissements: ${warningCount}`, warningCount > 0 ? 'warning' : 'info');
            
            if (errorCount === 0 && systemReady) {
                log('üéâ TOUS LES TESTS PASS√âS - SYST√àME OP√âRATIONNEL !', 'success');
            } else if (errorCount > 0) {
                log('‚ö†Ô∏è ERREURS D√âTECT√âES - V√©rifiez la configuration', 'error');
            } else {
                log('‚úÖ Syst√®me fonctionnel avec avertissements mineurs', 'warning');
            }
        }
        
        // ========================================================================================
        // üõ†Ô∏è UTILITAIRES
        // ========================================================================================
        
        function clearResults() {
            document.getElementById('testResults').textContent = 
                '=== R√âSULTATS EFFAC√âS ===\nPr√™t pour de nouveaux tests...';
            testResults = [];
        }
        
        function exportResults() {
            const results = testResults.map(r => r.message).join('\n');
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `cv-parser-test-results-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('R√©sultats export√©s', 'success');
        }
        
        // ========================================================================================
        // üöÄ INITIALISATION
        // ========================================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            log('üß™ Syst√®me de test charg√©', 'success');
            log('Pr√™t √† tester votre solution automatis√©e !', 'info');
            
            // Test automatique initial
            setTimeout(() => {
                testGeneralStatus();
            }, 1000);
        });
    </script>
</body>
</html>