<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexten - Analyse de Fiches de Poste</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../static/styles/nexten-modern-interactive.css">
    <link rel="stylesheet" href="../static/css/job-parser-styles.css">
    <link rel="stylesheet" href="../static/css/client-questionnaire.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ajout des styles intégrés pour l'auto-chargeur GPT -->
    <style>
        /* Style pour les boutons d'analyse GPT */
        .gpt-analyze-button {
            background-color: #10b981; /* Vert -->
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 10px auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: absolute;
            bottom: 10px;
            right: 60px;
            z-index: 10;
        }
        
        .gpt-analyze-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        .gpt-analyze-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Badge GPT */
        .gpt-connected-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Conteneur pour le bouton principal */
        .gpt-main-button-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        /* Bouton principal d'analyse GPT */
        .gpt-main-button {
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
            transition: all 0.3s ease;
        }
        
        .gpt-main-button:hover {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
        }
        
        .gpt-main-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <!-- Contenu de la page -->
    <div class="container">
        <header class="header">
            <h1>Analysez votre fiche de poste</h1>
            <p class="subtitle">Commencez par analyser votre fiche de poste pour en extraire automatiquement les informations clés</p>
        </header>

        <!-- Section de debug -->
        <div id="debug-section" class="debug-section">
            <h3>Informations de débogage</h3>
            <div id="debug-content"></div>
        </div>

        <main>
            <section class="form-section active">
                <div class="upload-container" id="job-drop-zone">
                    <i class="fas fa-file-upload upload-icon"></i>
                    <h3 class="upload-text drop-zone-text">Glissez-déposez votre fiche de poste ici</h3>
                    <p class="upload-hint">Formats acceptés: PDF, DOCX, TXT (max 5MB)</p>
                    <input type="file" id="job-file-input" class="file-input" accept=".pdf,.doc,.docx,.txt">
                    
                    <!-- Badge de fichier sélectionné (initialement caché) -->
                    <div id="file-badge" class="file-badge">
                        <i class="fas fa-file-alt"></i>
                        <span id="file-name" class="file-name">nom-du-fichier.pdf</span>
                        <i class="fas fa-times remove-button" id="remove-file"></i>
                    </div>
                </div>
                
                <!-- Bouton GPT principal visible -->
                <div class="gpt-main-button-container">
                    <button type="button" id="analyze-with-gpt-main" class="gpt-main-button">
                        <i class="fas fa-robot"></i> Analyser avec GPT
                    </button>
                    <span id="gpt-analyze-status" style="margin-left: 12px;"></span>
                </div>
                
                <div class="separator">
                    <div class="line"></div>
                    <div class="text">OU</div>
                    <div class="line"></div>
                </div>
                
                <div class="textarea-container">
                    <textarea id="job-description-text" class="form-control" placeholder="Collez le texte de votre fiche de poste ici pour une analyse automatique..."></textarea>
                    <button type="button" id="analyze-job-text" class="analyze-button" title="Analyser">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <!-- Indicateur de chargement amélioré -->
                <div id="analysis-loader" class="loader-container">
                    <div class="loader"></div>
                    <span class="loader-text">Analyse en cours...</span>
                </div>
                
                <!-- Résultats d'analyse améliorés -->
                <div id="job-info-container" class="job-info-container" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> Informations extraites</h3>
                    
                    <div class="info-grid">
                        <div class="info-group">
                            <label class="info-label">Titre du poste</label>
                            <div id="job-title-value" class="info-value">Non spécifié</div>
                        </div>
                        
                        <div class="info-group">
                            <label class="info-label">Type de contrat</label>
                            <div id="job-contract-value" class="info-value">Non spécifié</div>
                        </div>
                        
                        <div class="info-group">
                            <label class="info-label">Lieu</label>
                            <div id="job-location-value" class="info-value">Non spécifié</div>
                        </div>
                        
                        <div class="info-group">
                            <label class="info-label">Expérience requise</label>
                            <div id="job-experience-value" class="info-value">Non spécifié</div>
                        </div>
                        
                        <div class="info-group">
                            <label class="info-label">Formation</label>
                            <div id="job-education-value" class="info-value">Non spécifié</div>
                        </div>
                        
                        <div class="info-group">
                            <label class="info-label">Rémunération</label>
                            <div id="job-salary-value" class="info-value">Non spécifié</div>
                        </div>
                    </div>
                    
                    <div class="info-group full-width">
                        <label class="info-label">Compétences requises</label>
                        <div id="job-skills-value" class="info-value skills-container">Non spécifié</div>
                    </div>
                    
                    <div class="info-group full-width">
                        <label class="info-label">Responsabilités / Missions</label>
                        <div id="job-responsibilities-value" class="info-value">Non spécifié</div>
                    </div>
                    
                    <div class="info-group full-width">
                        <label class="info-label">Avantages</label>
                        <div id="job-benefits-value" class="info-value">Non spécifié</div>
                    </div>
                    
                    <div class="job-actions">
                        <div class="job-export-buttons">
                            <button type="button" class="btn btn-primary" onclick="window.location.href='client-questionnaire.html'">
                                <i class="fas fa-arrow-right"></i> Continuer avec ces informations
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Notification template (initialement caché) -->
    <div class="notification" id="notification" style="display: none;">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">Succès</div>
            <div class="notification-message">Opération réussie</div>
        </div>
        <div class="notification-close">
            <i class="fas fa-times"></i>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../assets/js/parser.js"></script>
    <script src="../js/pdf-cleaner.js"></script>
    <script src="../js/job-parser-api.js"></script>
    <script src="../scripts/gpt-autoloader.js"></script>
    
    <script>
        // Fonction pour afficher les notifications
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationIcon = notification.querySelector('.notification-icon i');
            const notificationTitle = notification.querySelector('.notification-title');
            const notificationMessage = notification.querySelector('.notification-message');
            
            // Définir le type de notification
            notification.className = 'notification';
            notification.classList.add(type);
            
            // Définir l'icône en fonction du type
            notificationIcon.className = '';
            if (type === 'success') {
                notificationIcon.className = 'fas fa-check-circle';
                notificationTitle.textContent = 'Succès';
            } else if (type === 'error') {
                notificationIcon.className = 'fas fa-exclamation-circle';
                notificationTitle.textContent = 'Erreur';
            } else if (type === 'info') {
                notificationIcon.className = 'fas fa-info-circle';
                notificationTitle.textContent = 'Information';
            }
            
            // Définir le message
            notificationMessage.textContent = message;
            
            // Afficher la notification
            notification.style.display = 'flex';
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Masquer la notification après un délai
            const timeout = setTimeout(() => {
                hideNotification();
            }, 5000);
            
            // Permettre de fermer la notification manuellement
            const closeButton = notification.querySelector('.notification-close');
            closeButton.addEventListener('click', () => {
                clearTimeout(timeout);
                hideNotification();
            });
            
            function hideNotification() {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }
        }
        
        // Exposer la fonction showNotification globalement
        window.showNotification = showNotification;
        
        // Gestion de la zone de drop pour les fichiers
        const dropZone = document.getElementById('job-drop-zone');
        const fileInput = document.getElementById('job-file-input');
        const fileBadge = document.getElementById('file-badge');
        const fileName = document.getElementById('file-name');
        const removeFile = document.getElementById('remove-file');
        
        if (dropZone && fileInput) {
            // Prévenir le comportement par défaut pour permettre le drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // Ajouter/supprimer la classe active pendant le drag
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, function() {
                    this.classList.add('drag-active');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, function() {
                    this.classList.remove('drag-active');
                });
            });
            
            // Gérer le drop de fichier
            dropZone.addEventListener('drop', function(e) {
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // Gérer la sélection de fichier par le bouton
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    handleFile(this.files[0]);
                }
            });
            
            // Gérer la suppression du fichier
            if (removeFile) {
                removeFile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    fileInput.value = '';
                    fileBadge.style.display = 'none';
                    showNotification('Fichier supprimé', 'info');
                });
            }
        }
        
        // Fonction pour gérer le fichier sélectionné
        function handleFile(file) {
            if (!file || !fileBadge || !fileName) return;
            
            // Vérifier la taille du fichier (max 5MB)
            const maxSizeInBytes = 5 * 1024 * 1024; // 5MB
            
            if (file.size > maxSizeInBytes) {
                showNotification('Le fichier est trop volumineux. La taille maximale est de 5MB.', 'error');
                return;
            }
            
            // Vérifier le type de fichier
            const acceptedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain'
            ];
            
            if (!acceptedTypes.includes(file.type) && !file.name.match(/\.(pdf|docx?|txt)$/i)) {
                showNotification('Format de fichier non supporté. Veuillez utiliser PDF, DOC, DOCX ou TXT.', 'error');
                return;
            }
            
            // Afficher le badge de fichier
            fileName.textContent = file.name;
            fileBadge.style.display = 'inline-flex';
            showNotification('Fichier sélectionné avec succès', 'success');
            
            // Focus sur le bouton d'analyse GPT
            const gptButton = document.getElementById('analyze-with-gpt-main');
            if (gptButton) {
                gptButton.focus();
                
                // Animation pour attirer l'attention
                gptButton.classList.add('pulse');
                setTimeout(() => {
                    gptButton.classList.remove('pulse');
                }, 1000);
            }
        }
    </script>
</body>
</html>
