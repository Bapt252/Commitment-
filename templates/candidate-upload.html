<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexten - Chargement de CV</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Script de transfert de données -->
    <script src="../static/scripts/data-transfer-service.js"></script>
    <style>
        /* Styles CSS existants (inchangés) */
        :root {
            --primary-color: #7c4dff;
            --primary-light: #e8e3ff;
            --gray-light: #f5f5f5;
            --gray-dark: #666;
            --text-color: #333;
            --border-radius: 8px;
            --success-color: #4CAF50;
            --success-light: #E8F5E9;
            --warning-color: #FF9800;
            --warning-light: #FFF3E0;
            --error-color: #F44336;
            --error-light: #FFEBEE;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-color);
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .logo {
            color: var(--text-color);
            font-weight: 700;
            text-decoration: none;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .logo span {
            color: var(--primary-color);
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-left: 4px;
        }

        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        .profile-btn {
            background-color: #f5f5f5;
            color: var(--primary-color);
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .profile-btn:hover {
            background-color: #e8e3ff;
        }

        .main-content {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            text-align: center;
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--gray-dark);
            text-align: center;
            margin-bottom: 2rem;
            max-width: 600px;
            line-height: 1.5;
        }

        .ai-badge {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .questionnaire-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            margin-top: 1rem;
        }

        .stepper {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2.5rem;
            padding: 0 3rem;
        }

        .stepper-line {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 3px;
            background-color: #e0e0e0;
            width: 100%;
            z-index: 1;
        }

        .stepper-progress {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 3px;
            background-color: var(--primary-color);
            width: 0%;
            z-index: 1;
            transition: width 0.3s;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background-color: white;
            border: 2px solid #e0e0e0;
            color: #9e9e9e;
        }

        .step.active .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-top: 0.25rem;
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .form-section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #6a3de8;
        }

        .btn-outline {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
        }

        /* Styles spécifiques pour l'upload de CV */
        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .upload-container:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--primary-light);
            border-radius: var(--border-radius);
            width: 100%;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-size {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .remove-file {
            color: #d32f2f;
            cursor: pointer;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .remove-file:hover {
            color: #b71c1c;
        }

        .loading-indicator {
            display: none;
            margin-top: 1.5rem;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .parsed-data {
            display: none;
            margin-top: 2rem;
            width: 100%;
        }

        .parsed-data-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th, .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            text-align: left;
            line-height: 1.4;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table th {
            font-weight: 600;
            color: var(--primary-color);
            background-color: var(--primary-light);
            width: 30%;
        }

        .detected {
            color: var(--text-color);
        }

        .not-detected {
            color: #999;
            font-style: italic;
        }

        .success-message {
            display: none;
            background-color: var(--success-light);
            color: var(--success-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        .or-divider {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 1.5rem 0;
        }

        .or-divider::before, .or-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .or-divider-text {
            margin: 0 1rem;
            color: var(--gray-dark);
            font-size: 0.875rem;
        }

        .error-message {
            display: none;
            background-color: var(--error-light);
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--error-color);
            margin-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Styles pour le chat AI */
        .chat-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        
        .chat-button:hover {
            background-color: #6a3de8;
        }
        
        .chat-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .chat-modal {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background-color: var(--primary-color);
            color: white;
        }
        
        .chat-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .chat-close:hover {
            opacity: 0.8;
        }
        
        .chat-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .chat-document {
            width: 300px;
            padding: 1rem;
            border-right: 1px solid #eee;
            background-color: #f8f9fa;
            overflow-y: auto;
        }
        
        .chat-document-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-document-data {
            max-height: calc(80vh - 130px);
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            background-color: white;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        .chat-messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .message.user {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        .message.assistant {
            align-self: flex-start;
            background-color: #f0f0f0;
            color: var(--text-color);
            border-bottom-left-radius: 0.25rem;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: #f0f0f0;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            color: var(--gray-dark);
            font-style: italic;
            margin-top: 0.5rem;
            display: none;
        }
        
        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #eee;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 1.5rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            border-color: var(--primary-color);
        }
        
        .chat-send {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chat-send:hover {
            background-color: #6a3de8;
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0 1rem 1rem;
        }
        
        .suggestion {
            background-color: #f0f0f0;
            color: var(--gray-dark);
            border: none;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        /* Style du conteneur API Key */
        .api-key-container {
            margin-bottom: 1.5rem;
            display: none;
            width: 100%;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px dashed #ddd;
        }
        
        .api-key-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .api-key-description {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-bottom: 1rem;
        }
        
        .api-key-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }
        
        .api-key-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .api-key-save {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        .api-key-cancel {
            background-color: white;
            color: var(--gray-dark);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Styles pour les tags dans les compétences */
        .skills-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .skill-tag {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border-radius: 1rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }

        .skill-tag i {
            margin-right: 0.3rem;
            font-size: 0.75rem;
        }

        /* Styles pour la liste des logiciels */
        .software-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .software-item {
            background-color: #f0f2f5;
            color: var(--gray-dark);
            border-radius: 1rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
        }

        .software-item i {
            margin-right: 0.3rem;
            font-size: 0.75rem;
        }

        /* Styles pour les langues */
        .language-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .language-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background-color: #f8f9fa;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            min-width: 120px;
        }

        .language-name {
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .language-name i {
            margin-right: 0.3rem;
            color: var(--primary-color);
        }

        .language-level {
            font-size: 0.875rem;
            color: var(--gray-dark);
            padding-left: 1.2rem;
        }

        /* Styles pour l'expérience */
        .experience-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .experience-item {
            padding: 0.75rem;
            border-left: 3px solid var(--primary-light);
            background-color: #f8f9fa;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            transition: all 0.2s ease;
        }

        .experience-item:hover {
            border-left-color: var(--primary-color);
            background-color: var(--primary-light);
            transform: translateX(3px);
        }

        .experience-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--primary-color);
        }

        .experience-company {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .experience-company i {
            margin-right: 0.3rem;
            font-size: 0.8rem;
            color: var(--gray-dark);
        }

        .experience-date {
            font-size: 0.875rem;
            color: var(--gray-dark);
            display: flex;
            align-items: center;
        }

        .experience-date i {
            margin-right: 0.3rem;
            font-size: 0.8rem;
        }

        /* Styles pour la notification d'information */
        .info-box {
            background-color: var(--primary-light);
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-dark);
            line-height: 1.4;
        }

        .info-box i {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-top: 0.1rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .stepper {
                padding: 0 1rem;
            }
            
            .questionnaire-card {
                padding: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn {
                width: 100%;
            }
            
            .chat-body {
                flex-direction: column;
            }
            
            .chat-document {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .data-table th {
                width: 40%;
            }

            .language-list {
                gap: 0.5rem;
            }

            .language-item {
                min-width: auto;
                width: calc(50% - 0.25rem);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">
            nex<span>ten</span><div class="logo-badge">10</div>
        </a>
        
        <nav class="nav">
            <a href="index.html" class="nav-link">Accueil</a>
            <button class="profile-btn">
                <i class="fas fa-user"></i>
                Mon profil
            </button>
        </nav>
    </header>

    <div class="main-content">
        <h1 class="page-title">CHARGEZ VOTRE CV</h1>
        <p class="page-subtitle">Gagnez du temps en laissant notre système analyser votre CV pour pré-remplir votre profil.</p>
        
        <span class="ai-badge">
            <i class="fas fa-robot"></i>
            Parsing assisté par l'IA
        </span>
        
        <div class="questionnaire-card">
            <div class="stepper">
                <div class="stepper-line"></div>
                <div class="stepper-progress"></div>
                
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-label">Parsing CV</div>
                </div>
                
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-label">Questionnaire</div>
                </div>
                
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Matching</div>
                </div>
            </div>
            
            <h2 class="form-section-title">Analyse automatique de votre CV</h2>
            
            <p>Uploadez votre CV pour que nous puissions extraire automatiquement vos informations et compétences. Cela permettra d'optimiser vos chances de matching avec les offres qui vous correspondent.</p>
            
            <!-- Conteneur pour la clé API (initialement caché) -->
            <div class="api-key-container" id="apiKeyContainer">
                <div class="api-key-title">Clé API OpenAI (facultatif)</div>
                <div class="api-key-description">
                    Pour utiliser le parsing avancé sur GitHub Pages, vous pouvez fournir votre propre clé API OpenAI.
                    Votre clé ne sera jamais stockée sur nos serveurs et restera uniquement dans votre navigateur.
                </div>
                <input type="text" class="api-key-input" id="apiKeyInput" placeholder="sk-...">
                <div class="api-key-actions">
                    <button class="api-key-cancel" id="apiKeyCancelBtn">Annuler</button>
                    <button class="api-key-save" id="apiKeySaveBtn">Enregistrer</button>
                </div>
            </div>
            
            <div class="upload-container" id="uploadContainer">
                <i class="fas fa-file-upload upload-icon"></i>
                <p class="upload-text">Glissez votre CV ici ou cliquez pour parcourir</p>
                <p class="upload-hint">Formats acceptés: PDF, DOCX, DOC, JPG, PNG (taille max: 10MB)</p>
                <input type="file" class="file-input" id="cvFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
            </div>
            
            <div class="file-info" id="fileInfo">
                <div class="file-name">
                    <i class="fas fa-file-alt"></i>
                    <span id="fileName">CV_Nom_Prenom.pdf</span>
                </div>
                <div class="file-size" id="fileSize">1.2 MB</div>
                <div class="remove-file" id="removeFile">
                    <i class="fas fa-trash-alt"></i>
                    Supprimer
                </div>
            </div>
            
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div>
                <p class="loading-text">Analyse en cours, veuillez patienter...</p>
            </div>
            
            <div class="parsed-data" id="parsedData">
                <div class="parsed-data-title">
                    <i class="fas fa-check-circle"></i>
                    Informations extraites de votre CV
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <p>Ces informations ont été extraites automatiquement. Vous pourrez les modifier et les compléter lors de l'étape suivante.</p>
                </div>
                
                <table class="data-table">
                    <tr>
                        <th>Nom complet</th>
                        <td id="parsedName" class="detected">John Doe</td>
                    </tr>
                    <tr>
                        <th>Titre de poste actuel</th>
                        <td id="parsedJobTitle" class="detected">Développeur Front-End</td>
                    </tr>
                    <tr>
                        <th>Email</th>
                        <td id="parsedEmail" class="detected">john.doe@exemple.com</td>
                    </tr>
                    <tr>
                        <th>Téléphone</th>
                        <td id="parsedPhone" class="detected">+33 6 12 34 56 78</td>
                    </tr>
                    <tr>
                        <th>Compétences détectées</th>
                        <td id="parsedSkills">
                            <div class="skills-tags">
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>HTML</span>
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>CSS</span>
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>JavaScript</span>
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>React</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Logiciels maîtrisés</th>
                        <td id="parsedSoftware">
                            <div class="software-list">
                                <span class="software-item"><i class="fas fa-laptop-code"></i>Visual Studio Code</span>
                                <span class="software-item"><i class="fas fa-pencil-ruler"></i>Adobe Photoshop</span>
                                <span class="software-item"><i class="fas fa-paint-brush"></i>Figma</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Langues</th>
                        <td id="parsedLanguages">
                            <div class="language-list">
                                <div class="language-item">
                                    <span class="language-name"><i class="fas fa-language"></i>Français</span>
                                    <span class="language-level">Natif</span>
                                </div>
                                <div class="language-item">
                                    <span class="language-name"><i class="fas fa-language"></i>Anglais</span>
                                    <span class="language-level">Courant</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Expérience professionnelle</th>
                        <td id="parsedExperience">
                            <div class="experience-list">
                                <div class="experience-item">
                                    <div class="experience-title">Développeur Front-End</div>
                                    <div class="experience-company"><i class="fas fa-building"></i>TechCorp</div>
                                    <div class="experience-date"><i class="fas fa-calendar-alt"></i>Jan 2022 - Présent</div>
                                </div>
                                <div class="experience-item">
                                    <div class="experience-title">Développeur Web Junior</div>
                                    <div class="experience-company"><i class="fas fa-building"></i>WebAgency</div>
                                    <div class="experience-date"><i class="fas fa-calendar-alt"></i>Mar 2020 - Déc 2021</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- Bouton pour ouvrir le chat avec l'IA -->
                <button class="chat-button" id="openChatBtn">
                    <i class="fas fa-comment-dots"></i>
                    Discuter de mon CV avec l'IA
                </button>
            </div>
            
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                Analyse terminée avec succès!
            </div>
            
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Une erreur est survenue lors de l'analyse.</span>
            </div>
            
            <div class="or-divider">
                <div class="or-divider-text">OU</div>
            </div>
            
            <p style="text-align: center; margin-bottom: 1rem;">Vous préférez remplir manuellement votre profil ?</p>
            
            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="skipBtn">Passer cette étape</button>
                <button type="button" class="btn btn-primary" id="nextBtn">Continuer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de chat avec l'IA -->
    <div class="chat-modal-overlay" id="chatModalOverlay">
        <div class="chat-modal">
            <div class="chat-header">
                <h3><i class="fas fa-robot"></i> Assistant d'analyse de CV</h3>
                <button class="chat-close" id="closeChatBtn">&times;</button>
            </div>
            <div class="chat-body">
                <div class="chat-document">
                    <div class="chat-document-title">
                        <i class="fas fa-file-alt"></i>
                        Données extraites
                    </div>
                    <div class="chat-document-data" id="chatDocumentData">
                        <!-- Les données extraites du CV seront affichées ici -->
                    </div>
                </div>
                <div class="chat-messages-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            Bonjour ! Je suis votre assistant IA. J'ai analysé votre CV et je peux répondre à vos questions ou vous fournir des conseils pour l'améliorer. Comment puis-je vous aider ?
                        </div>
                    </div>
                    <div class="typing-indicator" id="chatTypingIndicator">
                        L'assistant est en train d'écrire...
                    </div>
                    <div class="suggestions">
                        <button class="suggestion">Comment puis-je améliorer mon CV ?</button>
                        <button class="suggestion">Quelles sont mes forces ?</button>
                        <button class="suggestion">Quelles compétences devrais-je développer ?</button>
                        <button class="suggestion">Quels types d'emploi me correspondent ?</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Posez une question sur votre CV...">
                        <button class="chat-send" id="chatSendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="cv-parser-integration.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Éléments DOM pour l'upload de CV
            const uploadContainer = document.getElementById('uploadContainer');
            const fileInput = document.getElementById('cvFile');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const removeFile = document.getElementById('removeFile');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const parsedData = document.getElementById('parsedData');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const nextBtn = document.getElementById('nextBtn');
            const skipBtn = document.getElementById('skipBtn');
            const stepperProgress = document.querySelector('.stepper-progress');
            const openChatBtn = document.getElementById('openChatBtn');
            
            // Éléments DOM pour la clé API
            const apiKeyContainer = document.getElementById('apiKeyContainer');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKeySaveBtn = document.getElementById('apiKeySaveBtn');
            const apiKeyCancelBtn = document.getElementById('apiKeyCancelBtn');
            
            // Éléments DOM pour le chat
            const chatModalOverlay = document.getElementById('chatModalOverlay');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatTypingIndicator = document.getElementById('chatTypingIndicator');
            const chatDocumentData = document.getElementById('chatDocumentData');
            const suggestionBtns = document.querySelectorAll('.suggestion');
            
            // Variables pour le chat
            let chatHistory = [];
            let documentData = null;
            // Variable pour stocker les données complètes du parser CV
            let completeParserData = null;
            
            // URL de base pour les API - Détection automatique de l'environnement
            const isGitHubPages = window.location.hostname.includes('github.io');
            
            // Si sur GitHub Pages, afficher le conteneur de clé API
            if (isGitHubPages) {
                apiKeyContainer.style.display = 'block';
                
                // Vérifier si une clé API est déjà stockée
                const storedApiKey = localStorage.getItem('openai_api_key');
                if (storedApiKey) {
                    apiKeyInput.value = storedApiKey;
                }
            }
            
            // Événements pour la gestion de la clé API
            apiKeySaveBtn.addEventListener('click', function() {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey && apiKey.startsWith('sk-')) {
                    localStorage.setItem('openai_api_key', apiKey);
                    apiKeyContainer.style.display = 'none';
                    
                    // Réinitialiser l'intégration avec la nouvelle clé API
                    initCVParser();
                    
                    // Afficher un message de succès
                    showSuccessMessage('Clé API enregistrée avec succès!');
                } else {
                    showErrorMessage('Veuillez entrer une clé API OpenAI valide commençant par "sk-"');
                }
            });
            
            apiKeyCancelBtn.addEventListener('click', function() {
                apiKeyContainer.style.display = 'none';
            });
            
            // Fonction pour initialiser le parser CV avec les options appropriées
            function initCVParser() {
                const apiKey = localStorage.getItem('openai_api_key');
                const useDirectOpenAI = isGitHubPages && apiKey;
                
                // URL de l'API ou null pour GitHub Pages
                const API_BASE_URL = isGitHubPages ? null : 'http://localhost:5051/api';
                
                console.log('Environnement détecté:', isGitHubPages ? 'GitHub Pages' : 'Local/Dev');
                
                // Initialiser l'intégration du service de parsing avec auto-détection
                window.cvParser = new CVParserIntegration({
                    apiUrl: API_BASE_URL,
                    useAsync: false,
                    forceMock: isGitHubPages && !apiKey, // Forcer le mode mock sur GitHub Pages sans clé API
                    useDirectOpenAI: useDirectOpenAI,    // Utiliser l'API OpenAI directement si clé disponible
                    openAIKey: apiKey,                   // Clé API OpenAI (si disponible)
                    onParsingStart: () => {
                        loadingIndicator.style.display = 'flex';
                        errorMessage.style.display = 'none';
                        parsedData.style.display = 'none';
                        stepperProgress.style.width = '33.33%';
                    },
                    onParsingComplete: (data) => {
                        loadingIndicator.style.display = 'none';
                        
                        if (data && data.data) {
                            // Stocker les données complètes du parser
                            completeParserData = data;
                            const extractedData = data.data;
                            
                            // Mettre à jour l'interface avec les données
                            populateDataTable(extractedData);
                            
                            // Afficher les résultats
                            parsedData.style.display = 'block';
                            showSuccessMessage('Analyse terminée avec succès!');
                        } else {
                            // Gérer l'erreur
                            showErrorMessage('Échec de l\'analyse du CV.');
                        }
                    },
                    onParsingError: (error) => {
                        loadingIndicator.style.display = 'none';
                        showErrorMessage('Erreur lors de l\'analyse: ' + error.message);
                    }
                });
            }
            
            // Initialiser le CVParser
            initCVParser();
            
            // Par défaut, le bouton Continuer est activé
            nextBtn.disabled = false;
            
            // Mise à jour de la barre de progression
            stepperProgress.style.width = '0%';
            
            // Événements pour l'upload de CV
            uploadContainer.addEventListener('click', function() {
                fileInput.click();
            });
            
            uploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#7c4dff';
                this.style.backgroundColor = '#e8e3ff';
            });
            
            uploadContainer.addEventListener('dragleave', function() {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = 'transparent';
            });
            
            uploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
                
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = 'transparent';
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    handleFile(this.files[0]);
                }
            });
            
            removeFile.addEventListener('click', function() {
                resetFileUpload();
            });
            
            skipBtn.addEventListener('click', function() {
                // Aucun CV chargé, on passe à l'étape suivante sans données
                localStorage.removeItem('parsedCvData');
                window.location.href = 'candidate-questionnaire.html';
            });
            
            nextBtn.addEventListener('click', function() {
                if (fileInfo.style.display === 'flex' && parsedData.style.display === 'block') {
                    if (completeParserData) {
                        // Utiliser le service de transfert de données si disponible
                        if (window.DataTransferService) {
                            window.DataTransferService.storeData(completeParserData);
                        } else {
                            // Fallback - Ancien comportement
                            localStorage.setItem('parsedCvData', JSON.stringify(completeParserData));
                        }
                        console.log("Données CV complètes stockées pour pré-remplissage:", completeParserData);
                    } else {
                        // Créer un objet de données à partir des informations affichées
                        const displayedData = {
                            data: {
                                personal_info: {
                                    name: document.getElementById('parsedName').textContent,
                                    email: document.getElementById('parsedEmail').textContent,
                                    phone: document.getElementById('parsedPhone').textContent
                                },
                                current_position: document.getElementById('parsedJobTitle').textContent,
                                skills: Array.from(document.querySelectorAll('#parsedSkills .skill-tag')).map(tag => tag.textContent.replace(/^./, '')),
                                software: Array.from(document.querySelectorAll('#parsedSoftware .software-item')).map(item => item.textContent.replace(/^./, '')),
                                languages: Array.from(document.querySelectorAll('#parsedLanguages .language-item')).map(item => {
                                    return {
                                        language: item.querySelector('.language-name')?.textContent.replace(/^./, '') || '',
                                        level: item.querySelector('.language-level')?.textContent || ''
                                    };
                                }),
                                work_experience: Array.from(document.querySelectorAll('#parsedExperience .experience-item')).map(item => {
                                    const dateText = item.querySelector('.experience-date')?.textContent.replace(/^./, '') || '';
                                    const dateParts = dateText.split(' - ');
                                    return {
                                        title: item.querySelector('.experience-title')?.textContent || '',
                                        company: item.querySelector('.experience-company')?.textContent.replace(/^./, '') || '',
                                        start_date: dateParts[0] || '',
                                        end_date: dateParts[1] || ''
                                    };
                                })
                            }
                        };
                        
                        // S'assurer que le titre du poste est également accessible au niveau racine
                        displayedData.current_position = displayedData.data.current_position;
                        
                        // Utiliser le service de transfert de données si disponible
                        if (window.DataTransferService) {
                            window.DataTransferService.storeData(displayedData);
                        } else {
                            // Fallback - Ancien comportement
                            localStorage.setItem('parsedCvData', JSON.stringify(displayedData));
                        }
                        console.log("Données CV générées et stockées pour pré-remplissage:", displayedData);
                    }
                } else {
                    // Aucun CV analysé, on continue sans données
                    localStorage.removeItem('parsedCvData');
                }
                
                // Redirection vers l'étape suivante dans tous les cas
                window.location.href = 'candidate-questionnaire.html';
            });
            
            // Événements pour le chat
            openChatBtn.addEventListener('click', function() {
                // Afficher le chat modal
                chatModalOverlay.style.display = 'flex';
                
                // Préparer les données du CV pour le chat
                const cvData = {
                    name: document.getElementById('parsedName').textContent,
                    jobTitle: document.getElementById('parsedJobTitle').textContent,
                    email: document.getElementById('parsedEmail').textContent,
                    phone: document.getElementById('parsedPhone').textContent,
                    skills: Array.from(document.querySelectorAll('#parsedSkills .skill-tag')).map(tag => tag.textContent.replace(/^./, '')), // Enlever l'icône
                    software: Array.from(document.querySelectorAll('#parsedSoftware .software-item')).map(item => item.textContent.replace(/^./, '')),
                    languages: Array.from(document.querySelectorAll('#parsedLanguages .language-item')).map(item => {
                        return {
                            language: item.querySelector('.language-name').textContent.replace(/^./, ''),
                            level: item.querySelector('.language-level').textContent
                        }
                    }),
                    experience: Array.from(document.querySelectorAll('#parsedExperience .experience-item')).map(item => {
                        return {
                            title: item.querySelector('.experience-title').textContent,
                            company: item.querySelector('.experience-company').textContent.replace(/^./, ''),
                            date: item.querySelector('.experience-date').textContent.replace(/^./, '')
                        }
                    })
                };
                
                // Stocker les données pour le chat
                documentData = cvData;
                
                // Afficher les données dans le panneau latéral
                chatDocumentData.textContent = JSON.stringify(cvData, null, 2);
                
                // Initialiser l'historique du chat avec un message système
                chatHistory = [
                    {
                        role: "system",
                        content: `Tu es un assistant spécialisé dans l'analyse de CV. Tu dois aider le candidat à comprendre les forces et faiblesses de son CV, et lui donner des conseils pour l'améliorer. Voici les données extraites de son CV: ${JSON.stringify(cvData)}`
                    }
                ];
                
                // Faire défiler vers le bas pour voir les messages
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Mettre le focus sur le champ de saisie
                chatInput.focus();
            });
            
            closeChatBtn.addEventListener('click', function() {
                chatModalOverlay.style.display = 'none';
            });
            
            // Fermer le chat en cliquant en dehors
            chatModalOverlay.addEventListener('click', function(e) {
                if (e.target === chatModalOverlay) {
                    chatModalOverlay.style.display = 'none';
                }
            });
            
            // Envoyer un message en appuyant sur Entrée
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Envoyer un message en cliquant sur le bouton
            chatSendBtn.addEventListener('click', sendChatMessage);
            
            // Gérer les suggestions
            suggestionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    chatInput.value = this.textContent;
                    sendChatMessage();
                });
            });
            
            // Fonction pour envoyer un message au chat
            async function sendChatMessage() {
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // Ajouter le message de l'utilisateur à l'interface
                addChatMessage(message, 'user');
                
                // Vider le champ de saisie
                chatInput.value = '';
                
                // Afficher l'indicateur de frappe
                chatTypingIndicator.style.display = 'block';
                
                // Délai simulé pour une expérience utilisateur plus naturelle
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                try {
                    // Vérifier si une clé API OpenAI est disponible
                    const apiKey = localStorage.getItem('openai_api_key');
                    const useDirectOpenAI = isGitHubPages && apiKey;
                    
                    if (useDirectOpenAI) {
                        // Appeler directement l'API OpenAI pour le chat
                        try {
                            const prompt = `
                            Tu es un assistant spécialisé dans l'analyse de CV et les conseils en recherche d'emploi.
                            Les données du CV du candidat sont les suivantes:
                            ${JSON.stringify(documentData, null, 2)}

                            Historique de conversation:
                            ${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

                            Question du candidat: ${message}

                            Réponds de manière claire, concise et professionnelle. Donne des conseils personnalisés en fonction des informations du CV.
                            `;

                            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify({
                                    model: 'gpt-3.5-turbo',
                                    messages: [
                                        {
                                            role: 'user',
                                            content: prompt
                                        }
                                    ],
                                    temperature: 0.7,
                                    max_tokens: 800
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Erreur API: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            const aiResponse = data.choices[0].message.content;
                            
                            // Masquer l'indicateur de frappe
                            chatTypingIndicator.style.display = 'none';
                            
                            // Ajouter les messages à l'historique
                            chatHistory.push({ role: 'user', content: message });
                            chatHistory.push({ role: 'assistant', content: aiResponse });
                            
                            // Ajouter la réponse à l'interface
                            addChatMessage(aiResponse, 'assistant');
                            
                        } catch (apiError) {
                            console.error('Erreur lors de l\'appel à l\'API OpenAI:', apiError);
                            
                            // Masquer l'indicateur de frappe
                            chatTypingIndicator.style.display = 'none';
                            
                            // Utiliser une réponse de secours
                            const backupResponse = generateChatResponse(message, documentData);
                            addChatMessage(backupResponse, 'assistant');
                        }
                    } else {
                        // Sur GitHub Pages sans clé API ou en local sans backend, utiliser une réponse simulée
                        // Masquer l'indicateur de frappe
                        chatTypingIndicator.style.display = 'none';
                        
                        // Générer une réponse simulée
                        const simulatedResponse = generateChatResponse(message, documentData);
                        addChatMessage(simulatedResponse, 'assistant');
                    }
                } catch (error) {
                    console.error('Erreur générale du chat:', error);
                    
                    // Masquer l'indicateur de frappe
                    chatTypingIndicator.style.display = 'none';
                    
                    // Message d'erreur générique
                    addChatMessage("Désolé, je rencontre des difficultés techniques. Comment puis-je vous aider autrement ?", 'assistant');
                }
            }
            
            // Fonction pour ajouter un message au chat
            function addChatMessage(content, role) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(role);
                messageElement.textContent = content;
                
                chatMessages.appendChild(messageElement);
                
                // Faire défiler vers le bas
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Ajouter le message à l'historique
                if (!chatHistory.some(msg => msg.role === role && msg.content === content)) {
                    chatHistory.push({
                        role: role,
                        content: content
                    });
                }
            }
            
            // Fonction pour afficher un message de succès
            function showSuccessMessage(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                
                // Masquer le message après 4 secondes
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 4000);
            }
            
            // Fonction pour afficher un message d'erreur
            function showErrorMessage(message) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
                
                // Masquer le message après 5 secondes
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
            
            // Fonction pour générer une réponse de chat basée sur les données du CV
            function generateChatResponse(message, cvData) {
                const lowerMessage = message.toLowerCase();
                
                // Réponses prédéfinies basées sur des mots-clés
                if (lowerMessage.includes('améliorer') || lowerMessage.includes('amélioration')) {
                    return `D'après l'analyse de votre CV, voici quelques conseils pour l'améliorer :\n\n1. Ajoutez plus de détails sur vos réalisations en tant que ${cvData.jobTitle}\n2. Quantifiez vos résultats avec des chiffres précis\n3. Mettez davantage en avant vos compétences en ${cvData.skills[0]}\n4. Ajoutez une section sur vos certifications professionnelles`;
                } 
                else if (lowerMessage.includes('force') || lowerMessage.includes('point fort')) {
                    return `Vos principales forces basées sur votre CV sont :\n\n1. Votre expertise en ${cvData.skills.slice(0, 2).join(' et ')}\n2. Votre expérience significative en tant que ${cvData.experience[0]?.title || cvData.jobTitle}\n3. Votre maîtrise des logiciels ${cvData.software.slice(0, 2).join(' et ')}\n4. Vos compétences linguistiques, notamment en ${cvData.languages[0]?.language || 'langues étrangères'}`;
                }
                else if (lowerMessage.includes('compétence') || lowerMessage.includes('développer')) {
                    return `Pour compléter votre profil de ${cvData.jobTitle}, je vous suggère de développer ces compétences :\n\n1. Intelligence artificielle et machine learning\n2. DevOps et CI/CD\n3. Architecture cloud\n\nCes compétences sont très recherchées dans votre domaine et compléteraient bien votre expertise en ${cvData.skills[0]}.`;
                }
                else if (lowerMessage.includes('emploi') || lowerMessage.includes('poste') || lowerMessage.includes('travail')) {
                    return `Avec votre profil de ${cvData.jobTitle} et vos compétences en ${cvData.skills.slice(0, 3).join(', ')}, vous pourriez être un excellent candidat pour ces types de postes :\n\n1. Senior ${cvData.jobTitle}\n2. Lead Developer\n3. Architecte technique\n4. CTO dans une startup\n\nVotre expérience vous qualifie pour des postes à responsabilité.`;
                }
                else if (lowerMessage.includes('logiciel') || lowerMessage.includes('software') || lowerMessage.includes('outil')) {
                    return `Vous maîtrisez déjà de bons outils comme ${cvData.software.join(', ')}. Pour compléter votre profil technique, je vous suggère d'ajouter ces logiciels à votre expertise :\n\n1. ${cvData.jobTitle.includes('Front') ? 'Adobe XD et Sketch' : 'Docker et Kubernetes'}\n2. ${cvData.jobTitle.includes('Data') ? 'Tableau et Power BI' : 'Git et GitHub'}\n3. Des outils de gestion de projet comme Jira et Trello\n\nCes outils sont très demandés sur le marché du travail actuel.`;
                }
                else if (lowerMessage.includes('langue') || lowerMessage.includes('anglais')) {
                    return `Vos compétences linguistiques actuelles incluent ${cvData.languages.map(l => `${l.language} (${l.level})`).join(', ')}. Dans votre domaine, l'anglais technique est essentiel. Si ce n'est pas déjà le cas, je vous recommande :\n\n1. D'améliorer votre niveau d'anglais professionnel\n2. De suivre des formations techniques en anglais\n3. De participer à des communautés internationales dans votre domaine\n\nUn bon niveau d'anglais peut augmenter vos opportunités de carrière de 30%.`;
                }
                else {
                    return `Merci pour votre question. D'après votre CV, vous êtes ${cvData.name}, actuellement ${cvData.jobTitle} avec des compétences en ${cvData.skills.slice(0, 3).join(', ')}. Pour obtenir des conseils plus spécifiques, n'hésitez pas à me poser des questions sur l'amélioration de votre CV, vos forces, les compétences à développer, les logiciels à maîtriser, les langues importantes pour votre secteur ou les types d'emploi qui pourraient vous correspondre.`;
                }
            }
            
            // Fonction pour traiter le fichier CV
            async function handleFile(file) {
                // Liste étendue des types de fichiers acceptés
                const allowedTypes = [
                    'application/pdf',                                                // PDF
                    'application/msword',                                             // DOC
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  // DOCX
                    'image/jpeg',                                                     // JPG, JPEG
                    'image/png'                                                       // PNG
                ];
                
                // Vérification basée sur l'extension si le type MIME n'est pas reconnu
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'];
                
                let isAllowedType = allowedTypes.includes(file.type) || allowedExtensions.includes(fileExtension);
                
                if (!isAllowedType) {
                    showErrorMessage('Type de fichier non pris en charge. Veuillez charger un fichier PDF, DOC, DOCX, JPG ou PNG.');
                    return;
                }
                
                // Vérification de la taille du fichier (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showErrorMessage('La taille du fichier dépasse la limite de 10MB.');
                    return;
                }
                
                // Affichage des informations sur le fichier
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'flex';
                
                try {
                    // Utiliser le service de parsing CV via l'intégration
                    await window.cvParser.parseCV(file);
                } catch (error) {
                    console.error('Erreur lors du parsing:', error);
                    showErrorMessage('Erreur lors de l\'analyse: ' + error.message);
                }
            }
            
            // Fonction pour remplir le tableau de données
            function populateDataTable(data) {
                console.log("Données extraites:", data);
                
                // Extraire les données pertinentes
                let personalInfo = data.personal_info || {};
                let skills = data.skills || [];
                let software = data.software || [];
                let languages = data.languages || [];
                let experience = data.work_experience || [];
                let currentPosition = data.current_position || '';
                
                // Traiter le nom
                const nameElement = document.getElementById('parsedName');
                if (personalInfo.name) {
                    nameElement.textContent = personalInfo.name;
                    nameElement.className = 'detected';
                } else {
                    nameElement.textContent = 'Non détecté';
                    nameElement.className = 'not-detected';
                }
                
                // Traiter le titre de poste
                const jobTitleElement = document.getElementById('parsedJobTitle');
                let jobTitle = currentPosition;
                if (!jobTitle && experience && experience.length > 0 && experience[0].title) {
                    jobTitle = experience[0].title;
                }
                
                if (jobTitle) {
                    jobTitleElement.textContent = jobTitle;
                    jobTitleElement.className = 'detected';
                } else {
                    jobTitleElement.textContent = 'Non détecté';
                    jobTitleElement.className = 'not-detected';
                }
                
                // Traiter l'email
                const emailElement = document.getElementById('parsedEmail');
                if (personalInfo.email) {
                    emailElement.textContent = personalInfo.email;
                    emailElement.className = 'detected';
                } else {
                    emailElement.textContent = 'Non détecté';
                    emailElement.className = 'not-detected';
                }
                
                // Traiter le téléphone
                const phoneElement = document.getElementById('parsedPhone');
                if (personalInfo.phone) {
                    phoneElement.textContent = personalInfo.phone;
                    phoneElement.className = 'detected';
                } else {
                    phoneElement.textContent = 'Non détecté';
                    phoneElement.className = 'not-detected';
                }
                
                // Traiter les compétences avec des tags
                let skillsContainer = document.getElementById('parsedSkills');
                skillsContainer.innerHTML = '';
                let skillsTagsDiv = document.createElement('div');
                skillsTagsDiv.className = 'skills-tags';
                
                if (Array.isArray(skills) && skills.length > 0) {
                    skills.forEach(skill => {
                        if (skill && typeof skill === 'string') {
                            let skillTag = document.createElement('span');
                            skillTag.className = 'skill-tag';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-check-circle';
                            skillTag.appendChild(icon);
                            
                            skillTag.appendChild(document.createTextNode(skill));
                            skillsTagsDiv.appendChild(skillTag);
                        }
                    });
                } else if (typeof skills === 'string') {
                    skills.split(',').forEach(skill => {
                        let trimmedSkill = skill.trim();
                        if (trimmedSkill) {
                            let skillTag = document.createElement('span');
                            skillTag.className = 'skill-tag';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-check-circle';
                            skillTag.appendChild(icon);
                            
                            skillTag.appendChild(document.createTextNode(trimmedSkill));
                            skillsTagsDiv.appendChild(skillTag);
                        }
                    });
                } else if (skills && typeof skills === 'object') {
                    // Cas où skills pourrait être un objet avec des propriétés
                    Object.values(skills).flat().forEach(skill => {
                        if (typeof skill === 'string') {
                            let skillTag = document.createElement('span');
                            skillTag.className = 'skill-tag';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-check-circle';
                            skillTag.appendChild(icon);
                            
                            skillTag.appendChild(document.createTextNode(skill));
                            skillsTagsDiv.appendChild(skillTag);
                        }
                    });
                }
                
                if (skillsTagsDiv.children.length === 0) {
                    let skillTag = document.createElement('span');
                    skillTag.className = 'skill-tag not-detected';
                    skillTag.textContent = 'Non détecté';
                    skillsTagsDiv.appendChild(skillTag);
                }
                skillsContainer.appendChild(skillsTagsDiv);
                
                // Traiter les logiciels avec des items
                let softwareContainer = document.getElementById('parsedSoftware');
                softwareContainer.innerHTML = '';
                let softwareListDiv = document.createElement('div');
                softwareListDiv.className = 'software-list';
                
                if (Array.isArray(software) && software.length > 0) {
                    software.forEach(item => {
                        if (item && typeof item === 'string') {
                            let softwareItem = document.createElement('span');
                            softwareItem.className = 'software-item';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-laptop-code';
                            softwareItem.appendChild(icon);
                            
                            softwareItem.appendChild(document.createTextNode(item));
                            softwareListDiv.appendChild(softwareItem);
                        }
                    });
                } else if (typeof software === 'string') {
                    software.split(',').forEach(item => {
                        let trimmedItem = item.trim();
                        if (trimmedItem) {
                            let softwareItem = document.createElement('span');
                            softwareItem.className = 'software-item';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-laptop-code';
                            softwareItem.appendChild(icon);
                            
                            softwareItem.appendChild(document.createTextNode(trimmedItem));
                            softwareListDiv.appendChild(softwareItem);
                        }
                    });
                }
                
                if (softwareListDiv.children.length === 0) {
                    let softwareItem = document.createElement('span');
                    softwareItem.className = 'software-item not-detected';
                    softwareItem.textContent = 'Non détecté';
                    softwareListDiv.appendChild(softwareItem);
                }
                softwareContainer.appendChild(softwareListDiv);
                
                // Traiter les langues
                let languagesContainer = document.getElementById('parsedLanguages');
                languagesContainer.innerHTML = '';
                let languageListDiv = document.createElement('div');
                languageListDiv.className = 'language-list';
                
                if (Array.isArray(languages) && languages.length > 0) {
                    languages.forEach(lang => {
                        let languageItem = document.createElement('div');
                        languageItem.className = 'language-item';
                        
                        let languageName = document.createElement('span');
                        languageName.className = 'language-name';
                        
                        let icon = document.createElement('i');
                        icon.className = 'fas fa-language';
                        languageName.appendChild(icon);
                        
                        if (typeof lang === 'string') {
                            languageName.appendChild(document.createTextNode(lang));
                        } else if (lang.language) {
                            languageName.appendChild(document.createTextNode(lang.language));
                            
                            if (lang.level) {
                                let languageLevel = document.createElement('span');
                                languageLevel.className = 'language-level';
                                languageLevel.textContent = lang.level;
                                languageItem.appendChild(languageLevel);
                            }
                        }
                        
                        languageItem.appendChild(languageName);
                        languageListDiv.appendChild(languageItem);
                    });
                }
                
                if (languageListDiv.children.length === 0) {
                    let languageItem = document.createElement('div');
                    languageItem.className = 'language-item';
                    
                    let languageName = document.createElement('span');
                    languageName.className = 'language-name not-detected';
                    languageName.textContent = 'Non détecté';
                    
                    languageItem.appendChild(languageName);
                    languageListDiv.appendChild(languageItem);
                }
                languagesContainer.appendChild(languageListDiv);
                
                // Traiter l'expérience professionnelle
                let experienceContainer = document.getElementById('parsedExperience');
                experienceContainer.innerHTML = '';
                let experienceListDiv = document.createElement('div');
                experienceListDiv.className = 'experience-list';
                
                if (experience && Array.isArray(experience) && experience.length > 0) {
                    experience.forEach(exp => {
                        if (exp.title || exp.company) {
                            let experienceItem = document.createElement('div');
                            experienceItem.className = 'experience-item';
                            
                            if (exp.title) {
                                let experienceTitle = document.createElement('div');
                                experienceTitle.className = 'experience-title';
                                experienceTitle.textContent = exp.title;
                                experienceItem.appendChild(experienceTitle);
                            }
                            
                            if (exp.company) {
                                let experienceCompany = document.createElement('div');
                                experienceCompany.className = 'experience-company';
                                
                                let icon = document.createElement('i');
                                icon.className = 'fas fa-building';
                                experienceCompany.appendChild(icon);
                                
                                experienceCompany.appendChild(document.createTextNode(exp.company));
                                experienceItem.appendChild(experienceCompany);
                            }
                            
                            let dateText = '';
                            if (exp.start_date) {
                                dateText += formatDate(exp.start_date);
                            }
                            if (exp.end_date) {
                                dateText += ' - ' + (exp.end_date.toLowerCase() === 'present' ? 'Présent' : formatDate(exp.end_date));
                            }
                            
                            if (dateText) {
                                let experienceDate = document.createElement('div');
                                experienceDate.className = 'experience-date';
                                
                                let icon = document.createElement('i');
                                icon.className = 'fas fa-calendar-alt';
                                experienceDate.appendChild(icon);
                                
                                experienceDate.appendChild(document.createTextNode(dateText));
                                experienceItem.appendChild(experienceDate);
                            }
                            
                            experienceListDiv.appendChild(experienceItem);
                        }
                    });
                }
                
                if (experienceListDiv.children.length === 0) {
                    let experienceItem = document.createElement('div');
                    experienceItem.className = 'experience-item';
                    
                    let experienceTitle = document.createElement('div');
                    experienceTitle.className = 'experience-title not-detected';
                    experienceTitle.textContent = 'Non détecté';
                    
                    experienceItem.appendChild(experienceTitle);
                    experienceListDiv.appendChild(experienceItem);
                }
                experienceContainer.appendChild(experienceListDiv);
                
                // Stocker les données pour le chat
                documentData = {
                    name: document.getElementById('parsedName').textContent,
                    jobTitle: document.getElementById('parsedJobTitle').textContent,
                    email: document.getElementById('parsedEmail').textContent,
                    phone: document.getElementById('parsedPhone').textContent,
                    skills: Array.from(document.querySelectorAll('#parsedSkills .skill-tag')).map(tag => tag.textContent.replace(/^./, '')), // Enlever l'icône
                    software: Array.from(document.querySelectorAll('#parsedSoftware .software-item')).map(item => item.textContent.replace(/^./, '')),
                    languages: Array.from(document.querySelectorAll('#parsedLanguages .language-item')).map(item => {
                        return {
                            language: item.querySelector('.language-name')?.textContent.replace(/^./, '') || '',
                            level: item.querySelector('.language-level')?.textContent || ''
                        }
                    }),
                    experience: Array.from(document.querySelectorAll('#parsedExperience .experience-item')).map(item => {
                        return {
                            title: item.querySelector('.experience-title')?.textContent || '',
                            company: item.querySelector('.experience-company')?.textContent.replace(/^./, '') || '',
                            date: item.querySelector('.experience-date')?.textContent.replace(/^./, '') || ''
                        }
                    })
                };
            }
            
            // Fonction pour formater les dates
            function formatDate(dateStr) {
                if (!dateStr) return '';
                
                // Si le format est "YYYY-MM" ou "YYYY-MM-DD"
                if (/^\d{4}-\d{2}(-\d{2})?$/.test(dateStr)) {
                    const parts = dateStr.split('-');
                    const year = parts[0];
                    const month = parts[1];
                    const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
                    return `${months[parseInt(month) - 1]} ${year}`;
                }
                return dateStr;
            }
            
            function resetFileUpload() {
                fileInput.value = '';
                fileInfo.style.display = 'none';
                loadingIndicator.style.display = 'none';
                parsedData.style.display = 'none';
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
                stepperProgress.style.width = '0%';
                documentData = null;
                completeParserData = null;
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>