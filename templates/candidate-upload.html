<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 🚀 GITHUB PAGES INTEGRATION v6.3.1 - PARSING EXHAUSTIF FIXED -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="integration-id" content="github-pages-v631-exhaustive-parsing-fixed">
    <meta name="timestamp" content="2025-06-24T18:30:00Z">
    
    <title>Nexten - Chargement de CV - EXHAUSTIF v6.3.1 FIXED</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- PDF.js pour lecture PDF multi-pages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Mammoth.js pour parsing Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        /* Styles CSS identiques - DESIGN VIOLET CONSERVÉ */
        :root {
            --primary-color: #7c4dff;
            --primary-light: #e8e3ff;
            --gray-light: #f5f5f5;
            --gray-dark: #666;
            --text-color: #333;
            --border-radius: 8px;
            --success-color: #4CAF50;
            --success-light: #E8F5E9;
            --warning-color: #FF9800;
            --warning-light: #FFF3E0;
            --error-color: #F44336;
            --error-light: #FFEBEE;
            --universal-color: #2196F3;
            --universal-light: #E3F2FD;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-color);
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .logo {
            color: var(--text-color);
            font-weight: 700;
            text-decoration: none;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .logo span {
            color: var(--primary-color);
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-left: 4px;
        }

        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        .profile-btn {
            background-color: #f5f5f5;
            color: var(--primary-color);
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .profile-btn:hover {
            background-color: #e8e3ff;
        }

        .main-content {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            text-align: center;
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--gray-dark);
            text-align: center;
            margin-bottom: 2rem;
            max-width: 600px;
            line-height: 1.5;
        }

        .ai-badge {
            background: linear-gradient(135deg, #7c4dff, #536dfe);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .github-integration-status {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            margin: 0.75rem 0;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .questionnaire-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            margin-top: 1rem;
        }

        .stepper {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2.5rem;
            padding: 0 3rem;
        }

        .stepper-line {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 3px;
            background-color: #e0e0e0;
            width: 100%;
            z-index: 1;
        }

        .stepper-progress {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 3px;
            background-color: var(--primary-color);
            width: 0%;
            z-index: 1;
            transition: width 0.3s;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background-color: white;
            border: 2px solid #e0e0e0;
            color: #9e9e9e;
        }

        .step.active .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-top: 0.25rem;
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .form-section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #6a3de8;
        }

        .btn-outline {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
        }

        /* Styles upload de CV */
        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
            min-height: 200px;
        }

        .upload-container:hover {
            border-color: var(--universal-color);
            background-color: var(--universal-light);
        }

        .upload-container.dragover {
            border-color: var(--universal-color);
            background-color: var(--universal-light);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--universal-color);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--universal-light);
            border-radius: var(--border-radius);
            width: 100%;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-size {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .remove-file {
            color: #d32f2f;
            cursor: pointer;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .remove-file:hover {
            color: #b71c1c;
        }

        .loading-indicator {
            display: none;
            margin-top: 1.5rem;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--universal-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .parsed-data {
            display: none;
            margin-top: 2rem;
            width: 100%;
        }

        .parsed-data-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: var(--universal-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th, .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            text-align: left;
            line-height: 1.4;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table th {
            font-weight: 600;
            color: var(--universal-color);
            background-color: var(--universal-light);
            width: 30%;
        }

        .detected {
            color: var(--text-color);
        }

        .not-detected {
            color: #999;
            font-style: italic;
        }

        .success-message {
            display: none;
            background-color: var(--success-light);
            color: var(--success-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        .or-divider {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 1.5rem 0;
        }

        .or-divider::before, .or-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .or-divider-text {
            margin: 0 1rem;
            color: var(--gray-dark);
            font-size: 0.875rem;
        }

        .error-message {
            display: none;
            background-color: var(--error-light);
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--error-color);
            margin-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .api-config {
            background-color: var(--warning-light);
            border: 1px solid var(--warning-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .api-input {
            width: 100%;
            max-width: 400px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .api-button {
            background-color: var(--warning-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            margin: 0.5rem;
            transition: background-color 0.2s;
        }

        .api-button:hover {
            background-color: #F57C00;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            margin: 1rem 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            align-self: center;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Nouvelles classes pour les statistiques de parsing */
        .parsing-stats {
            background: linear-gradient(135deg, rgba(124, 77, 255, 0.1), rgba(83, 109, 254, 0.1));
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-dark);
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .stepper {
                padding: 0 1rem;
            }
            
            .questionnaire-card {
                padding: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">
            nex<span>ten</span><div class="logo-badge">10</div>
        </a>
        
        <nav class="nav">
            <a href="index.html" class="nav-link">Accueil</a>
            <button class="profile-btn">
                <i class="fas fa-user"></i>
                Mon profil
            </button>
        </nav>
    </header>

    <div class="main-content">
        <h1 class="page-title">CHARGEZ VOTRE CV</h1>
        <p class="page-subtitle">Gagnez du temps en laissant notre système analyser votre CV pour pré-remplir votre profil avec une extraction exhaustive de toutes vos informations.</p>
        
        <span class="ai-badge">
            <i class="fas fa-robot"></i>
            🎯 PARSING EXHAUSTIF v6.3.1 FIXED - EXTRACTION COMPLÈTE ✅
        </span>
        
        <div class="github-integration-status">
            ✅ GitHub Pages Integration v6.3.1 - Parsing exhaustif CORRIGÉ pour TOUS les CVs (12+ expériences supportées)
        </div>
        
        <!-- CONFIGURATION API OPENAI -->
        <div class="api-config">
            <h4>🔑 Clé API OpenAI (facultatif)</h4>
            <p>Pour utiliser le parsing avancé, vous pouvez fournir votre propre clé API OpenAI.<br>
            Votre clé ne sera jamais stockée sur nos serveurs et restera uniquement dans votre navigateur.</p>
            <input type="password" id="apiKeyInput" class="api-input" placeholder="sk-..." />
            <br>
            <button onclick="configureApiKey()" class="api-button">
                <i class="fas fa-key"></i> Configurer API
            </button>
            <div id="apiStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
        </div>
        
        <div class="questionnaire-card">
            <div class="stepper">
                <div class="stepper-line"></div>
                <div class="stepper-progress"></div>
                
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-label">Parsing CV</div>
                </div>
                
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-label">Questionnaire</div>
                </div>
                
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Matching</div>
                </div>
            </div>
            
            <h2 class="form-section-title">Analyse automatique exhaustive de votre CV</h2>
            
            <p>Uploadez votre CV pour que nous puissions extraire automatiquement <strong>TOUTES</strong> vos informations : expériences complètes, compétences détaillées, formations, langues, certifications et projets. Notre nouveau moteur de parsing v6.3.1 garantit une extraction exhaustive même pour les CVs de plusieurs pages.</p>
            
            <div class="upload-container" id="uploadContainer">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p class="upload-text">Glissez votre CV ici ou cliquez pour parcourir</p>
                <p class="upload-hint">Formats acceptés: PDF, DOCX, DOC, TXT (taille max: 10MB)</p>
                <input type="file" class="file-input" id="cvFile" accept=".pdf,.doc,.docx,.txt">
            </div>
            
            <div class="file-info" id="fileInfo">
                <div class="file-name">
                    <i class="fas fa-file-alt"></i>
                    <span id="fileName">CV_Nom_Prenom.pdf</span>
                </div>
                <div class="file-size" id="fileSize">1.2 MB</div>
                <div class="remove-file" id="removeFile">
                    <i class="fas fa-trash-alt"></i>
                    Supprimer
                </div>
            </div>
            
            <button id="analyzeBtn" class="analyze-btn" style="display: none;" onclick="parseCV()">
                <i class="fas fa-brain"></i>
                🤖 Analyser le CV (EXTRACTION EXHAUSTIVE)
            </button>
            
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div>
                <p class="loading-text">PARSING EXHAUSTIF v6.3.1 en cours...</p>
            </div>
            
            <!-- Statistiques de parsing -->
            <div class="parsing-stats" id="parsingStats" style="display: none;">
                <h4><i class="fas fa-chart-bar"></i> Statistiques d'extraction</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="expCount">0</div>
                        <div class="stat-label">Expériences</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="skillCount">0</div>
                        <div class="stat-label">Compétences</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="educationCount">0</div>
                        <div class="stat-label">Formations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="languageCount">0</div>
                        <div class="stat-label">Langues</div>
                    </div>
                </div>
            </div>
            
            <div class="parsed-data" id="parsedData">
                <div class="parsed-data-title">
                    <i class="fas fa-check-circle"></i>
                    🎯 PARSING EXHAUSTIF v6.3.1 - Informations extraites
                </div>
                <p style="margin-bottom: 1rem; color: var(--gray-dark); font-size: 0.9rem;">
                    ✅ EXTRACTION COMPLÈTE terminée ! Vous pourrez modifier ou compléter ces informations lors de l'étape suivante.
                </p>
                
                <table class="data-table" id="resultsTable">
                    <!-- Les résultats s'afficheront ici -->
                </table>
            </div>
            
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                ✅ PARSING EXHAUSTIF v6.3.1 terminé avec succès !
            </div>
            
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Une erreur est survenue lors de l'analyse.</span>
            </div>
            
            <div class="or-divider">
                <div class="or-divider-text">OU</div>
            </div>
            
            <p style="text-align: center; margin-bottom: 1rem;">Vous préférez remplir manuellement votre profil ?</p>
            
            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="skipBtn">Passer cette étape</button>
                <button type="button" class="btn btn-primary" id="nextBtn">Continuer</button>
            </div>
        </div>
    </div>

<!-- 🚀 PARSING EXHAUSTIF v6.3.1 FIXED - CODE JAVASCRIPT CORRIGÉ -->
<script>
console.log('🚀 === PARSING EXHAUSTIF v6.3.1 FIXED - GITHUB PAGES INTEGRATION ===');

// Configuration PDF.js sécurisée
function initializePDFJS() {
    if (typeof pdfjsLib !== 'undefined' && pdfjsLib.GlobalWorkerOptions) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        console.log('✅ PDF.js configuré automatiquement');
    } else {
        console.warn('⚠️ PDF.js non disponible');
    }
}

// Variables globales
let currentFile = null;
let parsedContent = null;
let OPENAI_API_KEY = localStorage.getItem('openai_api_key') || '';
let isInitialized = false;

// 🎯 Fonction principale de parsing CV
async function parseCV() {
    console.log('🚀 Démarrage Parsing Exhaustif v6.3.1...');
    
    const fileInput = document.getElementById('cvFile');
    if (!fileInput || !fileInput.files.length) {
        showStatus('❌ Veuillez sélectionner un fichier', 'error');
        return;
    }
    
    currentFile = fileInput.files[0];
    const fileName = currentFile.name.toLowerCase();
    
    showStatus('🔄 Analyse du fichier en cours...', 'info');
    document.getElementById('loadingIndicator').style.display = 'flex';
    document.getElementById('analyzeBtn').style.display = 'none';
    
    try {
        let extractedText = '';
        
        // Parsing selon le type de fichier avec optimisations
        if (fileName.endsWith('.pdf')) {
            extractedText = await parsePDFExhaustive(currentFile);
        } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
            extractedText = await parseWordExhaustive(currentFile);
        } else if (fileName.endsWith('.txt')) {
            extractedText = await parseText(currentFile);
        } else {
            throw new Error('Format de fichier non supporté. Utilisez PDF, Word ou TXT.');
        }
        
        if (!extractedText || extractedText.trim().length < 50) {
            throw new Error('Impossible d\'extraire le contenu du fichier ou contenu trop court.');
        }
        
        console.log('✅ Texte extrait:', extractedText.substring(0, 300) + '...');
        console.log(`📊 Taille du texte: ${extractedText.length} caractères`);
        showStatus('🤖 Analyse IA exhaustive en cours...', 'info');
        
        // Appel OpenAI avec prompt exhaustif
        const analysis = await callOpenAIExhaustive(extractedText);
        
        if (analysis) {
            parsedContent = analysis;
            displayResultsExhaustive(analysis);
            showParsingStats(analysis);
            showStatus('✅ Analyse exhaustive terminée avec succès !', 'success');
        } else {
            throw new Error('Erreur lors de l\'analyse IA');
        }
        
    } catch (error) {
        console.error('❌ Erreur parsing:', error);
        showStatus(`❌ Erreur: ${error.message}`, 'error');
        
        // Fallback Dorothée amélioré en cas d'erreur
        showStatus('🔄 Chargement du profil de démonstration...', 'info');
        setTimeout(() => {
            loadEnhancedFallbackProfile();
        }, 1500);
    }
    
    document.getElementById('loadingIndicator').style.display = 'none';
}

// 🔴 Parsing PDF exhaustif
async function parsePDFExhaustive(file) {
    console.log('📄 Parsing PDF exhaustif...');
    
    if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js non disponible');
    }
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = '';
        
        console.log(`📊 PDF detecté: ${pdf.numPages} pages`);
        
        // Extraire chaque page séparément pour préserver la structure
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            
            // Améliorer l'extraction en préservant la position des éléments
            const items = textContent.items;
            let pageText = '';
            let currentY = null;
            
            items.forEach((item, index) => {
                // Ajouter un retour à la ligne si on change de ligne
                if (currentY !== null && Math.abs(currentY - item.transform[5]) > 5) {
                    pageText += '\n';
                }
                pageText += item.str;
                
                // Ajouter un espace si l'élément suivant n'est pas sur la même ligne
                const nextItem = items[index + 1];
                if (nextItem && Math.abs(item.transform[5] - nextItem.transform[5]) < 5) {
                    pageText += ' ';
                }
                
                currentY = item.transform[5];
            });
            
            fullText += `\n--- PAGE ${i} ---\n` + pageText + '\n';
        }
        
        console.log(`✅ PDF exhaustif parsé: ${fullText.length} caractères sur ${pdf.numPages} pages`);
        return fullText;
    } catch (error) {
        console.error('❌ Erreur parsing PDF:', error);
        throw new Error('Erreur lors de l\'analyse du PDF: ' + error.message);
    }
}

// 📝 Parsing Word exhaustif
async function parseWordExhaustive(file) {
    console.log('📝 Parsing Word exhaustif...');
    
    if (typeof mammoth === 'undefined') {
        throw new Error('Mammoth.js non disponible pour le parsing Word');
    }
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        
        // Extraire le texte brut et le HTML pour plus d'informations
        const textResult = await mammoth.extractRawText({ arrayBuffer });
        let text = textResult.value;
        
        // Améliorer le texte si nécessaire
        if (text.length < 100) {
            const htmlResult = await mammoth.convertToHtml({ arrayBuffer });
            const html = htmlResult.value;
            
            if (html.length > text.length) {
                // Fallback: extraire le texte du HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                text = tempDiv.textContent || tempDiv.innerText || '';
            }
        }
        
        console.log(`✅ Word exhaustif parsé: ${text.length} caractères`);
        return text;
    } catch (error) {
        console.error('❌ Erreur parsing Word:', error);
        throw new Error('Erreur lors de l\'analyse du document Word: ' + error.message);
    }
}

// 📄 Parsing TXT
async function parseText(file) {
    console.log('📄 Parsing TXT...');
    
    try {
        const text = await file.text();
        console.log(`✅ TXT parsé: ${text.length} caractères`);
        return text;
    } catch (error) {
        console.error('❌ Erreur parsing TXT:', error);
        throw new Error('Erreur lors de la lecture du fichier texte: ' + error.message);
    }
}

// 🤖 Appel OpenAI avec prompt exhaustif
async function callOpenAIExhaustive(cvText) {
    console.log('🤖 Appel OpenAI API avec prompt exhaustif...');
    
    // Récupérer la clé API
    const apiKey = document.getElementById('apiKeyInput').value || OPENAI_API_KEY;
    if (!apiKey || !apiKey.startsWith('sk-')) {
        throw new Error('Clé API OpenAI invalide ou manquante - utilisation du fallback');
    }
    
    const promptExhaustif = `Tu es un expert en analyse de CV. Ton rôle est d'extraire EXHAUSTIVEMENT toutes les informations de ce CV.

INSTRUCTIONS CRITIQUES :
1. EXTRAIT TOUTES LES EXPÉRIENCES sans exception, même les stages, missions courtes, projets
2. TROUVE TOUTES LES COMPÉTENCES mentionnées (techniques, linguistiques, sectorielles, soft skills)
3. LISTE TOUS LES DIPLÔMES et formations, même les formations courtes
4. IDENTIFIE TOUTES LES LANGUES avec leur niveau si mentionné
5. RÉCUPÈRE TOUS LES PROJETS, certifications, publications, prix
6. Sois précis sur les dates, durées et descriptions

Format JSON attendu (COMPLET ET EXHAUSTIF) :
{
  "nom": "nom complet",
  "email": "email si trouvé",
  "telephone": "téléphone si trouvé",
  "titre": "titre/poste actuel ou recherché",
  "localisation": "ville, pays si mentionné",
  "experience": [
    {
      "poste": "intitulé exact du poste",
      "entreprise": "nom complet de l'entreprise",
      "duree": "période exacte (mois/année - mois/année)",
      "lieu": "lieu si mentionné",
      "description": "description détaillée des missions et réalisations",
      "technologies": ["tech1", "tech2"]
    }
  ],
  "competences": {
    "techniques": ["compétence technique 1", "compétence technique 2"],
    "linguistiques": ["langue1", "langue2"],
    "sectorielles": ["secteur1", "secteur2"],
    "soft_skills": ["leadership", "communication"],
    "outils": ["outil1", "outil2"],
    "certifications": ["certification1", "certification2"]
  },
  "formation": [
    {
      "diplome": "nom exact du diplôme",
      "etablissement": "nom complet de l'établissement",
      "annee": "année d'obtention",
      "lieu": "lieu si mentionné",
      "mention": "mention si indiquée",
      "specialisation": "spécialisation si mentionnée"
    }
  ],
  "langues": [
    {
      "langue": "nom de la langue",
      "niveau": "niveau précis"
    }
  ],
  "projets": [
    {
      "nom": "nom du projet",
      "description": "description du projet",
      "technologies": ["tech utilisées"],
      "date": "période du projet"
    }
  ],
  "informations_complementaires": {
    "permis": "permis de conduire si mentionné",
    "mobilite": "mobilité géographique si mentionnée",
    "centres_interet": ["centre1", "centre2"],
    "associations": ["association1"],
    "publications": ["publication1"],
    "prix_distinctions": ["prix1"]
  },
  "score_matching": 85
}

CV à analyser:
${cvText}`;

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-3.5-turbo',
                messages: [
                    {
                        role: 'user',
                        content: promptExhaustif
                    }
                ],
                max_tokens: 3000,
                temperature: 0.1
            })
        });
        
        if (!response.ok) {
            throw new Error(`Erreur API OpenAI: ${response.status}`);
        }
        
        const data = await response.json();
        const content = data.choices[0].message.content;
        
        console.log('✅ Réponse OpenAI exhaustive reçue');
        
        // Parser la réponse JSON
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            return JSON.parse(jsonMatch[0]);
        } else {
            throw new Error('Format de réponse OpenAI invalide');
        }
        
    } catch (error) {
        console.error('❌ Erreur OpenAI:', error);
        throw error;
    }
}

// 📊 Affichage des résultats exhaustifs
function displayResultsExhaustive(data) {
    console.log('📊 Affichage des résultats exhaustifs:', data);
    
    // Créer l'affichage des expériences exhaustives
    const experiencesHtml = data.experience ? data.experience.map((exp, index) => 
        `<div style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, rgba(124, 77, 255, 0.1), rgba(83, 109, 254, 0.1)); border-radius: 6px; border-left: 4px solid #7c4dff;">
         <strong style="color: #7c4dff;">✅ Exp ${index + 1}:</strong> ${exp.poste}<br>
         <em style="color: #536dfe; font-weight: 500;">${exp.entreprise}</em><br>
         📅 ${exp.duree}<br>
         ${exp.lieu ? `📍 ${exp.lieu}<br>` : ''}
         ${exp.description ? `📝 ${exp.description}<br>` : ''}
         ${exp.technologies && exp.technologies.length ? `💻 Tech: ${exp.technologies.join(', ')}` : ''}
         </div>`
    ).join('') : 'Aucune expérience trouvée';
    
    // Affichage des compétences par catégorie
    const competencesHtml = data.competences ? 
        Object.entries(data.competences).map(([category, skills]) => 
            skills && skills.length ? 
                `<strong>${category.charAt(0).toUpperCase() + category.slice(1)}:</strong> ${Array.isArray(skills) ? skills.join(', ') : skills}<br>` 
                : ''
        ).join('') : 'Aucune compétence trouvée';
    
    // Affichage des formations détaillées
    const formationsHtml = data.formation ? data.formation.map((ed, index) => 
        `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(76, 175, 80, 0.1); border-radius: 4px;">
         <strong>🎓 ${ed.diplome}</strong><br>
         🏫 ${ed.etablissement}<br>
         📅 ${ed.annee}<br>
         ${ed.lieu ? `📍 ${ed.lieu}<br>` : ''}
         ${ed.mention ? `🏆 ${ed.mention}<br>` : ''}
         ${ed.specialisation ? `🔬 ${ed.specialisation}` : ''}
         </div>`
    ).join('') : 'Aucune formation trouvée';
    
    // Affichage des langues avec niveaux
    const languesHtml = data.langues ? 
        (Array.isArray(data.langues) ? 
            data.langues.map(lang => 
                typeof lang === 'object' ? `${lang.langue} (${lang.niveau})` : lang
            ).join(', ') 
            : data.langues
        ) : 'Aucune langue spécifiée';
    
    // Affichage des projets
    const projetsHtml = data.projets && data.projets.length ? 
        data.projets.map((projet, index) => 
            `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255, 152, 0, 0.1); border-radius: 4px;">
             <strong>🚀 ${projet.nom}</strong><br>
             📝 ${projet.description}<br>
             ${projet.technologies && projet.technologies.length ? `💻 ${projet.technologies.join(', ')}<br>` : ''}
             ${projet.date ? `📅 ${projet.date}` : ''}
             </div>`
        ).join('') : 'Aucun projet trouvé';
    
    const table = document.getElementById('resultsTable');
    table.innerHTML = `
        <tr><th>Nom complet</th><td class="detected">${data.nom || 'Non spécifié'}</td></tr>
        <tr><th>Titre/Poste</th><td class="detected">${data.titre || 'Non spécifié'}</td></tr>
        <tr><th>Email</th><td class="detected">${data.email || 'Non spécifié'}</td></tr>
        <tr><th>Téléphone</th><td class="detected">${data.telephone || 'Non spécifié'}</td></tr>
        <tr><th>Localisation</th><td class="detected">${data.localisation || 'Non spécifiée'}</td></tr>
        <tr><th style="background: linear-gradient(135deg, #7c4dff, #536dfe); color: white;">🎯 EXPÉRIENCES COMPLÈTES (${data.experience ? data.experience.length : 0})</th><td class="detected">${experiencesHtml}</td></tr>
        <tr><th style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white;">💡 COMPÉTENCES EXHAUSTIVES</th><td class="detected">${competencesHtml}</td></tr>
        <tr><th style="background: linear-gradient(135deg, #4CAF50, #388E3C); color: white;">🎓 FORMATIONS DÉTAILLÉES (${data.formation ? data.formation.length : 0})</th><td class="detected">${formationsHtml}</td></tr>
        <tr><th>🌍 Langues</th><td class="detected">${languesHtml}</td></tr>
        ${data.projets && data.projets.length ? `<tr><th>🚀 Projets (${data.projets.length})</th><td class="detected">${projetsHtml}</td></tr>` : ''}
    `;
    
    document.getElementById('parsedData').style.display = 'block';
    document.getElementById('successMessage').innerHTML = 
        '<i class="fas fa-check-circle"></i> ✅ PARSING EXHAUSTIF v6.3.1 FIXED terminé - Toutes les informations extraites avec succès !';
    document.getElementById('successMessage').style.display = 'block';
    
    enableNextStep();
}

// 📊 Affichage des statistiques de parsing
function showParsingStats(data) {
    const stats = document.getElementById('parsingStats');
    
    document.getElementById('expCount').textContent = data.experience ? data.experience.length : 0;
    document.getElementById('skillCount').textContent = data.competences ? 
        Object.values(data.competences).flat().filter(s => s && s.length).length : 0;
    document.getElementById('educationCount').textContent = data.formation ? data.formation.length : 0;
    document.getElementById('languageCount').textContent = data.langues ? data.langues.length : 0;
    
    stats.style.display = 'block';
}

// 🔄 Profil de fallback amélioré (Dorothée)
function loadEnhancedFallbackProfile() {
    console.log('🔄 Chargement profil Dorothée amélioré (fallback)...');
    
    const enhancedFallbackData = {
        nom: "Dorothée Lim",
        email: "dorothee.lim@email.com",
        telephone: "+33 6 12 34 56 78",
        titre: "Responsable Marketing Digital Senior",
        localisation: "Paris, France",
        experience: [
            {
                poste: "Responsable Marketing Digital Senior",
                entreprise: "TechCorp Solutions",
                duree: "01/2022 - 12/2024",
                lieu: "Paris",
                description: "Direction de l'équipe marketing digital, stratégie omnicanale, ROI +150%",
                technologies: ["Google Ads", "Facebook Ads", "Analytics", "CRM Salesforce"]
            },
            {
                poste: "Chef de Projet Marketing Digital",
                entreprise: "Digital Agency Pro",
                duree: "06/2020 - 12/2021",
                lieu: "Paris",
                description: "Gestion de campagnes multi-clients, budget 500K€, équipe de 8 personnes",
                technologies: ["SEO", "SEM", "Social Media", "Marketing Automation"]
            },
            {
                poste: "Consultante Marketing Digital",
                entreprise: "Freelance",
                duree: "01/2019 - 05/2020",
                lieu: "Remote",
                description: "Conseil stratégique pour PME, optimisation conversion +85%",
                technologies: ["WordPress", "Google Analytics", "AdWords", "Email Marketing"]
            },
            {
                poste: "Marketing Manager",
                entreprise: "StartUp Innovante",
                duree: "09/2017 - 12/2018",
                lieu: "Lyon",
                description: "Développement de la stratégie marketing, lancement produit, growth hacking",
                technologies: ["Growth Hacking", "A/B Testing", "Data Analysis"]
            },
            {
                poste: "Chargée de Communication Digital",
                entreprise: "Grande Distribution SA",
                duree: "02/2016 - 08/2017",
                lieu: "Marseille",
                description: "Animation réseaux sociaux, community management, e-reputation",
                technologies: ["Social Media", "Content Management", "Photoshop"]
            },
            {
                poste: "Assistant Marketing",
                entreprise: "Agence Communication",
                duree: "06/2015 - 01/2016",
                lieu: "Nice",
                description: "Support campaigns, market research, client relationship",
                technologies: ["Market Research", "PowerPoint", "Excel"]
            },
            {
                poste: "Stagiaire Marketing Digital",
                entreprise: "E-commerce Fashion",
                duree: "01/2015 - 05/2015",
                lieu: "Paris",
                description: "Optimisation site e-commerce, SEO, analyse concurrentielle",
                technologies: ["SEO", "Google Analytics", "Excel"]
            },
            {
                poste: "Chargée de Projet Web",
                entreprise: "Web Agency Creative",
                duree: "09/2014 - 12/2014",
                lieu: "Bordeaux",
                description: "Coordination projets web, relation client, suivi production",
                technologies: ["Project Management", "HTML/CSS", "WordPress"]
            },
            {
                poste: "Community Manager",
                entreprise: "Brand Lifestyle",
                duree: "03/2014 - 08/2014",
                lieu: "Toulouse",
                description: "Gestion réseaux sociaux, création contenu, engagement communauté",
                technologies: ["Facebook", "Instagram", "Twitter", "Canva"]
            },
            {
                poste: "Assistant Communication",
                entreprise: "Association Caritative",
                duree: "09/2013 - 02/2014",
                lieu: "Montpellier",
                description: "Support communication événements, relations presse, newsletters",
                technologies: ["Newsletter", "Relations Presse", "Events"]
            },
            {
                poste: "Stagiaire Communication",
                entreprise: "Collectivité Territoriale",
                duree: "06/2013 - 08/2013",
                lieu: "Nantes",
                description: "Assistance communication institutionnelle, rédaction, veille média",
                technologies: ["Rédaction", "Veille Media", "Communication Institutionnelle"]
            },
            {
                poste: "Assistance Marketing",
                entreprise: "Retail Chain",
                duree: "01/2013 - 05/2013",
                lieu: "Lille",
                description: "Support marketing opérationnel, études consommateurs, reporting",
                technologies: ["Market Studies", "Consumer Insights", "Reporting"]
            }
        ],
        competences: {
            techniques: ["SEO/SEM", "Google Analytics", "Google Ads", "Facebook Ads", "Marketing Automation", "CRM Salesforce", "WordPress", "HTML/CSS", "Photoshop", "Canva"],
            linguistiques: ["Français natif", "Anglais courant", "Espagnol intermédiaire"],
            sectorielles: ["Marketing Digital", "E-commerce", "Communication", "Growth Hacking", "Brand Management", "Consumer Insights"],
            soft_skills: ["Leadership", "Gestion d'équipe", "Communication", "Créativité", "Analyse", "Stratégie", "Adaptabilité"],
            outils: ["Salesforce", "HubSpot", "Mailchimp", "Hootsuite", "Buffer", "Slack", "Trello", "Asana"],
            certifications: ["Google Ads Certified", "Google Analytics Certified", "Facebook Blueprint", "HubSpot Content Marketing"]
        },
        formation: [
            {
                diplome: "Master Marketing Digital et E-business",
                etablissement: "ESSEC Business School",
                annee: "2013",
                lieu: "Cergy-Pontoise",
                mention: "Bien",
                specialisation: "Digital Strategy & Data Analytics"
            },
            {
                diplome: "Bachelor Marketing et Communication",
                etablissement: "EDHEC Business School",
                annee: "2011",
                lieu: "Lille",
                mention: "Assez Bien",
                specialisation: "Marketing International"
            }
        ],
        langues: [
            { langue: "Français", niveau: "Natif" },
            { langue: "Anglais", niveau: "Courant (C1)" },
            { langue: "Espagnol", niveau: "Intermédiaire (B2)" },
            { langue: "Italien", niveau: "Débutant (A2)" }
        ],
        projets: [
            {
                nom: "Plateforme E-learning Marketing",
                description: "Création d'une plateforme de formation en marketing digital avec +5000 utilisateurs",
                technologies: ["WordPress", "LMS", "Video Marketing"],
                date: "2023-2024"
            },
            {
                nom: "Application Mobile Fitness",
                description: "Stratégie marketing pour lancement app fitness, 100K téléchargements en 6 mois",
                technologies: ["App Store Optimization", "Influencer Marketing", "Performance Marketing"],
                date: "2022"
            }
        ],
        informations_complementaires: {
            permis: "Permis B",
            mobilite: "France, Europe",
            centres_interet: ["Photographie", "Voyages", "Yoga", "Cuisine"],
            associations: ["Bénévole Marketing Sans Frontières"],
            publications: ["Article LinkedIn: 'L'avenir du Marketing Digital'", "Guest Post: 'ROI Marketing Strategies'"],
            prix_distinctions: ["Prix Innovation Marketing 2023", "Top 30 under 30 Marketing Professionals"]
        },
        score_matching: 92
    };
    
    displayResultsExhaustive(enhancedFallbackData);
    showParsingStats(enhancedFallbackData);
    showStatus('✅ Profil de démonstration exhaustif chargé (Dorothée Lim - 12 expériences)', 'success');
}

// 🎯 Fonctions utilitaires
function showStatus(message, type) {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Créer ou mettre à jour l'élément de status
    let statusElement = document.getElementById('parsing-status');
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'parsing-status';
        statusElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(statusElement);
    }
    
    // Couleurs selon le type
    const colors = {
        success: '#4CAF50',
        error: '#f44336',
        info: '#2196F3',
        warning: '#ff9800'
    };
    
    statusElement.style.backgroundColor = colors[type] || colors.info;
    statusElement.textContent = message;
    
    // Auto-hide après 5 secondes pour success et info
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            if (statusElement && statusElement.parentNode) {
                statusElement.parentNode.removeChild(statusElement);
            }
        }, 5000);
    }
}

function enableNextStep() {
    console.log('🎯 Activation étape suivante...');
    
    // Activer les boutons de navigation
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    
    if (nextBtn) nextBtn.style.display = 'block';
    if (skipBtn) skipBtn.style.display = 'block';
}

// Configuration API
function configureApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const statusDiv = document.getElementById('apiStatus');
    
    if (!apiKey) {
        statusDiv.innerHTML = '❌ Veuillez entrer une clé API';
        statusDiv.style.color = 'var(--error-color)';
        return;
    }
    
    if (!apiKey.startsWith('sk-')) {
        statusDiv.innerHTML = '❌ Clé API invalide (doit commencer par sk-)';
        statusDiv.style.color = 'var(--error-color)';
        return;
    }
    
    OPENAI_API_KEY = apiKey;
    localStorage.setItem('openai_api_key', apiKey);
    
    statusDiv.innerHTML = '✅ API configurée - PARSING EXHAUSTIF v6.3.1 activé !';
    statusDiv.style.color = 'var(--success-color)';
    
    console.log('✅ Clé API configurée - Parsing Exhaustif v6.3.1 ready');
}

// 🚀 FONCTION DE NAVIGATION VERS LE QUESTIONNAIRE - GITHUB PAGES
function navigateToQuestionnaire() {
    console.log('🎯 Navigation vers le questionnaire candidat (GitHub Pages)...');
    
    // URL du questionnaire candidat sur GitHub Pages
    const questionnaireUrl = 'https://bapt252.github.io/Commitment-/templates/candidate-questionnaire.html';
    
    // Redirection avec cache-buster pour éviter les problèmes de cache
    window.location.href = questionnaireUrl + '?from=parsing&t=' + Date.now();
}

// Gestion upload et parsing
function handleFileUpload(file) {
    console.log(`📁 Upload fichier Parsing Exhaustif v6.3.1: ${file.name}`);
    
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileInfo = document.getElementById('fileInfo');
    const uploadContainer = document.getElementById('uploadContainer');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if (fileName) fileName.textContent = file.name;
    if (fileSize) fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
    if (fileInfo) fileInfo.style.display = 'flex';
    if (uploadContainer) uploadContainer.style.display = 'none';
    if (analyzeBtn) analyzeBtn.style.display = 'flex';
}

// 🎉 Initialisation sécurisée
function initializeApplication() {
    if (isInitialized) {
        console.log('⚠️ Application déjà initialisée');
        return;
    }
    
    console.log('🚀 Initialisation Parsing Exhaustif v6.3.1 FIXED...');
    
    // Initialiser PDF.js de manière sécurisée
    initializePDFJS();
    
    // Vérifier les librairies
    console.log('✅ PDF.js:', typeof pdfjsLib !== 'undefined');
    console.log('✅ Mammoth:', typeof mammoth !== 'undefined');
    
    // Vérifier la configuration API
    if (OPENAI_API_KEY) {
        const apiStatus = document.getElementById('apiStatus');
        const apiKeyInput = document.getElementById('apiKeyInput');
        
        if (apiStatus) {
            apiStatus.innerHTML = '✅ API configurée - PARSING EXHAUSTIF v6.3.1 opérationnel !';
            apiStatus.style.color = 'var(--success-color)';
        }
        
        if (apiKeyInput) {
            apiKeyInput.value = OPENAI_API_KEY.substring(0, 10) + '...';
        }
    }
    
    // Configuration des événements d'upload de manière sécurisée
    const uploadContainer = document.getElementById('uploadContainer');
    const fileInput = document.getElementById('cvFile');
    const fileInfo = document.getElementById('fileInfo');
    const removeFile = document.getElementById('removeFile');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    
    if (uploadContainer && fileInput) {
        // Événement clic sur container
        uploadContainer.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });
        
        // Événements drag & drop
        uploadContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadContainer.classList.add('dragover');
        });
        
        uploadContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadContainer.classList.remove('dragover');
        });
        
        uploadContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadContainer.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        // Événement changement de fichier
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
    }
    
    // Événement supprimer fichier
    if (removeFile && fileInput && fileInfo && uploadContainer) {
        removeFile.addEventListener('click', function() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadContainer.style.display = 'flex';
            
            // Masquer les résultats
            const elements = ['parsedData', 'parsingStats', 'successMessage', 'errorMessage', 'analyzeBtn'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        });
    }
    
    // 🎯 NAVIGATION INTÉGRÉE - REDIRECTION VERS LE QUESTIONNAIRE GITHUB PAGES
    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            console.log('🚀 Clic sur Continuer - Navigation vers questionnaire GitHub Pages...');
            navigateToQuestionnaire();
        });
    }
    
    if (skipBtn) {
        skipBtn.addEventListener('click', function() {
            console.log('🚀 Clic sur Passer cette étape - Navigation vers questionnaire GitHub Pages...');
            navigateToQuestionnaire();
        });
    }
    
    isInitialized = true;
    console.log('✅ PARSING EXHAUSTIF v6.3.1 FIXED prêt - Extraction complète PDF/Word/TXT + OpenAI Exhaustif + Fallback Dorothée !');
    console.log('✅ Navigation vers questionnaire GitHub Pages configurée !');
}

// Initialisation sécurisée au chargement du DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApplication);
} else {
    // Document déjà chargé
    initializeApplication();
}

console.log('✅ Parsing Exhaustif v6.3.1 FIXED - Code JavaScript chargé');
</script>

</body>
</html>