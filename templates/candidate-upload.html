<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexten - Chargement de CV</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Script de transfert de donn√©es -->
    <script src="../static/scripts/data-transfer-service.js"></script>
    <!-- Scripts de parsing CV optimis√©s pour Commitment -->
    <script src="../static/js/enhanced-cv-parser.js"></script>
    <script src="../static/js/optimized-openai-prompt.js"></script>
    <script src="../static/js/parser-integration.js"></script>
    <style>
        /* Styles CSS existants (inchang√©s) */
        :root {
            --primary-color: #7c4dff;
            --primary-light: #e8e3ff;
            --gray-light: #f5f5f5;
            --gray-dark: #666;
            --text-color: #333;
            --border-radius: 8px;
            --success-color: #4CAF50;
            --success-light: #E8F5E9;
            --warning-color: #FF9800;
            --warning-light: #FFF3E0;
            --error-color: #F44336;
            --error-light: #FFEBEE;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-color);
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .logo {
            color: var(--text-color);
            font-weight: 700;
            text-decoration: none;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .logo span {
            color: var(--primary-color);
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-left: 4px;
        }

        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        .profile-btn {
            background-color: #f5f5f5;
            color: var(--primary-color);
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .profile-btn:hover {
            background-color: #e8e3ff;
        }

        .main-content {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            text-align: center;
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--gray-dark);
            text-align: center;
            margin-bottom: 2rem;
            max-width: 600px;
            line-height: 1.5;
        }

        .ai-badge {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .questionnaire-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            margin-top: 1rem;
        }

        .stepper {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2.5rem;
            padding: 0 3rem;
        }

        .stepper-line {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 3px;
            background-color: #e0e0e0;
            width: 100%;
            z-index: 1;
        }

        .stepper-progress {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 3px;
            background-color: var(--primary-color);
            width: 0%;
            z-index: 1;
            transition: width 0.3s;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background-color: white;
            border: 2px solid #e0e0e0;
            color: #9e9e9e;
        }

        .step.active .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-top: 0.25rem;
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .form-section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #6a3de8;
        }

        .btn-outline {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
        }

        /* Styles sp√©cifiques pour l'upload de CV */
        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            margin: 1.5rem 0;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .upload-container:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--primary-light);
            border-radius: var(--border-radius);
            width: 100%;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-size {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .remove-file {
            color: #d32f2f;
            cursor: pointer;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .remove-file:hover {
            color: #b71c1c;
        }

        .loading-indicator {
            display: none;
            margin-top: 1.5rem;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .parsed-data {
            display: none;
            margin-top: 2rem;
            width: 100%;
        }

        .parsed-data-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th, .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            text-align: left;
            line-height: 1.4;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table th {
            font-weight: 600;
            color: var(--primary-color);
            background-color: var(--primary-light);
            width: 30%;
        }

        .detected {
            color: var(--text-color);
        }

        .not-detected {
            color: #999;
            font-style: italic;
        }

        .success-message {
            display: none;
            background-color: var(--success-light);
            color: var(--success-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        .or-divider {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 1.5rem 0;
        }

        .or-divider::before, .or-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .or-divider-text {
            margin: 0 1rem;
            color: var(--gray-dark);
            font-size: 0.875rem;
        }

        .error-message {
            display: none;
            background-color: var(--error-light);
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--error-color);
            margin-top: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Styles pour le chat AI */
        .chat-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        
        .chat-button:hover {
            background-color: #6a3de8;
        }
        
        .chat-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .chat-modal {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background-color: var(--primary-color);
            color: white;
        }
        
        .chat-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .chat-close:hover {
            opacity: 0.8;
        }
        
        .chat-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .chat-document {
            width: 300px;
            padding: 1rem;
            border-right: 1px solid #eee;
            background-color: #f8f9fa;
            overflow-y: auto;
        }
        
        .chat-document-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-document-data {
            max-height: calc(80vh - 130px);
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            background-color: white;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        .chat-messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .message.user {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        .message.assistant {
            align-self: flex-start;
            background-color: #f0f0f0;
            color: var(--text-color);
            border-bottom-left-radius: 0.25rem;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: #f0f0f0;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            color: var(--gray-dark);
            font-style: italic;
            margin-top: 0.5rem;
            display: none;
        }
        
        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #eee;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 1.5rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            border-color: var(--primary-color);
        }
        
        .chat-send {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chat-send:hover {
            background-color: #6a3de8;
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0 1rem 1rem;
        }
        
        .suggestion {
            background-color: #f0f0f0;
            color: var(--gray-dark);
            border: none;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        /* Style du conteneur API Key */
        .api-key-container {
            margin-bottom: 1.5rem;
            display: none;
            width: 100%;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px dashed #ddd;
        }
        
        .api-key-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .api-key-description {
            font-size: 0.875rem;
            color: var(--gray-dark);
            margin-bottom: 1rem;
        }
        
        .api-key-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }
        
        .api-key-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .api-key-save {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        .api-key-cancel {
            background-color: white;
            color: var(--gray-dark);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Styles pour les tags dans les comp√©tences */
        .skills-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .skill-tag {
            background-color: var(--primary-light);
            color: var(--primary-color);
            border-radius: 1rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }

        .skill-tag i {
            margin-right: 0.3rem;
            font-size: 0.75rem;
        }

        /* Styles pour la liste des logiciels */
        .software-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .software-item {
            background-color: #f0f2f5;
            color: var(--gray-dark);
            border-radius: 1rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
        }

        .software-item i {
            margin-right: 0.3rem;
            font-size: 0.75rem;
        }

        /* Styles pour les langues */
        .language-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .language-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background-color: #f8f9fa;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            min-width: 120px;
        }

        .language-name {
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .language-name i {
            margin-right: 0.3rem;
            color: var(--primary-color);
        }

        .language-level {
            font-size: 0.875rem;
            color: var(--gray-dark);
            padding-left: 1.2rem;
        }

        /* Styles pour l'exp√©rience */
        .experience-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .experience-item {
            padding: 0.75rem;
            border-left: 3px solid var(--primary-light);
            background-color: #f8f9fa;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            transition: all 0.2s ease;
        }

        .experience-item:hover {
            border-left-color: var(--primary-color);
            background-color: var(--primary-light);
            transform: translateX(3px);
        }

        .experience-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--primary-color);
        }

        .experience-company {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .experience-company i {
            margin-right: 0.3rem;
            font-size: 0.8rem;
            color: var(--gray-dark);
        }

        .experience-date {
            font-size: 0.875rem;
            color: var(--gray-dark);
            display: flex;
            align-items: center;
        }

        .experience-date i {
            margin-right: 0.3rem;
            font-size: 0.8rem;
        }

        /* Styles pour la notification d'information */
        .info-box {
            background-color: var(--primary-light);
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-dark);
            line-height: 1.4;
        }

        .info-box i {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-top: 0.1rem;
        }

        /* Badge pour le parser optimis√© */
        .parser-badge {
            background: linear-gradient(45deg, var(--primary-color), #9c27b0);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-left: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .parser-badge i {
            font-size: 0.7rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .stepper {
                padding: 0 1rem;
            }
            
            .questionnaire-card {
                padding: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn {
                width: 100%;
            }
            
            .chat-body {
                flex-direction: column;
            }
            
            .chat-document {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .data-table th {
                width: 40%;
            }

            .language-list {
                gap: 0.5rem;
            }

            .language-item {
                min-width: auto;
                width: calc(50% - 0.25rem);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">
            nex<span>ten</span><div class="logo-badge">10</div>
        </a>
        
        <nav class="nav">
            <a href="index.html" class="nav-link">Accueil</a>
            <button class="profile-btn">
                <i class="fas fa-user"></i>
                Mon profil
            </button>
        </nav>
    </header>

    <div class="main-content">
        <h1 class="page-title">CHARGEZ VOTRE CV</h1>
        <p class="page-subtitle">Gagnez du temps en laissant notre syst√®me analyser votre CV pour pr√©-remplir votre profil.</p>
        
        <span class="ai-badge">
            <i class="fas fa-robot"></i>
            Parsing assist√© par l'IA
            <span class="parser-badge">
                <i class="fas fa-lightning-bolt"></i>
                Optimis√© v2.0
            </span>
        </span>
        
        <div class="questionnaire-card">
            <div class="stepper">
                <div class="stepper-line"></div>
                <div class="stepper-progress"></div>
                
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-label">Parsing CV</div>
                </div>
                
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-label">Questionnaire</div>
                </div>
                
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Matching</div>
                </div>
            </div>
            
            <h2 class="form-section-title">Analyse automatique de votre CV</h2>
            
            <p>Uploadez votre CV pour que nous puissions extraire automatiquement vos informations et comp√©tences. Cela permettra d'optimiser vos chances de matching avec les offres qui vous correspondent.</p>
            
            <!-- Conteneur pour la cl√© API (initialement cach√©) -->
            <div class="api-key-container" id="apiKeyContainer">
                <div class="api-key-title">Cl√© API OpenAI (facultatif)</div>
                <div class="api-key-description">
                    Pour utiliser le parsing avanc√© sur GitHub Pages, vous pouvez fournir votre propre cl√© API OpenAI.
                    Votre cl√© ne sera jamais stock√©e sur nos serveurs et restera uniquement dans votre navigateur.
                </div>
                <input type="text" class="api-key-input" id="apiKeyInput" placeholder="sk-...">
                <div class="api-key-actions">
                    <button class="api-key-cancel" id="apiKeyCancelBtn">Annuler</button>
                    <button class="api-key-save" id="apiKeySaveBtn">Enregistrer</button>
                </div>
            </div>
            
            <div class="upload-container" id="uploadContainer">
                <i class="fas fa-file-upload upload-icon"></i>
                <p class="upload-text">Glissez votre CV ici ou cliquez pour parcourir</p>
                <p class="upload-hint">Formats accept√©s: PDF, DOCX, DOC, JPG, PNG (taille max: 10MB)</p>
                <input type="file" class="file-input" id="cvFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
            </div>
            
            <div class="file-info" id="fileInfo">
                <div class="file-name">
                    <i class="fas fa-file-alt"></i>
                    <span id="fileName">CV_Nom_Prenom.pdf</span>
                </div>
                <div class="file-size" id="fileSize">1.2 MB</div>
                <div class="remove-file" id="removeFile">
                    <i class="fas fa-trash-alt"></i>
                    Supprimer
                </div>
            </div>
            
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div>
                <p class="loading-text">Analyse CV optimis√©e en cours...</p>
            </div>
            
            <div class="parsed-data" id="parsedData">
                <div class="parsed-data-title">
                    <i class="fas fa-check-circle"></i>
                    Informations extraites de votre CV
                    <span class="parser-badge">
                        <i class="fas fa-star"></i>
                        Pr√©cision am√©lior√©e
                    </span>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <p>Ces informations ont √©t√© extraites automatiquement avec notre nouveau parser optimis√©. Vous pourrez les modifier et les compl√©ter lors de l'√©tape suivante.</p>
                </div>
                
                <table class="data-table">
                    <tr>
                        <th>Nom complet</th>
                        <td id="parsedName" class="detected">John Doe</td>
                    </tr>
                    <tr>
                        <th>Titre de poste actuel</th>
                        <td id="parsedJobTitle" class="detected">D√©veloppeur Front-End</td>
                    </tr>
                    <tr>
                        <th>Email</th>
                        <td id="parsedEmail" class="detected">john.doe@exemple.com</td>
                    </tr>
                    <tr>
                        <th>T√©l√©phone</th>
                        <td id="parsedPhone" class="detected">+33 6 12 34 56 78</td>
                    </tr>
                    <tr>
                        <th>Comp√©tences d√©tect√©es</th>
                        <td id="parsedSkills">
                            <div class="skills-tags">
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>HTML</span>
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>CSS</span>
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>JavaScript</span>
                                <span class="skill-tag"><i class="fas fa-check-circle"></i>React</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Logiciels ma√Ætris√©s</th>
                        <td id="parsedSoftware">
                            <div class="software-list">
                                <span class="software-item"><i class="fas fa-laptop-code"></i>Visual Studio Code</span>
                                <span class="software-item"><i class="fas fa-pencil-ruler"></i>Adobe Photoshop</span>
                                <span class="software-item"><i class="fas fa-paint-brush"></i>Figma</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Langues</th>
                        <td id="parsedLanguages">
                            <div class="language-list">
                                <div class="language-item">
                                    <span class="language-name"><i class="fas fa-language"></i>Fran√ßais</span>
                                    <span class="language-level">Natif</span>
                                </div>
                                <div class="language-item">
                                    <span class="language-name"><i class="fas fa-language"></i>Anglais</span>
                                    <span class="language-level">Courant</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>Exp√©rience professionnelle</th>
                        <td id="parsedExperience">
                            <div class="experience-list">
                                <div class="experience-item">
                                    <div class="experience-title">D√©veloppeur Front-End</div>
                                    <div class="experience-company"><i class="fas fa-building"></i>TechCorp</div>
                                    <div class="experience-date"><i class="fas fa-calendar-alt"></i>Jan 2022 - Pr√©sent</div>
                                </div>
                                <div class="experience-item">
                                    <div class="experience-title">D√©veloppeur Web Junior</div>
                                    <div class="experience-company"><i class="fas fa-building"></i>WebAgency</div>
                                    <div class="experience-date"><i class="fas fa-calendar-alt"></i>Mar 2020 - D√©c 2021</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- Bouton pour ouvrir le chat avec l'IA -->
                <button class="chat-button" id="openChatBtn">
                    <i class="fas fa-comment-dots"></i>
                    Discuter de mon CV avec l'IA
                </button>
            </div>
            
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                Analyse termin√©e avec succ√®s!
            </div>
            
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Une erreur est survenue lors de l'analyse.</span>
            </div>
            
            <div class="or-divider">
                <div class="or-divider-text">OU</div>
            </div>
            
            <p style="text-align: center; margin-bottom: 1rem;">Vous pr√©f√©rez remplir manuellement votre profil ?</p>
            
            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="skipBtn">Passer cette √©tape</button>
                <button type="button" class="btn btn-primary" id="nextBtn">Continuer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de chat avec l'IA -->
    <div class="chat-modal-overlay" id="chatModalOverlay">
        <div class="chat-modal">
            <div class="chat-header">
                <h3><i class="fas fa-robot"></i> Assistant d'analyse de CV</h3>
                <button class="chat-close" id="closeChatBtn">&times;</button>
            </div>
            <div class="chat-body">
                <div class="chat-document">
                    <div class="chat-document-title">
                        <i class="fas fa-file-alt"></i>
                        Donn√©es extraites
                    </div>
                    <div class="chat-document-data" id="chatDocumentData">
                        <!-- Les donn√©es extraites du CV seront affich√©es ici -->
                    </div>
                </div>
                <div class="chat-messages-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            Bonjour ! Je suis votre assistant IA optimis√©. J'ai analys√© votre CV avec notre nouveau parser et je peux r√©pondre √† vos questions ou vous fournir des conseils pour l'am√©liorer. Comment puis-je vous aider ?
                        </div>
                    </div>
                    <div class="typing-indicator" id="chatTypingIndicator">
                        L'assistant est en train d'√©crire...
                    </div>
                    <div class="suggestions">
                        <button class="suggestion">Comment puis-je am√©liorer mon CV ?</button>
                        <button class="suggestion">Quelles sont mes forces ?</button>
                        <button class="suggestion">Quelles comp√©tences devrais-je d√©velopper ?</button>
                        <button class="suggestion">Quels types d'emploi me correspondent ?</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Posez une question sur votre CV...">
                        <button class="chat-send" id="chatSendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="cv-parser-integration.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Afficher un message de confirmation du chargement du parser optimis√©
            console.log('üöÄ Parser CV Commitment optimis√© charg√© !');
            
            // V√©rifier que les composants optimis√©s sont bien charg√©s
            if (typeof window.EnhancedCVParser !== 'undefined') {
                console.log('‚úÖ Parser CV optimis√© d√©tect√©');
            }
            if (typeof window.CommitmentOptimizedPrompt !== 'undefined') {
                console.log('‚úÖ Prompts OpenAI optimis√©s d√©tect√©s');
            }
            if (typeof window.commitmentEnhancedParser !== 'undefined') {
                console.log('‚úÖ Instance parser optimis√©e pr√™te');
            }
            
            // Fonction de test rapide (accessible dans la console)
            window.testOptimizedParser = function() {
                if (typeof window.testCommitmentParser === 'function') {
                    return window.testCommitmentParser();
                } else {
                    console.log('‚ùå Fonction de test non disponible');
                }
            };
            
            // Message informatif dans la console
            console.log('üß™ Pour tester le parser optimis√©: testOptimizedParser()');
            
            // √âl√©ments DOM pour l'upload de CV
            const uploadContainer = document.getElementById('uploadContainer');
            const fileInput = document.getElementById('cvFile');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const removeFile = document.getElementById('removeFile');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const parsedData = document.getElementById('parsedData');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const nextBtn = document.getElementById('nextBtn');
            const skipBtn = document.getElementById('skipBtn');
            const stepperProgress = document.querySelector('.stepper-progress');
            const openChatBtn = document.getElementById('openChatBtn');
            
            // √âl√©ments DOM pour la cl√© API
            const apiKeyContainer = document.getElementById('apiKeyContainer');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKeySaveBtn = document.getElementById('apiKeySaveBtn');
            const apiKeyCancelBtn = document.getElementById('apiKeyCancelBtn');
            
            // √âl√©ments DOM pour le chat
            const chatModalOverlay = document.getElementById('chatModalOverlay');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatTypingIndicator = document.getElementById('chatTypingIndicator');
            const chatDocumentData = document.getElementById('chatDocumentData');
            const suggestionBtns = document.querySelectorAll('.suggestion');
            
            // Variables pour le chat
            let chatHistory = [];
            let documentData = null;
            // Variable pour stocker les donn√©es compl√®tes du parser CV
            let completeParserData = null;
            
            // URL de base pour les API - D√©tection automatique de l'environnement
            const isGitHubPages = window.location.hostname.includes('github.io');
            
            // Si sur GitHub Pages, afficher le conteneur de cl√© API
            if (isGitHubPages) {
                apiKeyContainer.style.display = 'block';
                
                // V√©rifier si une cl√© API est d√©j√† stock√©e
                const storedApiKey = localStorage.getItem('openai_api_key');
                if (storedApiKey) {
                    apiKeyInput.value = storedApiKey;
                }
            }
            
            // √âv√©nements pour la gestion de la cl√© API
            apiKeySaveBtn.addEventListener('click', function() {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey && apiKey.startsWith('sk-')) {
                    localStorage.setItem('openai_api_key', apiKey);
                    apiKeyContainer.style.display = 'none';
                    
                    // R√©initialiser l'int√©gration avec la nouvelle cl√© API
                    initCVParser();
                    
                    // Afficher un message de succ√®s
                    showSuccessMessage('Cl√© API enregistr√©e avec succ√®s! Parser optimis√© activ√©.');
                } else {
                    showErrorMessage('Veuillez entrer une cl√© API OpenAI valide commen√ßant par "sk-"');
                }
            });
            
            apiKeyCancelBtn.addEventListener('click', function() {
                apiKeyContainer.style.display = 'none';
            });
            
            // Fonction pour initialiser le parser CV avec les options appropri√©es
            function initCVParser() {
                const apiKey = localStorage.getItem('openai_api_key');
                const useDirectOpenAI = isGitHubPages && apiKey;
                
                // URL de l'API ou null pour GitHub Pages
                const API_BASE_URL = isGitHubPages ? null : 'http://localhost:5051/api';
                
                console.log('Environnement d√©tect√©:', isGitHubPages ? 'GitHub Pages' : 'Local/Dev');
                console.log('Parser optimis√© Commitment:', useDirectOpenAI ? 'Activ√© avec OpenAI' : 'Mode local optimis√©');
                
                // Initialiser l'int√©gration du service de parsing avec auto-d√©tection
                window.cvParser = new CVParserIntegration({
                    apiUrl: API_BASE_URL,
                    useAsync: false,
                    forceMock: isGitHubPages && !apiKey, // Forcer le mode mock sur GitHub Pages sans cl√© API
                    useDirectOpenAI: useDirectOpenAI,    // Utiliser l'API OpenAI directement si cl√© disponible
                    openAIKey: apiKey,                   // Cl√© API OpenAI (si disponible)
                    useEnhancedParsing: true,           // Forcer l'utilisation du parser optimis√©
                    onParsingStart: () => {
                        loadingIndicator.style.display = 'flex';
                        errorMessage.style.display = 'none';
                        parsedData.style.display = 'none';
                        stepperProgress.style.width = '33.33%';
                        
                        // Mettre √† jour le message de chargement
                        const loadingText = document.querySelector('.loading-text');
                        if (loadingText) {
                            loadingText.textContent = 'Analyse CV optimis√©e Commitment en cours...';
                        }
                    },
                    onParsingComplete: (data) => {
                        loadingIndicator.style.display = 'none';
                        
                        if (data && data.data) {
                            // Stocker les donn√©es compl√®tes du parser
                            completeParserData = data;
                            const extractedData = data.data;
                            
                            // Mettre √† jour l'interface avec les donn√©es
                            populateDataTable(extractedData);
                            
                            // Afficher les r√©sultats
                            parsedData.style.display = 'block';
                            showSuccessMessage('Analyse termin√©e avec succ√®s par le parser optimis√©!');
                            
                            // Log des performances
                            if (data.parsing_stats) {
                                console.log('üìä Statistiques parsing optimis√©:', data.parsing_stats);
                            }
                            if (data.quality_score) {
                                console.log('‚≠ê Score de qualit√©:', data.quality_score + '%');
                            }
                        } else {
                            // G√©rer l'erreur
                            showErrorMessage('√âchec de l\'analyse du CV.');
                        }
                    },
                    onParsingError: (error) => {
                        loadingIndicator.style.display = 'none';
                        showErrorMessage('Erreur lors de l\'analyse: ' + error.message);
                    }
                });
            }
            
            // Initialiser le CVParser
            initCVParser();
            
            // Par d√©faut, le bouton Continuer est activ√©
            nextBtn.disabled = false;
            
            // Mise √† jour de la barre de progression
            stepperProgress.style.width = '0%';
            
            // √âv√©nements pour l'upload de CV
            uploadContainer.addEventListener('click', function() {
                fileInput.click();
            });
            
            uploadContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#7c4dff';
                this.style.backgroundColor = '#e8e3ff';
            });
            
            uploadContainer.addEventListener('dragleave', function() {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = 'transparent';
            });
            
            uploadContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
                
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = 'transparent';
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    handleFile(this.files[0]);
                }
            });
            
            removeFile.addEventListener('click', function() {
                resetFileUpload();
            });
            
            skipBtn.addEventListener('click', function() {
                // Aucun CV charg√©, on passe √† l'√©tape suivante sans donn√©es
                localStorage.removeItem('parsedCvData');
                sessionStorage.removeItem('parsedCvData');
                window.location.href = 'candidate-questionnaire.html';
            });
            
            nextBtn.addEventListener('click', function() {
                if (fileInfo.style.display === 'flex' && parsedData.style.display === 'block') {
                    if (completeParserData) {
                        // S'assurer que le titre de poste est √©galement accessible au niveau racine
                        // pour une meilleure compatibilit√©
                        const jobTitle = getJobTitleFromData(completeParserData);
                        if (jobTitle) {
                            completeParserData.current_position = jobTitle;
                        }
                        
                        // Utiliser le service de transfert de donn√©es si disponible
                        if (window.DataTransferService) {
                            if (window.DataTransferService.storeData(completeParserData)) {
                                console.log("Donn√©es CV compl√®tes stock√©es pour pr√©-remplissage via DataTransferService:", completeParserData);
                            } else {
                                console.warn("√âchec du stockage via DataTransferService, utilisation de localStorage comme fallback");
                                // Fallback - Ancien comportement
                                storeDataInLocalStorage(completeParserData);
                            }
                        } else {
                            // Fallback - Ancien comportement
                            storeDataInLocalStorage(completeParserData);
                        }
                    } else {
                        // Cr√©er un objet de donn√©es √† partir des informations affich√©es
                        const displayedData = createDataFromDisplay();
                        
                        // Utiliser le service de transfert de donn√©es si disponible
                        if (window.DataTransferService) {
                            if (window.DataTransferService.storeData(displayedData)) {
                                console.log("Donn√©es CV g√©n√©r√©es et stock√©es pour pr√©-remplissage via DataTransferService:", displayedData);
                            } else {
                                console.warn("√âchec du stockage via DataTransferService, utilisation de localStorage comme fallback");
                                storeDataInLocalStorage(displayedData);
                            }
                        } else {
                            // Fallback - Ancien comportement
                            storeDataInLocalStorage(displayedData);
                        }
                    }
                } else {
                    // Aucun CV analys√©, on continue sans donn√©es
                    localStorage.removeItem('parsedCvData');
                    sessionStorage.removeItem('parsedCvData');
                }
                
                // Redirection vers l'√©tape suivante dans tous les cas
                window.location.href = 'candidate-questionnaire.html';
            });
            
            /**
             * Cr√©e un objet de donn√©es √† partir des informations affich√©es dans l'interface
             */
            function createDataFromDisplay() {
                const displayedData = {
                    data: {
                        personal_info: {
                            name: document.getElementById('parsedName').textContent,
                            email: document.getElementById('parsedEmail').textContent,
                            phone: document.getElementById('parsedPhone').textContent
                        },
                        current_position: document.getElementById('parsedJobTitle').textContent,
                        skills: Array.from(document.querySelectorAll('#parsedSkills .skill-tag')).map(tag => tag.textContent.replace(/^./, '')),
                        software: Array.from(document.querySelectorAll('#parsedSoftware .software-item')).map(item => item.textContent.replace(/^./, '')),
                        languages: Array.from(document.querySelectorAll('#parsedLanguages .language-item')).map(item => {
                            return {
                                language: item.querySelector('.language-name')?.textContent.replace(/^./, '') || '',
                                level: item.querySelector('.language-level')?.textContent || ''
                            };
                        }),
                        work_experience: Array.from(document.querySelectorAll('#parsedExperience .experience-item')).map(item => {
                            const dateText = item.querySelector('.experience-date')?.textContent.replace(/^./, '') || '';
                            const dateParts = dateText.split(' - ');
                            return {
                                title: item.querySelector('.experience-title')?.textContent || '',
                                company: item.querySelector('.experience-company')?.textContent.replace(/^./, '') || '',
                                start_date: dateParts[0] || '',
                                end_date: dateParts[1] || ''
                            };
                        })
                    }
                };
                
                // S'assurer que le titre du poste est √©galement accessible au niveau racine pour compatibilit√©
                displayedData.current_position = displayedData.data.current_position;
                
                return displayedData;
            }
            
            /**
             * Stocke les donn√©es dans localStorage et sessionStorage pour maximiser la compatibilit√©
             */
            function storeDataInLocalStorage(data) {
                try {
                    const dataString = JSON.stringify(data);
                    localStorage.setItem('parsedCvData', dataString);
                    sessionStorage.setItem('parsedCvData', dataString);
                    console.log("Donn√©es CV stock√©es dans localStorage et sessionStorage pour pr√©-remplissage:", data);
                    return true;
                } catch (error) {
                    console.error("Erreur lors du stockage des donn√©es:", error);
                    return false;
                }
            }
            
            /**
             * Extrait l'intitul√© du poste √† partir des donn√©es, en v√©rifiant plusieurs sources possibles
             */
            function getJobTitleFromData(data) {
                if (data.current_position) {
                    return data.current_position;
                }
                
                if (data.data && data.data.current_position) {
                    return data.data.current_position;
                }
                
                if (data.jobTitle) {
                    return data.jobTitle;
                }
                
                if (data.data && data.data.work_experience && data.data.work_experience.length > 0) {
                    return data.data.work_experience[0].title || '';
                }
                
                if (data.work_experience && data.work_experience.length > 0) {
                    return data.work_experience[0].title || '';
                }
                
                // R√©cup√©rer depuis l'√©l√©ment DOM comme dernier recours
                const jobTitleElement = document.getElementById('parsedJobTitle');
                if (jobTitleElement && jobTitleElement.textContent !== 'Non d√©tect√©') {
                    return jobTitleElement.textContent;
                }
                
                return '';
            }
            
            // √âv√©nements pour le chat
            openChatBtn.addEventListener('click', function() {
                // Afficher le chat modal
                chatModalOverlay.style.display = 'flex';
                
                // Pr√©parer les donn√©es du CV pour le chat
                const cvData = {
                    name: document.getElementById('parsedName').textContent,
                    jobTitle: document.getElementById('parsedJobTitle').textContent,
                    email: document.getElementById('parsedEmail').textContent,
                    phone: document.getElementById('parsedPhone').textContent,
                    skills: Array.from(document.querySelectorAll('#parsedSkills .skill-tag')).map(tag => tag.textContent.replace(/^./, '')), // Enlever l'ic√¥ne
                    software: Array.from(document.querySelectorAll('#parsedSoftware .software-item')).map(item => item.textContent.replace(/^./, '')),
                    languages: Array.from(document.querySelectorAll('#parsedLanguages .language-item')).map(item => {
                        return {
                            language: item.querySelector('.language-name').textContent.replace(/^./, ''),
                            level: item.querySelector('.language-level').textContent
                        }
                    }),
                    experience: Array.from(document.querySelectorAll('#parsedExperience .experience-item')).map(item => {
                        return {
                            title: item.querySelector('.experience-title').textContent,
                            company: item.querySelector('.experience-company').textContent.replace(/^./, ''),
                            date: item.querySelector('.experience-date').textContent.replace(/^./, '')
                        }
                    })
                };
                
                // Stocker les donn√©es pour le chat
                documentData = cvData;
                
                // Afficher les donn√©es dans le panneau lat√©ral
                chatDocumentData.textContent = JSON.stringify(cvData, null, 2);
                
                // Initialiser l'historique du chat avec un message syst√®me
                chatHistory = [
                    {
                        role: "system",
                        content: `Tu es un assistant sp√©cialis√© dans l'analyse de CV optimis√© pour Commitment. Tu dois aider le candidat √† comprendre les forces et faiblesses de son CV, et lui donner des conseils pour l'am√©liorer. Voici les donn√©es extraites de son CV: ${JSON.stringify(cvData)}`
                    }
                ];
                
                // Faire d√©filer vers le bas pour voir les messages
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Mettre le focus sur le champ de saisie
                chatInput.focus();
            });
            
            closeChatBtn.addEventListener('click', function() {
                chatModalOverlay.style.display = 'none';
            });
            
            // Fermer le chat en cliquant en dehors
            chatModalOverlay.addEventListener('click', function(e) {
                if (e.target === chatModalOverlay) {
                    chatModalOverlay.style.display = 'none';
                }
            });
            
            // Envoyer un message en appuyant sur Entr√©e
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Envoyer un message en cliquant sur le bouton
            chatSendBtn.addEventListener('click', sendChatMessage);
            
            // G√©rer les suggestions
            suggestionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    chatInput.value = this.textContent;
                    sendChatMessage();
                });
            });
            
            // Fonction pour envoyer un message au chat
            async function sendChatMessage() {
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // Ajouter le message de l'utilisateur √† l'interface
                addChatMessage(message, 'user');
                
                // Vider le champ de saisie
                chatInput.value = '';
                
                // Afficher l'indicateur de frappe
                chatTypingIndicator.style.display = 'block';
                
                // D√©lai simul√© pour une exp√©rience utilisateur plus naturelle
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                try {
                    // V√©rifier si une cl√© API OpenAI est disponible
                    const apiKey = localStorage.getItem('openai_api_key');
                    const useDirectOpenAI = isGitHubPages && apiKey;
                    
                    if (useDirectOpenAI) {
                        // Appeler directement l'API OpenAI pour le chat avec prompt optimis√©
                        try {
                            const prompt = `
                            Tu es un assistant sp√©cialis√© dans l'analyse de CV et les conseils en recherche d'emploi pour la plateforme Commitment.
                            Les donn√©es du CV du candidat sont les suivantes:
                            ${JSON.stringify(documentData, null, 2)}

                            Historique de conversation:
                            ${chatHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

                            Question du candidat: ${message}

                            R√©ponds de mani√®re claire, concise et professionnelle. Donne des conseils personnalis√©s en fonction des informations du CV.
                            Mentionne que l'analyse a √©t√© faite avec le parser optimis√© de Commitment si pertinent.
                            `;

                            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify({
                                    model: 'gpt-3.5-turbo',
                                    messages: [
                                        {
                                            role: 'user',
                                            content: prompt
                                        }
                                    ],
                                    temperature: 0.7,
                                    max_tokens: 800
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Erreur API: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            const aiResponse = data.choices[0].message.content;
                            
                            // Masquer l'indicateur de frappe
                            chatTypingIndicator.style.display = 'none';
                            
                            // Ajouter les messages √† l'historique
                            chatHistory.push({ role: 'user', content: message });
                            chatHistory.push({ role: 'assistant', content: aiResponse });
                            
                            // Ajouter la r√©ponse √† l'interface
                            addChatMessage(aiResponse, 'assistant');
                            
                        } catch (apiError) {
                            console.error('Erreur lors de l\'appel √† l\'API OpenAI:', apiError);
                            
                            // Masquer l'indicateur de frappe
                            chatTypingIndicator.style.display = 'none';
                            
                            // Utiliser une r√©ponse de secours am√©lior√©e
                            const backupResponse = generateEnhancedChatResponse(message, documentData);
                            addChatMessage(backupResponse, 'assistant');
                        }
                    } else {
                        // Mode local optimis√© ou GitHub Pages sans cl√© API
                        // Masquer l'indicateur de frappe
                        chatTypingIndicator.style.display = 'none';
                        
                        // G√©n√©rer une r√©ponse optimis√©e
                        const optimizedResponse = generateEnhancedChatResponse(message, documentData);
                        addChatMessage(optimizedResponse, 'assistant');
                    }
                } catch (error) {
                    console.error('Erreur g√©n√©rale du chat:', error);
                    
                    // Masquer l'indicateur de frappe
                    chatTypingIndicator.style.display = 'none';
                    
                    // Message d'erreur am√©lior√©
                    addChatMessage("D√©sol√©, je rencontre des difficult√©s techniques avec le syst√®me optimis√©. Comment puis-je vous aider autrement ?", 'assistant');
                }
            }
            
            // Fonction pour ajouter un message au chat
            function addChatMessage(content, role) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(role);
                messageElement.textContent = content;
                
                chatMessages.appendChild(messageElement);
                
                // Faire d√©filer vers le bas
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Ajouter le message √† l'historique
                if (!chatHistory.some(msg => msg.role === role && msg.content === content)) {
                    chatHistory.push({
                        role: role,
                        content: content
                    });
                }
            }
            
            // Fonction pour afficher un message de succ√®s
            function showSuccessMessage(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                
                // Masquer le message apr√®s 4 secondes
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 4000);
            }
            
            // Fonction pour afficher un message d'erreur
            function showErrorMessage(message) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
                
                // Masquer le message apr√®s 5 secondes
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
            
            // Fonction pour g√©n√©rer une r√©ponse de chat optimis√©e bas√©e sur les donn√©es du CV
            function generateEnhancedChatResponse(message, cvData) {
                const lowerMessage = message.toLowerCase();
                
                // R√©ponses am√©lior√©es avec mention du parser optimis√©
                if (lowerMessage.includes('am√©liorer') || lowerMessage.includes('am√©lioration')) {
                    return `Gr√¢ce √† notre parser optimis√© Commitment, j'ai analys√© votre CV en d√©tail. Voici des conseils personnalis√©s pour l'am√©liorer :\n\n1. D√©veloppez davantage votre expertise en tant que ${cvData.jobTitle}\n2. Quantifiez vos r√©alisations avec des chiffres concrets\n3. Enrichissez vos comp√©tences ${cvData.skills.slice(0,2).join(' et ')} avec des projets sp√©cifiques\n4. Ajoutez des certifications dans votre domaine\n\nNotre syst√®me a d√©tect√© ${cvData.skills.length} comp√©tences et ${cvData.experience.length} exp√©riences - c'est un bon d√©but !`;
                } 
                else if (lowerMessage.includes('force') || lowerMessage.includes('point fort')) {
                    return `Notre analyse optimis√©e r√©v√®le vos principales forces :\n\n1. ‚ú® Expertise solide en ${cvData.skills.slice(0, 3).join(', ')}\n2. üè¢ Exp√©rience significative : ${cvData.experience[0]?.title || cvData.jobTitle}\n3. üíª Ma√Ætrise technique des outils ${cvData.software.slice(0, 2).join(' et ')}\n4. üåç Comp√©tences linguistiques : ${cvData.languages.map(l => l.language).join(', ')}\n\nLe parser Commitment a identifi√© un profil complet avec ${cvData.skills.length} comp√©tences techniques d√©tect√©es !`;
                }
                else if (lowerMessage.includes('comp√©tence') || lowerMessage.includes('d√©velopper')) {
                    return `Pour enrichir votre profil de ${cvData.jobTitle}, notre syst√®me recommande ces axes de d√©veloppement :\n\n1. üöÄ Intelligence artificielle et automatisation\n2. ‚òÅÔ∏è Technologies cloud et DevOps\n3. üìä Analyse de donn√©es et Business Intelligence\n4. üîí Cybers√©curit√© et conformit√©\n\nCes comp√©tences compl√©teraient parfaitement votre base actuelle de ${cvData.skills.join(', ')}. Le march√© valorise particuli√®rement ces profils hybrides !`;
                }
                else if (lowerMessage.includes('emploi') || lowerMessage.includes('poste') || lowerMessage.includes('travail')) {
                    return `Avec votre profil de ${cvData.jobTitle} analys√© par notre parser optimis√©, vous √™tes parfaitement positionn√©(e) pour :\n\n1. üéØ Senior ${cvData.jobTitle}\n2. üëë Lead Developer ou Tech Lead\n3. üèóÔ∏è Architecte technique\n4. üíº Product Owner technique\n5. üöÄ Roles dans des scale-ups innovantes\n\nVotre combinaison ${cvData.skills.slice(0,2).join(' + ')} est tr√®s recherch√©e. Le syst√®me Commitment vous matchera avec des opportunit√©s premium !`;
                }
                else if (lowerMessage.includes('logiciel') || lowerMessage.includes('software') || lowerMessage.includes('outil')) {
                    return `Notre parser a d√©tect√© votre ma√Ætrise de ${cvData.software.join(', ')}. Pour booster votre profil Commitment :\n\n1. üõ†Ô∏è Outils DevOps : Docker, Kubernetes, Jenkins\n2. ‚òÅÔ∏è Plateformes cloud : AWS, Azure, GCP\n3. üìä Analytics : Tableau, Power BI, Google Analytics\n4. üé® Design : Figma, Adobe Creative Suite\n5. üìã Gestion : Jira, Notion, Monday.com\n\nCes outils sont dans le top des demandes selon notre base de donn√©es Commitment !`;
                }
                else if (lowerMessage.includes('langue') || lowerMessage.includes('anglais')) {
                    return `Selon l'analyse optimis√©e, vous ma√Ætrisez ${cvData.languages.map(l => `${l.language} (${l.level})`).join(', ')}.\n\nPour maximiser vos opportunit√©s sur Commitment :\n\n1. üåç Anglais technique niveau B2+ est un must\n2. üìö Participez √† des projets open-source internationaux\n3. üéØ Suivez des formations tech en anglais\n4. üí¨ Rejoignez des communaut√©s dev anglophones\n\nUn niveau d'anglais solide peut augmenter vos opportunit√©s de 40% selon nos statistiques !`;
                }
                else {
                    return `Merci pour votre question ! Notre parser optimis√© Commitment a analys√© votre profil de ${cvData.name}, ${cvData.jobTitle} avec ${cvData.skills.length} comp√©tences identifi√©es.\n\nüéØ Votre profil est solide avec :\n‚Ä¢ ${cvData.skills.slice(0,3).join(', ')}\n‚Ä¢ ${cvData.experience.length} exp√©riences professionnelles\n‚Ä¢ Ma√Ætrise de ${cvData.software.length} outils\n\nPour des conseils plus pr√©cis, demandez-moi comment am√©liorer votre CV, identifier vos forces, d√©velopper de nouvelles comp√©tences, ou explorer de nouveaux m√©tiers. Je suis l√† pour optimiser votre parcours !`;
                }
            }
            
            // Fonction pour traiter le fichier CV
            async function handleFile(file) {
                // Liste √©tendue des types de fichiers accept√©s
                const allowedTypes = [
                    'application/pdf',                                                // PDF
                    'application/msword',                                             // DOC
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  // DOCX
                    'image/jpeg',                                                     // JPG, JPEG
                    'image/png'                                                       // PNG
                ];
                
                // V√©rification bas√©e sur l'extension si le type MIME n'est pas reconnu
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'];
                
                let isAllowedType = allowedTypes.includes(file.type) || allowedExtensions.includes(fileExtension);
                
                if (!isAllowedType) {
                    showErrorMessage('Type de fichier non pris en charge. Veuillez charger un fichier PDF, DOC, DOCX, JPG ou PNG.');
                    return;
                }
                
                // V√©rification de la taille du fichier (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showErrorMessage('La taille du fichier d√©passe la limite de 10MB.');
                    return;
                }
                
                // Affichage des informations sur le fichier
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'flex';
                
                try {
                    // Utiliser le service de parsing CV via l'int√©gration optimis√©e
                    await window.cvParser.parseCV(file);
                } catch (error) {
                    console.error('Erreur lors du parsing optimis√©:', error);
                    showErrorMessage('Erreur lors de l\'analyse: ' + error.message);
                }
            }
            
            // Fonction pour remplir le tableau de donn√©es avec les am√©liorations
            function populateDataTable(data) {
                console.log("Donn√©es extraites par le parser optimis√©:", data);
                
                // Extraire les donn√©es pertinentes
                let personalInfo = data.personal_info || {};
                let skills = data.skills || [];
                let software = data.software || [];
                let languages = data.languages || [];
                let experience = data.work_experience || [];
                let currentPosition = data.current_position || '';
                
                // Traiter le nom
                const nameElement = document.getElementById('parsedName');
                if (personalInfo.name && personalInfo.name !== '√Ä compl√©ter') {
                    nameElement.textContent = personalInfo.name;
                    nameElement.className = 'detected';
                } else {
                    nameElement.textContent = 'Non d√©tect√©';
                    nameElement.className = 'not-detected';
                }
                
                // Traiter le titre de poste
                const jobTitleElement = document.getElementById('parsedJobTitle');
                let jobTitle = currentPosition;
                if (!jobTitle && experience && experience.length > 0 && experience[0].title) {
                    jobTitle = experience[0].title;
                }
                
                if (jobTitle && jobTitle !== '√Ä compl√©ter' && jobTitle !== 'Poste √† compl√©ter') {
                    jobTitleElement.textContent = jobTitle;
                    jobTitleElement.className = 'detected';
                } else {
                    jobTitleElement.textContent = 'Non d√©tect√©';
                    jobTitleElement.className = 'not-detected';
                }
                
                // Traiter l'email
                const emailElement = document.getElementById('parsedEmail');
                if (personalInfo.email && personalInfo.email !== '√Ä compl√©ter') {
                    emailElement.textContent = personalInfo.email;
                    emailElement.className = 'detected';
                } else {
                    emailElement.textContent = 'Non d√©tect√©';
                    emailElement.className = 'not-detected';
                }
                
                // Traiter le t√©l√©phone (am√©lioration majeure avec le parser optimis√©)
                const phoneElement = document.getElementById('parsedPhone');
                if (personalInfo.phone && personalInfo.phone !== '√Ä compl√©ter') {
                    phoneElement.textContent = personalInfo.phone;
                    phoneElement.className = 'detected';
                } else {
                    phoneElement.textContent = 'Non d√©tect√©';
                    phoneElement.className = 'not-detected';
                }
                
                // Traiter les comp√©tences avec des tags (am√©liorations visibles)
                let skillsContainer = document.getElementById('parsedSkills');
                skillsContainer.innerHTML = '';
                let skillsTagsDiv = document.createElement('div');
                skillsTagsDiv.className = 'skills-tags';
                
                if (Array.isArray(skills) && skills.length > 0 && !skills.includes('Comp√©tences √† sp√©cifier')) {
                    skills.forEach(skill => {
                        if (skill && typeof skill === 'string' && skill !== '√Ä sp√©cifier') {
                            let skillTag = document.createElement('span');
                            skillTag.className = 'skill-tag';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-check-circle';
                            skillTag.appendChild(icon);
                            
                            skillTag.appendChild(document.createTextNode(skill));
                            skillsTagsDiv.appendChild(skillTag);
                        }
                    });
                } else if (typeof skills === 'string' && skills !== 'Comp√©tences √† sp√©cifier') {
                    skills.split(',').forEach(skill => {
                        let trimmedSkill = skill.trim();
                        if (trimmedSkill && trimmedSkill !== '√Ä sp√©cifier') {
                            let skillTag = document.createElement('span');
                            skillTag.className = 'skill-tag';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-check-circle';
                            skillTag.appendChild(icon);
                            
                            skillTag.appendChild(document.createTextNode(trimmedSkill));
                            skillsTagsDiv.appendChild(skillTag);
                        }
                    });
                }
                
                if (skillsTagsDiv.children.length === 0) {
                    let skillTag = document.createElement('span');
                    skillTag.className = 'skill-tag not-detected';
                    skillTag.textContent = 'Non d√©tect√©';
                    skillsTagsDiv.appendChild(skillTag);
                }
                skillsContainer.appendChild(skillsTagsDiv);
                
                // Traiter les logiciels avec des items (am√©liorations substantielles)
                let softwareContainer = document.getElementById('parsedSoftware');
                softwareContainer.innerHTML = '';
                let softwareListDiv = document.createElement('div');
                softwareListDiv.className = 'software-list';
                
                if (Array.isArray(software) && software.length > 0 && !software.includes('Logiciels √† sp√©cifier')) {
                    software.forEach(item => {
                        if (item && typeof item === 'string' && item !== '√Ä sp√©cifier') {
                            let softwareItem = document.createElement('span');
                            softwareItem.className = 'software-item';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-laptop-code';
                            softwareItem.appendChild(icon);
                            
                            softwareItem.appendChild(document.createTextNode(item));
                            softwareListDiv.appendChild(softwareItem);
                        }
                    });
                } else if (typeof software === 'string' && software !== 'Logiciels √† sp√©cifier') {
                    software.split(',').forEach(item => {
                        let trimmedItem = item.trim();
                        if (trimmedItem && trimmedItem !== '√Ä sp√©cifier') {
                            let softwareItem = document.createElement('span');
                            softwareItem.className = 'software-item';
                            
                            let icon = document.createElement('i');
                            icon.className = 'fas fa-laptop-code';
                            softwareItem.appendChild(icon);
                            
                            softwareItem.appendChild(document.createTextNode(trimmedItem));
                            softwareListDiv.appendChild(softwareItem);
                        }
                    });
                }
                
                if (softwareListDiv.children.length === 0) {
                    let softwareItem = document.createElement('span');
                    softwareItem.className = 'software-item not-detected';
                    softwareItem.textContent = 'Non d√©tect√©';
                    softwareListDiv.appendChild(softwareItem);
                }
                softwareContainer.appendChild(softwareListDiv);
                
                // Traiter les langues (am√©liorations niveaux pr√©cis)
                let languagesContainer = document.getElementById('parsedLanguages');
                languagesContainer.innerHTML = '';
                let languageListDiv = document.createElement('div');
                languageListDiv.className = 'language-list';
                
                if (Array.isArray(languages) && languages.length > 0) {
                    languages.forEach(lang => {
                        let languageItem = document.createElement('div');
                        languageItem.className = 'language-item';
                        
                        let languageName = document.createElement('span');
                        languageName.className = 'language-name';
                        
                        let icon = document.createElement('i');
                        icon.className = 'fas fa-language';
                        languageName.appendChild(icon);
                        
                        if (typeof lang === 'string') {
                            languageName.appendChild(document.createTextNode(lang));
                        } else if (lang.language) {
                            languageName.appendChild(document.createTextNode(lang.language));
                            
                            if (lang.level && lang.level !== '√Ä √©valuer') {
                                let languageLevel = document.createElement('span');
                                languageLevel.className = 'language-level';
                                languageLevel.textContent = lang.level;
                                languageItem.appendChild(languageLevel);
                            }
                        }
                        
                        languageItem.appendChild(languageName);
                        languageListDiv.appendChild(languageItem);
                    });
                }
                
                if (languageListDiv.children.length === 0) {
                    let languageItem = document.createElement('div');
                    languageItem.className = 'language-item';
                    
                    let languageName = document.createElement('span');
                    languageName.className = 'language-name not-detected';
                    languageName.textContent = 'Non d√©tect√©';
                    
                    languageItem.appendChild(languageName);
                    languageListDiv.appendChild(languageItem);
                }
                languagesContainer.appendChild(languageListDiv);
                
                // Traiter l'exp√©rience professionnelle (am√©liorations dates pr√©cises)
                let experienceContainer = document.getElementById('parsedExperience');
                experienceContainer.innerHTML = '';
                let experienceListDiv = document.createElement('div');
                experienceListDiv.className = 'experience-list';
                
                if (experience && Array.isArray(experience) && experience.length > 0) {
                    experience.forEach(exp => {
                        if ((exp.title && exp.title !== '√Ä compl√©ter') || (exp.company && exp.company !== '√Ä sp√©cifier')) {
                            let experienceItem = document.createElement('div');
                            experienceItem.className = 'experience-item';
                            
                            if (exp.title && exp.title !== '√Ä compl√©ter') {
                                let experienceTitle = document.createElement('div');
                                experienceTitle.className = 'experience-title';
                                experienceTitle.textContent = exp.title;
                                experienceItem.appendChild(experienceTitle);
                            }
                            
                            if (exp.company && exp.company !== '√Ä sp√©cifier') {
                                let experienceCompany = document.createElement('div');
                                experienceCompany.className = 'experience-company';
                                
                                let icon = document.createElement('i');
                                icon.className = 'fas fa-building';
                                experienceCompany.appendChild(icon);
                                
                                experienceCompany.appendChild(document.createTextNode(exp.company));
                                experienceItem.appendChild(experienceCompany);
                            }
                            
                            // Gestion des dates am√©lior√©e
                            let dateText = '';
                            if (exp.start_date && exp.start_date !== '√Ä d√©finir') {
                                dateText += formatDate(exp.start_date);
                            }
                            if (exp.end_date && exp.end_date !== '√Ä d√©finir') {
                                dateText += ' - ' + (exp.end_date.toLowerCase() === 'present' ? 'Pr√©sent' : formatDate(exp.end_date));
                            }
                            
                            if (dateText) {
                                let experienceDate = document.createElement('div');
                                experienceDate.className = 'experience-date';
                                
                                let icon = document.createElement('i');
                                icon.className = 'fas fa-calendar-alt';
                                experienceDate.appendChild(icon);
                                
                                experienceDate.appendChild(document.createTextNode(dateText));
                                experienceItem.appendChild(experienceDate);
                            }
                            
                            experienceListDiv.appendChild(experienceItem);
                        }
                    });
                }
                
                if (experienceListDiv.children.length === 0) {
                    let experienceItem = document.createElement('div');
                    experienceItem.className = 'experience-item';
                    
                    let experienceTitle = document.createElement('div');
                    experienceTitle.className = 'experience-title not-detected';
                    experienceTitle.textContent = 'Non d√©tect√©';
                    
                    experienceItem.appendChild(experienceTitle);
                    experienceListDiv.appendChild(experienceItem);
                }
                experienceContainer.appendChild(experienceListDiv);
                
                // Stocker les donn√©es pour le chat
                documentData = {
                    name: document.getElementById('parsedName').textContent,
                    jobTitle: document.getElementById('parsedJobTitle').textContent,
                    email: document.getElementById('parsedEmail').textContent,
                    phone: document.getElementById('parsedPhone').textContent,
                    skills: Array.from(document.querySelectorAll('#parsedSkills .skill-tag')).map(tag => tag.textContent.replace(/^./, '')), // Enlever l'ic√¥ne
                    software: Array.from(document.querySelectorAll('#parsedSoftware .software-item')).map(item => item.textContent.replace(/^./, '')),
                    languages: Array.from(document.querySelectorAll('#parsedLanguages .language-item')).map(item => {
                        return {
                            language: item.querySelector('.language-name')?.textContent.replace(/^./, '') || '',
                            level: item.querySelector('.language-level')?.textContent || ''
                        }
                    }),
                    experience: Array.from(document.querySelectorAll('#parsedExperience .experience-item')).map(item => {
                        return {
                            title: item.querySelector('.experience-title')?.textContent || '',
                            company: item.querySelector('.experience-company')?.textContent.replace(/^./, '') || '',
                            date: item.querySelector('.experience-date')?.textContent.replace(/^./, '') || ''
                        }
                    })
                };
            }
            
            // Fonction pour formater les dates (am√©lior√©e)
            function formatDate(dateStr) {
                if (!dateStr) return '';
                
                // Si le format est "MM/YYYY"
                if (/^\d{2}\/\d{4}$/.test(dateStr)) {
                    const parts = dateStr.split('/');
                    const month = parts[0];
                    const year = parts[1];
                    const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
                    return `${months[parseInt(month) - 1]} ${year}`;
                }
                
                // Si le format est "YYYY-MM" ou "YYYY-MM-DD"
                if (/^\d{4}-\d{2}(-\d{2})?$/.test(dateStr)) {
                    const parts = dateStr.split('-');
                    const year = parts[0];
                    const month = parts[1];
                    const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
                    return `${months[parseInt(month) - 1]} ${year}`;
                }
                return dateStr;
            }
            
            function resetFileUpload() {
                fileInput.value = '';
                fileInfo.style.display = 'none';
                loadingIndicator.style.display = 'none';
                parsedData.style.display = 'none';
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
                stepperProgress.style.width = '0%';
                documentData = null;
                completeParserData = null;
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>